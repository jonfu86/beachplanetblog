montageDefine("3d2b056","controllers/camera-controller",{dependencies:["runtime/dependencies/gl-matrix","runtime/utilities","runtime/transform","montage"],factory:function(t,e){t("runtime/dependencies/gl-matrix"),t("runtime/utilities").Utilities;var n=t("runtime/transform").Transform,i=t("montage").Montage;e.CameraController=i.specialize({constructor:{value:function(){this.super(),this._lastPosition=[0,0]}},_deltaForEvent:{value:function(t){return null!=t.wheelDeltaY?t.wheelDeltaY:-t.deltaY}},_minimalDistance:{value:0,writable:!0},_computeInitialDistance:{value:function(){if(this.sceneBBox){var t=this.sceneBBox,e=vec3.createFrom((t[1][0]-t[0][0])/2,(t[1][1]-t[0][1])/2,(t[1][2]-t[0][2])/2),n=vec3.length(e),i=[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2,(t[0][2]+t[1][2])/2],a=vec3.create(this.viewPoint.glTFElement.transform.translation),s=vec3.create();s[0]=i[0]-a[0],s[1]=i[1]-a[1],s[2]=i[2]-a[2];var r=vec3.length(s);this._minimalDistance=n>r?r:n,this.zoomStep=1e-4*n}}},viewPointDidChange:{value:function(){this._computeInitialDistance()}},_viewPoint:{value:null,writable:!0},viewPoint:{get:function(){return this._viewPoint},set:function(t){this._viewPoint!=t&&(this._viewPoint=t,this.viewPointDidChange())}},_node:{value:null,writable:!0},zoomStep:{value:0,writable:!0},sceneBBox:{value:null,writable:!0},nodeDidChange:{value:function(){var t=this.node.glTFElement;this.sceneBBox=t.getBoundingBox(!0),this._computeInitialDistance()}},node:{get:function(){return this._node},set:function(t){this._node!=t&&(this._node=t,this.nodeDidChange())}},_lastPosition:{value:null,writable:!0},_transform:{value:null,writable:!0},_axisUp:{value:null,writable:!0},zoom:{value:function(t){if(!this.moving){var e,n=vec3.create(),i=vec3.create(this.viewPoint.glTFElement.transform.translation);this.node.glTFElement;var a=this.sceneBBox;e=[(a[0][0]+a[1][0])/2,(a[0][1]+a[1][1])/2,(a[0][2]+a[1][2])/2],n[0]=e[0]-i[0],n[1]=e[1]-i[1],n[2]=e[2]-i[2],vec3.normalize(n);var s=this._deltaForEvent(t),r=this.zoomStep*s;i[0]+=r*n[0],i[1]+=r*n[1],i[2]+=r*n[2];var o=vec3.create();o[0]=e[0]-i[0],o[1]=e[1]-i[1],o[2]=e[2]-i[2];var l=vec3.length(o);if(l>this._minimalDistance)this.viewPoint.glTFElement.transform.translation=i;else{var c=s>0?-this._minimalDistance:this._minimalDistance;i[0]=e[0]+n[0]*c,i[1]=e[1]+n[1]*c,i[2]=e[2]+n[2]*c,this.viewPoint.glTFElement.transform.translation=i}}}},translate:{value:function(t){if(this._transform.matrix=this.viewPoint.glTFElement.worldMatrix,0!=this.moving){var e=t.translateX-this._lastPosition[0],n=t.translateY-this._lastPosition[1];this._lastPosition[0]=t.translateX,this._lastPosition[1]=t.translateY,e*=.05,n*=-.05,this._axisUp=vec3.createFrom(0,1,0),mat4.rotateVec3(this._transform.matrix,this._axisUp);var i,a=!1;if(0==a){this.node.glTFElement;var s=this.sceneBBox;i=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2,(s[0][2]+s[1][2])/2]}var r=vec3.create(),o=vec3.create(this._transform.translation);r[0]=i[0]-o[0],r[1]=i[1]-o[1],r[2]=i[2]-o[2];var l=vec3.create(this._axisUp),c=vec3.create();vec3.normalize(r),vec3.cross(r,this._axisUp,c),vec3.normalize(c),vec3.cross(r,c,l),vec3.normalize(l);var h=mat4.identity(),p=0;p=Math.abs(n)>Math.abs(e)?Math.abs(n)/Math.abs(e):Math.abs(e)/Math.abs(n),p>.5?(mat4.rotate(h,e,l),mat4.rotate(h,n,c)):Math.abs(n)>Math.abs(e)?mat4.rotate(h,n,c):mat4.rotate(h,e,l),o[0]-=i[0],o[1]-=i[1],o[2]-=i[2],mat4.rotateVec3(h,o),o[0]+=i[0],o[1]+=i[1],o[2]+=i[2];var u=mat4.identity();mat4.multiply3(h,this._transform.matrix,u);var d=mat4.identity();mat4.translate(d,o);var g=mat4.identity();mat4.multiply(d,u,g),this.viewPoint.glTFElement.transform.matrix=g}}},beginTranslate:{value:function(){this.moving=!0,null==this._transform&&(this._transform=Object.create(n).init()),this._transform.matrix=this.viewPoint.glTFElement.worldMatrix}},endTranslate:{value:function(){this.moving=!1,this._axisUp=null}}})}});