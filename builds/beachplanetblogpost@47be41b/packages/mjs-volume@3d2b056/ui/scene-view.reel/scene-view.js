require("runtime/dependencies/gl-matrix");var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,GLSLProgram=require("runtime/glsl-program").GLSLProgram,ResourceManager=require("runtime/helpers/resource-manager").ResourceManager,glTFScene=require("runtime/glTF-scene").glTFScene,glTFNode=require("runtime/glTF-node").glTFNode,Scene=require("runtime/scene").Scene,Node=require("runtime/node").Node,SceneRenderer=require("runtime/scene-renderer").SceneRenderer,glTFMaterial=require("runtime/glTF-material").glTFMaterial,Utilities=require("runtime/utilities").Utilities,dom=require("montage/core/dom"),Point=require("montage/core/geometry/point").Point,TranslateComposer=require("montage/composer/translate-composer").TranslateComposer,BuiltInAssets=require("runtime/builtin-assets").BuiltInAssets,WebGLRenderer=require("runtime/webgl-renderer").WebGLRenderer,Projection=require("runtime/projection").Projection,BasicAnimation=require("runtime/animation").BasicAnimation,Camera=require("runtime/camera").Camera,BBox=require("runtime/utilities").BBox,SceneHelper=require("runtime/scene-helper").SceneHelper,CameraController=require("controllers/camera-controller").CameraController,Transform=require("runtime/transform").Transform,Component3D=require("runtime/component-3d").Component3D,ActionDispatcher=require("runtime/action-dispatcher").ActionDispatcher,Application=require("montage/core/application").Application;require("runtime/dependencies/webgl-debug"),exports.SceneView=Component.specialize({automaticallyCyclesThroughViewPoints:{value:!0,writable:!0},allowsProgressiveSceneLoading:{value:!1,writable:!0},allowsViewPointControl:{value:!0,writable:!0},scene:{get:function(){return this._scene},set:function(t){if(t){if(t.isLoaded()===!1)return t.addOwnPropertyChangeListener("status",this),void 0;this.needsDraw=!0}this.scene!=t&&(this.sceneWillChange(t),this._scene=t,this.sceneDidChange())}},viewPoint:{get:function(){return this._viewPoint},set:function(t){var e=this._viewPoint?this._viewPoint.id:null,n=t?t.id:null;if(e!=n){var i=null;this._viewPoint&&t&&this._viewPoint.scene==t.scene&&(i=this._viewPoint),this.viewPointWillChange(i,t),this._viewPoint=t;var r=this.getAnimationManager();r&&(r.sceneTime=0),t&&this.scene&&null==this._viewPoint.scene&&(this._viewPoint.scene=this.scene),this.viewPointDidChange()}}},play:{value:function(){switch(this._state){case this.PAUSE:case this.STOP:this._lastTime=Date.now(),this._state=this.PLAY,this.needsDraw=!0;break;default:}this._state=this.PLAY}},pause:{value:function(){this._state=this.PAUSE}},stop:{value:function(){var t=this.getAnimationManager();t&&(t.sceneTime=0),this._state=this.STOP,this.needsDraw=!0}},loops:{value:!0,writable:!0},STOP:{value:0,writable:!0},PLAY:{value:1,writable:!0},PAUSE:{value:2,writable:!0},_internalViewPoint:{value:null,writable:!0},_firstFrameDidRender:{value:!1,writable:!0},_sceneResourcesLoaded:{value:!1,writable:!0},_scene:{value:null,writable:!0},_consideringPointerForPicking:{writable:!0,value:!1},_mousePosition:{writable:!0,value:null},_showGradient:{value:!1,writable:!0},_showReflection:{value:!1,writable:!0},_showBBOX:{value:!1,writable:!0},_width:{value:null,writable:!0},_height:{value:null,writable:!0},_lastTime:{value:0,writable:!0},_state:{value:0,writable:!0},_viewPoint:{value:null,writable:!0},_sceneRenderer:{value:null,writable:!0},_disableRendering:{value:!1,writable:!0},_contextAttributes:{value:null,writable:!0},_shouldForceClear:{value:!1,writable:!0},_viewPointIndex:{value:0,writable:!0},_cameraController:{value:null,writable:!0},_defaultViewPoint:{value:null,writable:!0},translateComposer:{value:null,writable:!0},scaleFactor:{get:function(){return this._isiPad()?1:window.devicePixelRatio||1}},selectedNode:{value:null,writable:!0},cameraController:{get:function(){return null==this._cameraController&&(this._cameraController=Montage.create(CameraController)),this._cameraController}},sceneTimeWillChange:{value:function(){}},sceneTimeDidChange:{value:function(){if(null!=this.scene&&null!=this.scene.glTFElement){var t=this.scene.glTFElement.endTime;if(-1!==t&&null!=this.sceneView){var e=this.scene.glTFElement.animationManager;if(e.sceneTime/1e3>t&&1==this.automaticallyCyclesThroughViewPoints){var n=this.sceneView._viewPointIndex,i=SceneHelper.getViewPoints(this.scene);if(i.length>0){var r,a=0;do e.sceneTime=0,a++,n=++n%i.length,r=i[n];while(i.length>a&&0==e.nodeHasAnimatedAncestor(r.glTFElement));this.sceneView.viewPoint=r}}}}}},sceneWillChange:{value:function(){this.getResourceManager()&&this.getResourceManager().reset(),this._firstFrameDidRender=!1,this.delegate&&this.delegate.sceneWillChange&&this.delegate.sceneWillChange(),this._scene&&(this._scene.removeEventListener("cursorUpdate",this),this._scene.removeEventListener("materialUpdate",this),this._scene.removeEventListener("textureUpdate",this),Application.removeEventListener("sceneNodeSelected",this))}},sceneDidChange:{value:function(){this._scene&&(this._sceneResourcesLoaded=!1,this._scene.addEventListener("cursorUpdate",this),this._scene.addEventListener("textureUpdate",this),this._scene.addEventListener("materialUpdate",this),Application.addEventListener("sceneNodeSelected",this),this.applyScene(),this.delegate&&this.delegate.sceneDidChange&&this.delegate.sceneDidChange())}},resourceAvailable:{value:function(){if(0==this.allowsProgressiveSceneLoading){var t=this.getResourceManager();t&&0==t.hasPendingRequests()&&(this.needsDraw=!0)}}},handleTextureUpdate:{value:function(t){var e=this.getResourceManager();if(e&&this.sceneRenderer&&this.sceneRenderer.webGLRenderer){var n=this.sceneRenderer.webGLRenderer.webGLContext,i=e.getResource(t.detail.value,this.sceneRenderer.webGLRenderer.textureDelegate,n);i&&this.resourceAvailable()}}},handleMaterialUpdate:{value:function(){this.needsDraw=!0}},handleCursorUpdate:{value:function(t){null!=this.element&&(this.element.style.cursor=t.detail)}},constructor:{value:function(){this.super()}},animationDidStart:{value:function(){this.needsDraw=!0,this.element.style.cursor="default"}},animationDidStop:{value:function(){}},animationDidUpdate:{value:function(t){var e=this._viewPointAnimationStep,n=t.extras.previousViewPoint;null==this.__matrix&&(this.__matrix=mat4.create()),null==this.__transform&&(this.__transform=Object.create(Transform).init());var i=n.glTFElement.transform,r=this.viewPoint.glTFElement.transform;i.interpolateToTransform(r,e,this.__transform),mat4.multiply(this.viewPoint.glTFElement.parent.worldMatrix,this.__transform.matrix,this.__matrix),this._internalViewPoint.transform.matrix=this.__matrix}},viewPointWillChange:{value:function(t,e){if(this.sceneRenderer&&e&&this.scene.glTFElement){var n=this.getAnimationManager(),i=0==n.nodeHasAnimatedAncestor(e.glTFElement);if(0==i&&null!=t&&(i|=0==n.nodeHasAnimatedAncestor(t.glTFElement)),i&&null!=t){var r=Object.create(BasicAnimation).init();r.path="_viewPointAnimationStep",r.target=this,r.delegate=this,r.from=Number(0),r.to=Number(1),r.duration=1e3,r.timingFunction="ease-out",r.extras.previousViewPoint=t,n.playAnimation(r),r.animationWasAddedToTarget()}}}},viewPointDidChange:{value:function(){this.cameraController.viewPoint=this.viewPoint,this.sceneRenderer&&this._viewPoint&&this.scene&&this.scene.glTFElement&&(this.sceneRenderer.technique.rootPass.viewPoint=this._internalViewPoint,this._viewPointIndex=this._getViewPointIndex(this.viewPoint),this.needsDraw=!0)}},viewPoint:{get:function(){return this._viewPoint},set:function(t){var e=this._viewPoint?this._viewPoint.id:null,n=t?t.id:null;if(e!=n){var i=null;this._viewPoint&&t&&this._viewPoint.scene==t.scene&&(i=this._viewPoint),this.viewPointWillChange(i,t),this._viewPoint=t;var r=this.getAnimationManager();r&&(r.sceneTime=0),t&&this.scene&&null==this._viewPoint.scene&&(this._viewPoint.scene=this.scene),this.viewPointDidChange()}}},canvas:{get:function(){return this.templateObjects?this.templateObjects.canvas:null}},sceneRenderer:{get:function(){return this._sceneRenderer},set:function(t){t!=this._sceneRenderer&&(this._sceneRenderer=t)}},handleStatusChange:{value:function(t,e,n){"loaded"===t&&(this.scene=n,this.needsDraw=!0,this.scene.glTFElement&&this.scene.glTFElement.animationManager&&this.scene.glTFElement.animationManager&&(this.scene.glTFElement.animationManager.delegate=this))}},_getViewPointIndex:{value:function(t){for(var e=SceneHelper.getGLTFViewPoints(t.scene),n=0;e.length>n;n++)if(e[n].baseId===t.id)return n;return 0}},applyScene:{value:function(){var t=this.scene,e=t.glTFElement,n=this;if(this.sceneRenderer&&this.sceneRenderer.technique.rootPass){if(e){var i=SceneHelper.getViewPoints(t),r=i.length>0;if(r){var a=!1;this.viewPoint&&this.viewPoint.scene&&(a=this.viewPoint.scene===this.scene),a===!1&&(this.viewPoint=i[0])}else{var s=e.rootNode.getBoundingBox(!0);Object.create(BBox).init(s[0],s[1]),e.rootNode.transform._updateDirtyFlag(!1);var o=this.scene.glTFElement,s=o.rootNode.getBoundingBox(!0),l=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2,(s[0][2]+s[1][2])/2];l[2];var c=[l[0],l[1],l[2]];c[2]+=s[1][0]-s[0][0]+(s[1][2]-s[0][2]),this._defaultViewPoint=SceneHelper.createNodeIncludingCamera("camera01",t);var h=SceneHelper.getGLTFCamera(this._defaultViewPoint);h.projection.zfar=c[2]+s[1][2]-s[0][2],this._defaultViewPoint.glTFElement.transform.translation=c,this.viewPoint=this._defaultViewPoint}this.sceneRenderer.scene=e}if(this.viewPoint&&(null==this.viewPoint.scene&&(this.viewPoint.scene=t),this.sceneRenderer&&this.viewPointDidChange()),this.allowsProgressiveSceneLoading===!1){var u=this.scene.prepareToRender(this.sceneRenderer.webGLRenderer);u.then(function(){n._sceneResourcesLoaded=!0,n.needsDraw=!0},function(){},function(){})}else this.needsDraw=!0}}},getRelativePositionToCanvas:{value:function(t){return dom.convertPointFromPageToNode(this.canvas,Point.create().init(t.pageX,t.pageY))}},_isiPad:{value:function(){return!!navigator.userAgent.match(/iPad/i)}},enterDocument:{value:function(){window.addEventListener("resize",this,!0);var t=this;setTimeout(function(){t.captureResize()},500),this.scene&&(this.scene.dispatchEventNamed("enteredDocument",!0,!1,this),this.scene.loadCSSStyles()),this.element.addEventListener("wheel",function(e){1==t.allowsViewPointControl&&null!=t.scene&&t.scene.rootNode&&(t.cameraController.node=t.scene.rootNode,t.cameraController.zoom(e)),e.stopPropagation(),e.preventDefault()},!1),this.element.addEventListener("gesturestart",function(t){t.preventDefault()},!1),this.element.addEventListener("gesturechange",function(t){t.preventDefault()},!1);var e=this.translateComposer;e.addEventListener("translate",function(e){1==t.allowsViewPointControl&&null!=t.scene&&t.scene.rootNode&&(t.cameraController.node=t.scene.rootNode,t.cameraController.translate(e)),t.needsDraw=!0}),e.addEventListener("translateStart",function(e){1==t.allowsViewPointControl&&null!=t.scene&&t.scene.rootNode&&(t.cameraController.node=t.scene.rootNode,t.cameraController.beginTranslate(e))},!1),e.addEventListener("translateEnd",function(e){1==t.allowsViewPointControl&&null!=t.scene&&t.scene.rootNode&&(t.cameraController.node=t.scene.rootNode,t.cameraController.endTranslate(e))},!1),this.addComposerForElement(e,this.canvas);var n;n=window.onwheel!==void 0?"wheel":"mousewheel",this.canvas.removeEventListener(n,e,!0),this.canvas.removeEventListener(n,e,!1);var i=!1;i&&(this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas));var r={premultipliedAlpha:!0,antialias:!0,preserveDrawingBuffer:!1},a=this.canvas.getContext("experimental-webgl",r)||this.canvas.getContext("webgl",r);if(null==a)return console.log("Please check that your browser enables & supports WebGL"),void 0;this._contextAttributes=a.getContextAttributes();var s=!1;if(this._contextAttributes&&(s=this._contextAttributes.antialias),0==s&&console.log("WARNING: anti-aliasing is not supported/enabled"),navigator){var o=null!=navigator.userAgent.match(/iPad/i);if(0==o){var l=navigator.userAgent;o=/iPad/i.test(l)||/iPhone OS 3_1_2/i.test(l)||/iPhone OS 3_2_2/i.test(l)}o&&(this._shouldForceClear=!0)}var c=Object.create(WebGLRenderer).initWithWebGLContext(a);a.enable(a.DEPTH_TEST);var h=null;this.sceneRenderer=Object.create(SceneRenderer),this.sceneRenderer.init(c,h);var u=this.getResourceManager();u.isObserving()||(u.observers.push(this),u.startObserving()),this.scene&&this.applyScene(),this.canvas.addEventListener("webglcontextlost",function(e){console.log("context was lost"),e.preventDefault(),t.getResourceManager.stopObserving(),t.sceneRenderer.webGLRenderer.resourceManager.reset(),t.needsDraw=!1,t._disableRendering=!0},!1),this.canvas.addEventListener("webglcontextrestored",function(e){console.log("context was restored"),e.preventDefault(),a.enable(a.DEPTH_TEST),t.needsDraw=!0,t._disableRendering=!1},!1),i&&setTimeout(function(){t.canvas.loseContext()},5e3);var t=this,d=BuiltInAssets.assetWithName("gradient");d.then(function(e){var n=Montage.create(Scene).init(e);t.gradientRenderer=Object.create(SceneRenderer),t.gradientRenderer.init(c,null),t.gradientRenderer.scene=n.glTFElement;var i=SceneHelper.getViewPoints(n);i&&i.length&&(t.gradientRenderer.technique.rootPass.viewPoint=i[0].glTFElement),t.needsDraw=!0},function(){},function(){}),this.actionDispatcher=ActionDispatcher.create().initWithScene(this.scene),this.needsDraw=!0,this.canvas.addEventListener("touchstart",this.start.bind(this),!0),this.canvas.addEventListener("touchend",this.end.bind(this),!0),this.canvas.addEventListener("touchcancel",this.end.bind(this),!0),this.canvas.addEventListener("touchmove",this.move.bind(this),!0),this.canvas.addEventListener("gesturechange",this,!0),this.canvas.addEventListener("mousedown",this.start.bind(this),!0),this.canvas.addEventListener("mouseup",this.end.bind(this),!0),this.canvas.addEventListener("mousemove",this.move.bind(this),!0),this.canvas.addEventListener("wheel",this,!0)}},exitDocument:{value:function(){window.removeEventListener("resize",this,!0)}},captureMousewheel:{value:function(){this.needsDraw=!0}},captureWheel:{value:function(){this.needsDraw=!0}},captureGesturechange:{value:function(){this.needsDraw=!0}},_TOUCH_DOWN:{value:0},_TOUCH_UP:{value:1},_TOUCH_MOVE:{value:2},_eventType:{value:-1,writable:!0},_previousEventType:{value:-1,writable:!0},_lastHandledComponent:{value:null,writable:!0},_previousHandledComponent:{value:null,writable:!0},handleSelectedNode:{value:function(t){var e=null,n=this._previousHandledComponent,i=n?n.component3D:null;if(this._eventType===this._TOUCH_UP&&(n&&i&&i.handleActionOnGlTFElement(n,Component3D._TOUCH_UP),this._eventType=-1),t&&(e=this.scene.glTFElement.ids[t],this._eventType===this._TOUCH_DOWN)){var r=SceneHelper.createNodeFromGlTFElementIfNeeded(e,this.scene);Application.dispatchEventNamed("sceneNodeSelected",!0,!0,r)}n&&i&&this._previousEventType===this._TOUCH_MOVE&&e!==n&&i.handleActionOnGlTFElement(n,Component3D._EXIT),this._eventType===this._TOUCH_MOVE&&e!==n?e?this.actionDispatcher.dispatchActionOnGlTFElement(Component3D._ENTER,e):this._eventType=-1:e&&this._eventType===this._TOUCH_DOWN&&(this.actionDispatcher.dispatchActionOnGlTFElement(Component3D._TOUCH_DOWN,e),this._eventType=-1),this._previousHandledComponent=e,this._previousEventType=this._eventType}},move:{value:function(t){var e=this.getRelativePositionToCanvas(t);this._mousePosition=[e.x*this.scaleFactor,this.height-e.y*this.scaleFactor],this._eventType=this._TOUCH_MOVE,this.needsDraw=!0}},start:{value:function(t){t.preventDefault(),this._consideringPointerForPicking=!0;var e=this.getRelativePositionToCanvas(t);this._mousePosition=[e.x*this.scaleFactor,this.height-e.y*this.scaleFactor],this._state===this.PLAY&&this.pause(),this._eventType=this._TOUCH_DOWN,this.needsDraw=!0}},end:{value:function(t){if(this._consideringPointerForPicking&&t.target===this.canvas&&t.preventDefault(),this._state===this.PAUSE&&this.scene&&this.viewPoint&&this.scene.glTFElement){var e=this.getAnimationManager();e.nodeHasAnimatedAncestor(this.viewPoint.glTFElement)&&this.play()}this._consideringPointerForPicking=!1,this._eventType=this._TOUCH_UP,this.handleSelectedNode(null),this._mousePosition=null}},getWebGLRenderer:{value:function(){return this.sceneRenderer?this.sceneRenderer.webGLRenderer:null}},getWebGLContext:{value:function(){var t=this.getWebGLRenderer();return t?t.webGLContext:null}},getResourceManager:{value:function(){var t=this.getWebGLRenderer();return t?t.resourceManager:null}},getAnimationManager:{value:function(){return this.scene&&this.scene.glTFElement?this.scene.glTFElement.animationManager:null}},showBBOX:{get:function(){return this._showBBOX},set:function(t){t!=this._showBBOX&&(this._showBBOX=t,this.needsDraw=!0)}},showGradient:{get:function(){return this._showGradient},set:function(t){t!=this._showGradient&&(this._showGradient=t,this.needsDraw=!0)}},showReflection:{get:function(){return this._showReflection},set:function(t){this._showReflection=t,this.needsDraw=!0}},handleSceneNodeSelected:{value:function(t){this.selectedNode=t.detail,this.needsDraw=!0}},_displayBBOX:{value:function(t){if(this.scene&&this.scene.glTFElement&&null!=t.getBoundingBox){var e=this.sceneRenderer.technique.rootPass.scenePassRenderer._viewPointMatrix,n=SceneHelper.getGLTFCamera(this.viewPoint);if(null!=n){var i=n.projection.matrix;this.getWebGLRenderer().drawBBOX(t.getBoundingBox(!0),e,mat4.identity(),i)}}}},_displayAllBBOX:{value:function(){if(this.scene&&this.scene.glTFElement){this.sceneRenderer.technique.rootPass.scenePassRenderer._viewPointMatrix;var t=mat4.identity(),e=this.scene.glTFElement.rootNode,n=this;e.apply(function(t){return n._displayBBOX(t),null},!0,t)}}},width:{get:function(){if(null==this._width){var t=window.getComputedStyle(this.element,null);return parseInt(t.width)*this.scaleFactor}return this._width},set:function(t){t*this.scaleFactor!=this._width&&(this._width=t*this.scaleFactor,this.needsDraw=!0)}},height:{get:function(){if(null==this._height){var t=window.getComputedStyle(this.element,null);return parseInt(t.height)*this.scaleFactor}return this._height},set:function(t){t*this.scaleFactor!=this._height&&(this._height=t*this.scaleFactor,this.needsDraw=!0)}},_forwardToNextAnimatedViewPointIfNeeded:{value:function(){var t=this.getAnimationManager();if(t){if(1==t.nodeHasAnimatedAncestor(this.viewPoint.glTFElement))return;var e=this._viewPointIndex,n=SceneHelper.getViewPoints(this.scene);if(n.length>1){for(var i=this.viewPoint,r=0;n.length>r&&0==t.nodeHasAnimatedAncestor(i.glTFElement);)e=++e%n.length,i=n[e],r++;this.viewPoint=i}}}},draw:{value:function(){var t=this.getWebGLContext();if(!(null==t||this._disableRendering||(this.sceneRenderer.technique.rootPass.viewPoint=this._internalViewPoint,(this._shouldForceClear||null==this._contextAttributes.preserveDrawingBuffer||1==this._contextAttributes.preserveDrawingBuffer)&&(t.clearColor(0,0,0,0),t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT)),this.delegate&&this.delegate.sceneWillDraw&&this.delegate.sceneWillDraw(),this.allowsProgressiveSceneLoading===!1&&this._sceneResourcesLoaded===!1||null==this._scene||null==this.viewPoint||this._disableRendering))){var e=this.width,n=this.height;(e!=this.canvas.width||n!=this.canvas.height)&&(this.canvas.style.width=e/this.scaleFactor+"px",this.canvas.style.height=n/this.scaleFactor+"px",this.canvas.width=e,this.canvas.height=n,t.viewport(0,0,e,n));var i=this.viewPoint,r=Date.now();if(this.sceneRenderer&&this.scene){var a=this.getAnimationManager();if(this._state==this.PLAY&&a){this._forwardToNextAnimatedViewPointIfNeeded(),a.sceneTime+=r-this._lastTime;var s=this.scene.glTFElement.endTime;a.sceneTime/1e3>s&&(this.loops?a.sceneTime=0==s?0:a.sceneTime%s:this.stop()),a.updateTargetsAtTime(a.sceneTime,this.getResourceManager())}if(i.glTFElement){var o=SceneHelper.getGLTFCamera(i);o.projection.aspectRatio=e/n,this._internalViewPoint.transform.matrix=i.glTFElement.worldMatrix,null!=this._internalViewPoint.cameras&&this._internalViewPoint.cameras.length>0&&(this._internalViewPoint.cameras[0]=o)}a.evaluateAtTime(r,this.getResourceManager()),a.hasActiveAnimations()&&(this.needsDraw=!0)}if(this._lastTime=r,this._state==this.PLAY&&(this.needsDraw=!0),this.scene&&(this.sceneRenderer.webGLRenderer,t)){null==this.__renderOptions&&(this.__renderOptions={});var l=this.showReflection;if(l){t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST),t.frontFace(t.CW),t.depthMask(!0);var c=this.scene.glTFElement.rootNode,h=c.getBoundingBox(!0),u=mat4.create(c.transform.matrix),d=mat4.scale(mat4.identity(),[1,1,-1]);mat4.multiply(d,c.transform.matrix),c.transform.matrix=d;var p=c.getBoundingBox(!0),m=mat4.identity(),g=mat4.translate(mat4.identity(),[0,0,h[0][2]-p[1][2]]);mat4.multiply(m,g),mat4.multiply(m,d),c.transform.matrix=m,this.sceneRenderer.render(r,this.__renderOptions),c.transform.matrix=u,t.frontFace(t.CCW)}(this.showGradient||l)&&this.viewPoint===this._defaultViewPoint&&this.gradientRenderer&&(t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.depthMask(!1),this.gradientRenderer.render(r,this.__renderOptions),t.depthMask(!0),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.disable(t.BLEND)),this.scene.shouldBeHitTested&&null!=this._mousePosition&&(this.__renderOptions.picking=!0,this.__renderOptions.coords=this._mousePosition,this.__renderOptions.delegate=this,this.sceneRenderer.render(r,this.__renderOptions)),this.__renderOptions.picking=!1,this.__renderOptions.coords=null,this.__renderOptions.delegate=null,this.sceneRenderer.render(r,this.__renderOptions),this.showBBOX&&this._displayAllBBOX(),this.delegate&&this.delegate.sceneDidDraw&&this.delegate.sceneDidDraw(),t.flush(),this._firstFrameDidRender===!1&&(this._firstFrameDidRender=!0,this.dispatchEventNamed("firstFrameDidRender",!0,!1,this))}}}},captureResize:{value:function(){this.needsDraw=!0;var t=this.element.offsetWidth,e=this.element.offsetHeight;this.width=t,this.height=e,this.needsDraw=!0}},templateDidLoad:{value:function(){this.parentComponent;var t=TranslateComposer.create();t.animateMomentum=!0,t.hasMomentum=!0,t.allowFloats=!0,t.pointerSpeedMultiplier=.15,this._internalViewPoint=SceneHelper.createGLTFNodeIncludingCamera("__internal_viewPoint__"),this.translateComposer=t,this.needsDraw=!0}}});