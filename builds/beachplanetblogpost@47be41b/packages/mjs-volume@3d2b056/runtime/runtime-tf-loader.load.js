montageDefine("3d2b056","runtime/runtime-tf-loader",{dependencies:["runtime/dependencies/gl-matrix","runtime/glTF-parser","runtime/resource-description","runtime/technique","runtime/pass","runtime/glsl-program","runtime/glTF-material","runtime/mesh","runtime/glTF-node","runtime/primitive","runtime/projection","runtime/camera","runtime/skin","runtime/glTF-scene","runtime/transform","runtime/animation","runtime/animation-manager"],factory:function(t,e){t("runtime/dependencies/gl-matrix");var n=t("runtime/glTF-parser").glTFParser,i=t("runtime/resource-description").ResourceDescription,r=t("runtime/technique").Technique,a=t("runtime/pass").ProgramPass;t("runtime/pass").Pass,t("runtime/pass").ScenePass;var s=t("runtime/glsl-program").GLSLProgram,o=t("runtime/glTF-material").glTFMaterial,l=t("runtime/mesh").Mesh,c=t("runtime/glTF-node").glTFNode,h=t("runtime/primitive").Primitive,u=t("runtime/projection").Projection,p=t("runtime/camera").Camera,d=t("runtime/skin").Skin,m=t("runtime/glTF-scene").glTFScene,g=t("runtime/transform").Transform,f=t("runtime/animation").KeyframeAnimation,v=t("runtime/animation-manager").AnimationManager;e.RuntimeTFLoader=Object.create(n,{_materials:{writable:!0,value:null},_scenes:{writable:!0,value:null},_animations:{writable:!0,value:null},totalBufferSize:{value:0,writable:!0},handleBuffer:{value:function(t,e){var n=Object.create(i).init(t,e);return n.id=t,this.storeEntry(t,n,e),this.totalBufferSize+=e.byteLength,!0}},handleBufferView:{value:function(t,e){var n=Object.create(i).init(t,e);n.id=t;var r=this.getEntry(n.description.buffer);return e.type="ArrayBufferView",n.buffer=r,this.storeEntry(t,n,e),!0}},handleShader:{value:function(t,e){var n=Object.create(i).init(t,e);return n.id=t,n.type="shader",this.storeEntry(t,n,e),!0}},handleProgram:{value:function(t,e){var n=Object.create(i).init(t,e);n.id=t,n.type="program";var r=this.getEntry(n.description.vertexShader),a=this.getEntry(n.description.fragmentShader);return n[s.VERTEX_SHADER]=r.entry,n[s.FRAGMENT_SHADER]=a.entry,this.storeEntry(t,n,e),!0}},handleImage:{value:function(t,e){var n=e.path,r=Object.create(i).init(n,{path:n});return r.type="image",this.storeEntry(t,r,e),!0}},handleVideo:{value:function(t,e){var n=e.path,r=Object.create(i).init(n,{path:n});return r.type="video",this.storeEntry(t,r,e),!0}},handleTechnique:{value:function(t,e){var n=Object.create(r);n.id=t;var i=this.storeEntry(t,n,e),s=e.pass;n.passName=s;var o=e.passes;if(!o)return console.log("ERROR: technique does not contain pass"),!1;var l={},c=Object.keys(e.passes);return c.forEach(function(t){var e=o[t],n=e.instanceProgram;if(!n)return console.log("ERROR: A Pass with type=program must have a program property"),!1;var r=Object.create(a).init();r.id=i+"_"+s,r.instanceProgram=e.instanceProgram,r.instanceProgram.program=this.getEntry(n.program).entry,r.states=e.states,l[t]=r},this),n.parameters=e.parameters,n.passes=l,!0}},handleMaterial:{value:function(t,e){var n=Object.create(o).init(t);this.storeEntry(t,n,e);var i=e.instanceTechnique,r=i.values;n.name=e.name;var a=this.getEntry(i.technique);if(!a)return console.log("ERROR: invalid file, cannot find referenced technique:"+e.technique),!1;n.technique=a.entry;var s=n.technique.parameters;if(n.parameters=JSON.parse(JSON.stringify(s)),r){var l;for(l in r){var c=n.parameters[l];if(c)switch(c.value=r[l],c.type){case WebGLRenderingContext.prototype.SAMPLER_CUBE:case WebGLRenderingContext.prototype.SAMPLER_2D:var h=this.getEntry(c.value);h&&(c.value=h.entry);break;default:}}}return this._materials||(this._materials=[]),this._materials.push(n),!0}},handleLight:{value:function(){return!0}},handleAccessor:{value:function(t,e){e.id=t;var n=this.getEntry(e.bufferView);e.bufferView=n.entry,e.byteOffset||(e.byteOffset=0),this.storeEntry(t,e,e)}},handleMesh:{value:function(t,e){var n=Object.create(l).init();n.id=t,n.name=e.name;var i=!1,r=e.extensions;r&&(r["won-compression"]&&(i=!0,n.compression=r["won-compression"],n.compression.type="won-compression",n.compression.compressedData.bufferView=this.getEntry(n.compression.compressedData.bufferView).entry,n.compression.compressedData.id=t+"_compressedData"),r["Open3DGC-compression"]&&(i=!0,n.compression=r["Open3DGC-compression"],n.compression.type="Open3DGC-compression",n.compression.compressedData.bufferView=this.getEntry(n.compression.compressedData.bufferView).entry,n.compression.compressedData.id=t+"_compressedData")),this.storeEntry(t,n,e);var a=e[l.PRIMITIVES];if(!a)return console.log("MISSING_PRIMITIVES for mesh:"+t),!1;for(var s=0;a.length>s;s++){var o=a[s];if(o.primitive===WebGLRenderingContext.prototype.TRIANGLES){var c=Object.create(h).init(),u=this.getEntry(o.material);c.material=u.entry,n.primitives.push(c);var p=o.attributes,d=Object.keys(p);d.forEach(function(t){var e=p[t],n=this.getEntry(e);c.addVertexAttribute({semantic:t,attribute:n.entry})},this);var m=o.indices,g=this.getEntry(m);c.indices=g.entry}}return!0}},handleCamera:{value:function(t,e){var n=Object.create(p).init();n.id=t,this.storeEntry(t,n,e);var i=Object.create(u);return i.initWithDescription(e),n.projection=i,!0}},handleLight:{value:function(){return!0}},buildNodeHirerachy:{value:function(t){var e=t.entry,n=t.description.children;n&&n.forEach(function(t){var n=this.getEntry(t),i=n.entry;null==i.parent?e.children.push(i):e.children.push(i.copy()),this.buildNodeHirerachy(n)},this)}},resolveParameterSources:{value:function(){this._materials&&this._materials.forEach(function(t){if(t.parameters){var e=Object.keys(t.parameters);e.forEach(function(e){var n=t.parameters[e];n&&n.source&&(n.source=this.getEntry(n.source).entry)},this)}},this)}},buildSkeletons:{value:function(t){if(t.instanceSkin){var e=t.instanceSkin.skin;if(e){t.instanceSkin.skeletons.forEach(function(t){var n=this.getEntry(t);if(n){var i=n.entry,r=e.jointsIds,a=[];r.forEach(function(e){var n=i.nodeWithJointID(e);n?a.push(n):console.log("WARNING: jointId:"+e+" cannot be found in skeleton:"+t)},this),e.nodesForSkeleton[t]=a}},this);var n=[];t.instanceSkin.sources.forEach(function(t){var e=this.getEntry(t);e&&n.push(e.entry)},this),e.sources=n}}var i=t.children;i&&i.forEach(function(t){this.buildSkeletons(t)},this)}},handleScene:{value:function(t,e){if(this._scenes||(this._scenes=[]),!e.nodes)return console.log("ERROR: invalid file required nodes property is missing from scene"),!1;var n=Object.create(m).init();n.ids=this._ids,n.id=t,n.name=e.name,n.baseURL=this.baseURL,this.storeEntry(t,n,e);var i=Object.create(c).initWithID();return e.nodes&&e.nodes.forEach(function(t){var e=this.getEntry(t);i.children.push(e.entry),this.buildNodeHirerachy(e)},this),this.resolveParameterSources(),this.buildSkeletons(i),n.rootNode=i,this._scenes.push(n),!0}},handleSkin:{value:function(t,e){var n=Object.create(d).init();n.bindShapeMatrix=mat4.create(e.bindShapeMatrix),n.jointsIds=e.joints,n.inverseBindMatricesDescription=e.inverseBindMatrices,n.inverseBindMatricesDescription.id=t+"_inverseBindMatrices",n.inverseBindMatricesDescription.bufferView=this.getEntry(n.inverseBindMatricesDescription.bufferView).entry,this.storeEntry(t,n,e)}},handleNode:{value:function(t,e){var n=Object.create(c).init();n.id=t,n.jointId=e.jointId,n.name=e.name,this.storeEntry(t,n,e),n.transform=Object.create(g).initWithDescription(e);var i;if(e.mesh&&(i=this.getEntry(e.mesh),n.meshes.push(i.entry)),e.meshes&&e.meshes.forEach(function(t){i=this.getEntry(t),i&&n.meshes.push(i.entry)},this),e.camera){var r=this.getEntry(e.camera);r&&n.cameras.push(r.entry)}if(e.instanceSkin){e.instanceSkin.skin=this.getEntry(e.instanceSkin.skin).entry,n.instanceSkin=e.instanceSkin;var a=n.instanceSkin.sources;a&&a.forEach(function(t){i=this.getEntry(t),i&&n.meshes.push(i.entry)},this)}return!0}},handleLoadCompleted:{value:function(){if(this.delegate){var t=null;if(this._state.options&&(t=this._state.options.ids),t)t.forEach(function(t){var e=this.getEntry(t);e&&this.delegate.loadCompleted(e.entry)},this);else if(this._scenes&&this.delegate&&this._scenes.length>0){var e=Object.create(v).init();e.animations=this._animations,this._scenes[0].animationManager=e,this.delegate.loadCompleted(this._scenes[0])}}}},handleAnimation:{value:function(t,e){this._animations||(this._animations=[]);var n=WebGLRenderingContext.prototype,i=Object.create(f).initWithDescription(e);i.id=t,this.storeEntry(t,i,e);var r={};Object.keys(e.parameters).forEach(function(a){var s=e.parameters[a];switch(parameterDescription=this.getEntry(s).entry,parameterDescription.type){case n.FLOAT_VEC4:componentsPerAttribute=4;break;case n.FLOAT_VEC3:componentsPerAttribute=3;break;case n.FLOAT_VEC2:componentsPerAttribute=2;break;case n.FLOAT:componentsPerAttribute=1;break;default:console.log("type:"+parameterDescription.type+" byteStride not handled")}if(parameterDescription.extensions){var o=parameterDescription.extensions;if(o){var l=o["Open3DGC-compression"];if(l){var c=l.compressedData;c&&"object"!=typeof c.bufferView&&(c.bufferView=this.getEntry(c.bufferView).entry,c.id=t+a+"_compressedData")}}}parameterDescription.byteStride=4*componentsPerAttribute,parameterDescription.componentsPerAttribute=componentsPerAttribute,parameterDescription.id=i.id+a,r[a]=parameterDescription},this),i.parameters=r,i.channels.forEach(function(t){var e=t.target.id;t.path=t.target.path,t.target=this.getEntry(e).entry},this),Object.keys(i.samplers).forEach(function(t){var n=e.samplers[t],a=i.samplers[t],s=n.input,o=n.output;a.input=r[s],a.output=r[o]},this),this._animations.push(i)}},handleTexture:{value:function(t,e){if(e.source&&e.sampler)e.type="texture",e.source=this.getEntry(e.source).entry,e.sampler=this.getEntry(e.sampler).entry,e.id=t,this.storeEntry(t,e,e);else if(e.sources&&e.sampler){e.type="texture";for(var n=0;e.sources.length>n;n++)e.sources[n]=this.getEntry(e.sources[n]).entry;e.sampler=this.getEntry(e.sampler).entry,e.id=t,this.storeEntry(t,e,e)}else console.log("ERROR: texture"+t+" must contain both source and sampler properties")}},handleSampler:{value:function(t,e){e.id=e,this.storeEntry(t,e,e)}},handleError:{value:function(){}},_delegate:{value:null,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(t){this._delegate=t}},_entries:{enumerable:!1,value:null,writable:!0},removeAllEntries:{value:function(){this._entries={}}},containsEntry:{enumerable:!1,value:function(t){return this._entries?this._entries[t]?!0:!1:!1}},storeEntry:{enumerable:!1,value:function(t,e,n){return null==this._entries&&(this._entries={}),null==this._ids&&(this._ids={}),e.baseId=t,this._ids[t]=e,(t+=this.loaderContext())?(e.id=t,this.containsEntry[t]&&console.log("WARNING: entry:"+t+" is already stored, overriding"),this._entries[t]={id:t,entry:e,description:n},t):(console.log("ERROR: not id provided, cannot store"),void 0)}},getEntry:{enumerable:!1,value:function(t){return t+=this.loaderContext(),this._entries?this._entries[t]:null}}})}});