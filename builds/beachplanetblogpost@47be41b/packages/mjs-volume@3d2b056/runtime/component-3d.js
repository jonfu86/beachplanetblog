var Montage=require("montage").Montage,glTFNode=require("runtime/glTF-node").glTFNode,Transform=require("runtime/transform").Transform,Target=require("montage/core/target").Target,Set=require("collections/set"),CSSOM=require("cssom");require("runtime/dependencies/gl-matrix"),exports.Component3D=Target.specialize({_ENTER:{value:"COMPONENT_ENTER"},_EXIT:{value:"COMPONENT_EXIT"},_TOUCH_DOWN:{value:"_TOUCH_DOWN"},_TOUCH_UP:{value:"_TOUCH_UP"},self:{get:function(){return this}},constructor:{value:function(){this._hasUnresolvedId=!0,this._state=this.__STYLE_DEFAULT__,this.super()}},handleEnteredDocument:{value:function(){}},shouldPerformHitTest:{value:!1},addEventListener:{value:function(t,e,n){this.scene&&(this.scene.shouldBeHitTested=!0),this.shouldPerformHitHest=!0,this.super(t,e,n)}},_glTFElement:{value:null,writable:!0},glTFElement:{get:function(){return this._glTFElement},set:function(t){this._glTFElement=t}},_scene:{value:null,writable:!0},scene:{get:function(){return this._scene},set:function(t){this._scene=t,this._sceneDidChange()}},baseURL:{get:function(){return this.scene?this.scene.glTFElement.baseURL:null}},_isAbsolutePath:{value:function(t){var e=RegExp("^"+window.location.protocol,"i");return t.match(e)?!0:!1}},resolvePathIfNeeded:{value:function(t){return this._isAbsolutePath(t)?t:this.baseURL+t}},name:{get:function(){return this.glTFElement?this.glTFElement.name:void 0},set:function(t){this.glTFElement&&(this.glTFElement.name=t)}},_hasUnresolvedId:{value:!1,writable:!0},handleStatusChange:{value:function(t){"loaded"===t&&this._id&&(this.glTFElement=this.scene.glTFElement.ids[this._id],null==this.glTFElement&&this.scene.glTFElement.rootNode.id==this._id&&(this.glTFElement=this.scene.glTFElement.rootNode),this.glTFElement&&(this._hasUnresolvedId=!1,this.glTFElement.component3D=this,this.classListDidChange(),this.shouldPerformHitHest&&(this.scene.shouldBeHitTested=!0)))}},resolveIdIfNeeded:{value:function(){if(this._hasUnresolvedId&&null!=this.scene){if("loaded"!==this.scene.status)return this.scene.addOwnPropertyChangeListener("status",this),void 0;this._id&&this.handleStatusChange(this.scene.status,"status",this.scene)}}},_idDidChange:{value:function(){this.resolveIdIfNeeded()}},_sceneDidChange:{value:function(){this.resolveIdIfNeeded(),this.scene&&(this.scene.addEventListener("enteredDocument",this),this.scene.addEventListener("styleSheetsDidLoad",this))}},__STYLE_DEFAULT__:{value:"__default__"},_state:{value:this.__STYLE_DEFAULT__,writable:!0},_stateForSelectorName:{value:function(t){return-1!==t.indexOf(":active")?(this.scene&&(this.scene.shouldBeHitTested=!0),"active"):-1!==t.indexOf(":hover")?(this.scene&&(this.scene.shouldBeHitTested=!0),"hover"):-1!==t.indexOf(":")?null:this.__STYLE_DEFAULT__}},_style:{value:null,writable:!0},_defaultTransition:{value:{duration:0,timingFunction:"ease",delay:0}},_createDefaultStyleIfNeeded:{value:function(){return null==this._style&&(this._style={}),null==this._style.transitions&&(this._style.transitions={}),this._style}},_createStyleStateAndPropertyIfNeeded:{value:function(t,e){var n=this._createDefaultStyleIfNeeded();null==n[t]&&(n[t]={});var i=n[t];return null==i[e]&&(i[e]={}),i[e]}},_getStylePropertyObject:{value:function(t,e){return this._createStyleStateAndPropertyIfNeeded(t,e)}},_checkTransformConsistency:{value:function(t,e){return t.length!=e?(console.log("Component3D: CSS transform ignored got:"+t.length+" but expecting:"+e),!1):!0}},_createVectorFromCSSTransformOriginDeclaration:{value:function(t){var e,n=t.split(" ");return n.length>=2?(e=vec2.create(),e[0]=parseFloat(n[0]),e[1]=parseFloat(n[1]),e):vec2.createFrom(50,50)}},_createTransformFromCSS:{value:function(t){var e,n,i,a=3.1415926535,s=a/180,r=Object.create(Transform).init(),o=mat4.identity(),l=0;t=t.trim();for(var c,h=0,p=0,u=0,d=0,g=0;-1!==h&&(h=t.indexOf("(",l),-1!==h)&&(c=t.substring(l,h),l=h+1,h=t.indexOf(")",l),-1!==h);){for(var m=t.substring(l,h),f=-1!==m.indexOf(",")?m.split(","):[m],v=new Float32Array(f.length),L=0;f.length>L;L++)v[L]=parseFloat(f[L]);switch(l=h+1,c.trim()){case"matrix3d":if(this._checkTransformConsistency(v,16)){var y=v,C=mat4.createFrom(y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8],y[9],y[10],y[11],y[12],y[13],y[14],y[15]);mat4.multiply(o,C),g++}break;case"translate3d":this._checkTransformConsistency(v,3)&&(0===d&&(r.translation=vec3.create(v)),mat4.translate(o,v),d++);break;case"translateX":this._checkTransformConsistency(v,1)&&(n=[v[0],0,0],0===d&&(r.translation=vec3.create(n)),mat4.translate(o,n),d++);break;case"translateY":this._checkTransformConsistency(v,1)&&(n=[0,v[0],0],0===d&&(r.translation=vec3.create(n)),mat4.translate(o,n),d++);break;case"translateZ":this._checkTransformConsistency(v,1)&&(n=[0,0,v[0]],0===d&&(r.translation=vec3.create(n)),mat4.translate(o,n),d++);break;case"scale3d":this._checkTransformConsistency(v,3)&&(0===p&&(r.scale=vec3.create(v)),mat4.scale(o,v),d++);break;case"scaleX":this._checkTransformConsistency(v,1)&&(i=[v[0],1,1],0===p&&(r.scale=vec3.create(i)),mat4.scale(o,i),p++);break;case"scaleY":this._checkTransformConsistency(v,1)&&(i=[1,v[0],1],0===p&&(r.scale=vec3.create(i)),mat4.scale(o,i),p++);break;case"scaleZ":this._checkTransformConsistency(v,1)&&(i=[1,1,v[0]],0===p&&(r.scale=vec3.create(i)),mat4.scale(o,i),p++);break;case"rotate3d":this._checkTransformConsistency(v,4)&&(v[3]*=s,0===u&&(r.rotation=v),mat4.rotate(o,v[3],v),u++);break;case"rotateX":this._checkTransformConsistency(v,1)&&(e=[1,0,0,v[0]],e[3]*=s,0===u&&(r.rotation=e),mat4.rotate(o,e[3],e),u++);break;case"rotateY":this._checkTransformConsistency(v,1)&&(e=[0,1,0,v[0]],e[3]*=s,0===u&&(r.rotation=e),mat4.rotate(o,e[3],e),u++);break;case"rotateZ":this._checkTransformConsistency(v,1)&&(e=[0,0,1,v[0]],e[3]*=s,0===u&&(r.rotation=e),mat4.rotate(o,e[3],e),u++);break;case"perspective":h=-1;break;default:h=-1}}return(p>1||u>1||d>1||g>0)&&(r.matrix=o),r}},_createTransitionFromComponents:{value:function(t){var e={},n=["duration","timing-function","delay"],i=["ease","linear","ease-in","ease-out","ease-in-out","step-start"],a=0;return t.forEach(function(s){var r=!1,o=a;do"duration"===n[o]?-1===i.indexOf(s)&&(r=!0,e.duration=parseFloat(s),a=o):"timing-function"===n[o]?-1!==i.indexOf(s)&&(r=!0,e.timingFunction=s,a=o):"delay"===n[o]&&o==t.length-1&&(r=!0,e.delay=parseFloat(s)),o++;while(n.length>a&&0==r)},this),null==e.duration&&(e.duration=0),null==e.timingFunction&&(e.timingFunction="ease"),null==e.delay&&(e.delay=0),e}},_applyCSSPropertyWithValueForState:{value:function(t,e,n){if(null==n||null==e)return!1;if("transition"!==e&&-1===this.styleableProperties.indexOf(e))return!1;var i=this._getStylePropertyObject(t,e);switch(e){case"transition":var a=n.split(" ");if(a.length>0){var s=a.shift();if(s=this.propertyNameFromCSS(s),-1!==this.styleableProperties.indexOf(s)&&a.length>0){var r=this._createTransitionFromComponents(a);if(null!=r){var o=this._createDefaultStyleIfNeeded();o.transitions[s]=r}}}break;case"offsetTransform":i.value="string"==typeof n?this._createTransformFromCSS(n):n;break;case"transformOrigin":i.value="string"==typeof n?this._createVectorFromCSSTransformOriginDeclaration(n):n;break;case"transformZOrigin":i.value="string"==typeof n?parseFloat(n):n;break;case"visibility":i.value=n;break;case"opacity":i.value="string"==typeof n?parseFloat(n):n;break;case"cursor":i.value=n;break;default:return!1}return!0}},propertyNameFromCSS:{value:function(t){return"-webkit-transform"===t&&(t="transform"),"-webkit-transform-origin"===t&&(t="transform-origin"),"-montage-transform-z-origin"===t&&(t="transformZOrigin"),"transform"===t&&(t="offsetTransform"),"transform-origin"===t&&(t="transformOrigin"),t}},_dumpStyle:{value:function(t){console.log("**dump style:"+t);var e=this._style[t];for(var n in e){var i=e[n];if(null!=i.value)switch(n){case"offsetTransform":console.log("property:"+n+" value:"+mat4.str(i.value.matrix));break;default:console.log("property:"+n+" value:"+i.value)}}}},_dumpAllStyles:{value:function(){console.log("******** dump styles ********");for(var t in this._style)this._dumpStyle(t)}},_applyStyleRule:{value:function(t,e){var n=this._stateForSelectorName(t),i=null;if(e.style){n===this.__STYLE_DEFAULT__&&this.styleableProperties.forEach(function(t){i=this._getStylePropertyObject(n,t),null==i.value&&this._applyCSSPropertyWithValueForState(n,t,this.initialValueForStyleableProperty(t))},this);var a=e.style.length;if(a>0){for(var s=null,r=0;a>r;r++){var o=e.style[r],l=e.style[o];o=this.propertyNameFromCSS(o),-1!=o.indexOf("transition-")?(null==s&&(s={}),s[o]=l):this._applyCSSPropertyWithValueForState(n,o,l)}if(null!=s){o="transition";var c="";null!=s["transition-property"]&&(c+=s["transition-property"],null!=s["transition-duration"]&&(c+=" ",c+=s["transition-duration"]),null!=s["transition-timing-function"]&&(c+=" ",c+=s["transition-timing-function"]),null!=s["transition-timing-delay"]&&(c+=" ",c+=s["transition-timing-delay"]),this._applyCSSPropertyWithValueForState(n,o,c))}}}}},_removeStyleRule:{value:function(t,e){if(e.style){var n=e.style.length;if(n>0)for(var i=0;n>i;i++){var a=e.style[i];e.style[a],a=this.propertyNameFromCSS(a);var s=this._stateForSelectorName(t);if(null!=s){var r=this._getStylePropertyObject(s,a);r.value=this.initialValueForStyleableProperty(a)}}}}},appliedProperties:{value:null,writable:!0},_executeStylesForState:{value:function(t){null==this.appliedProperties&&(this.appliedProperties={}),null!=this.styleableProperties&&this.styleableProperties.forEach(function(e){var n=this._getStylePropertyObject(t,e),i=!1;n&&(null!=n.value&&(i=!0,this.appliedProperties[e]!==n.value&&(this[e]=n.value,this.appliedProperties[e]=n.value)),0==i&&(n=this._getStylePropertyObject(this.__STYLE_DEFAULT__,e),null!=n.value&&(i=!0,this.appliedProperties[e]!==n.value&&(this[e]=n.value,this.appliedProperties[e]=n.value))))},this)}},_applySelectorNamed:{value:function(t){var e=this.retrieveCSSRule(t);e&&this._applyStyleRule(t,e)}},_applyClassNamed:{value:function(t){this._applySelectorNamed("."+t),this._applySelectorNamed("."+t+":hover"),this._applySelectorNamed("."+t+":active")}},_removeSelectorNamed:{value:function(t){var e=this.retrieveCSSRule(t);e&&this._removeStyleRule(t,e)}},_removeClassNamed:{value:function(t){this._removeSelectorNamed("."+t+":hover"),this._removeSelectorNamed("."+t+":active"),this._removeSelectorNamed("."+t)}},_removeSelectorsForState:{value:function(t){for(var e=this.classList.enumerate(),n=0;e.length>n;n++){var i=e[n][1];this._removeClassNamed(i,t)}}},classListDidChange:{value:function(){if(this.classList){for(var t=this.classList.enumerate(),e=0;t.length>e;e++){var n=t[e][1];this._applyClassNamed(n)}this._executeStylesForState(this._state)}}},_id:{value:null,writable:!0},id:{get:function(){return this._id},set:function(t){t!=this._id&&(this._id=t,this._idDidChange())}},initWithScene:{value:function(t){return this.scene=t,this}},_classList:{value:null},classList:{get:function(){return null==this._classList&&(this._classList=new Set,this._classList.addRangeChangeListener(this,"classList")),this._classList},set:function(t){if(this._classList!==t){if(null!=this._classList&&this._classList.removeRangeChangeListener(this,"classList"),null!=t){var e=this;t instanceof Array?(this._classList=new Set,t.forEach(function(t){e._classList.add(t)},this),t=this._classList):this._classList=t}this._classList.addRangeChangeListener(this,"classList"),this.classListDidChange()}}},handleClassListRangeChange:{value:function(t,e){return null!=t&&t.forEach(function(t){this._applyClassNamed(t)},this),null!=e?(e.forEach(function(t){this._removeClassNamed(t)},this),this.classListDidChange(),void 0):(this._executeStylesForState(this._state),void 0)}},cssDescriptions:{value:null,writable:!0},handleStyleSheetsDidLoad:{value:function(){this.scene.removeEventListener("styleSheetsDidLoad",this),this.classListDidChange()}},retrieveCSSRule:{value:function(t){for(var e in this.scene.styleSheets)for(var n=this.scene.styleSheets[e],i=n.cssRules,a=0;i.length>a;a++){var s=i[a];if(null!=s.selectorText&&s.selectorText===t)return s}}},handleActionOnGlTFElement:{value:function(t,e){var n=this.__STYLE_DEFAULT__;switch(e){case this._ENTER:n="hover";var i=document.createEvent("CustomEvent");i.initCustomEvent("hover",!0,!0,{glTFElement:t}),this.dispatchEvent(i);break;case this._EXIT:n=this.__STYLE_DEFAULT__;break;case this._TOUCH_DOWN:n="active";var a=document.createEvent("CustomEvent");a.initCustomEvent("action",!0,!0,{glTFElement:t}),this.dispatchEvent(a);break;case this._TOUCH_UP:n=this.__STYLE_DEFAULT__}n!==this._state&&(this._state=n,this._executeStylesForState(n))}},deserializedFromTemplate:{value:function(t,e){this.nextTarget=t,this.identifier=e}},blueprintModuleId:require("montage")._blueprintModuleIdDescriptor,blueprint:require("montage")._blueprintDescriptor});