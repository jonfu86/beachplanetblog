require("runtime/dependencies/gl-matrix");var Base=require("runtime/base").Base,Transform=require("runtime/transform").Transform,Utilities=require("runtime/utilities").Utilities,glTFNode=exports.glTFNode=Object.create(Base,{currentId:{value:0,writable:!0},bumpId:{value:function(){return glTFNode._id++}},_children:{value:null,writable:!0},children:{get:function(){return this._children},set:function(t){this._children=t}},_id:{value:null,writable:!0},id:{get:function(){return this._id},set:function(t){this._id=t}},_hidden:{value:null,writable:!0},hidden:{get:function(){return this._hidden},set:function(t){this._hidden=t}},_computeBBOXForMeshes:{value:function(t){var e=t.length;if(e>0){var n=t[0].boundingBox;if(n){var i;for(i=1;e>i;i++){var a=t[i].boundingBox;a&&(n=Utilities.mergeBBox(n,a))}this._boundingBox=n}}}},_computeBBOXIfNeeded:{enumerable:!1,value:function(){if(null==this._boundingBox){var t=this._properties.meshes;null!=this.instanceSkin&&null!=this.instanceSkin.skin&&(t=null==t?this.instanceSkin.skin.sources:t.concat(this.instanceSkin.skin.sources)),null!=t&&this._computeBBOXForMeshes(t)}}},getBoundingBox:{value:function(t){if(t){var e=mat4.identity(),n=null;return this.apply(function(t){if(t.boundingBox){var e=Utilities.transformBBox(t.boundingBox,t.worldMatrix);n=null!=n?Utilities.mergeBBox(e,n):e}return null},!0,e),n}return this.boundingBox}},_boundingBox:{enumerable:!1,value:null,writable:!0},boundingBox:{enumerable:!0,get:function(){return this._computeBBOXIfNeeded(),this._boundingBox},set:function(t){this._boundingBox=t}},meshesDidChange:{value:function(){this._boundingBox=null}},nodesDidChange:{value:function(){}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent}},init:{value:function(){this.__Base_init(),this._children=[],this.transform=Object.create(Transform).init(),this._properties.meshes=[];var t=this;return this._properties.meshes.push=function(e){var n=Array.prototype.push.call(this,e);return t.meshesDidChange(this),n},this._children.push=function(e){var n=Array.prototype.push.call(this,e);return e._parent=t,t.nodesDidChange(this),n},this._properties.cameras=[],this._properties.lights=[],this._worldMatrixIsDirty=!0,this._worldMatrix=mat4.create(),this}},initWithID:{value:function(t){return this.id=null==t?this.id+"-"+this.bumpId():t,this.init()}},getPropertyArrayNamed:{value:function(t){return this._properties[t]}},_observers:{value:null,writable:!0},addObserver:{value:function(t){null==this._observers&&(this._observers=[]),-1===this._observers.indexOf(t)?this._observers.push(t):console.log("WARNING attempt to add 2 times the same observer in transform")}},removeObserver:{value:function(t){if(this._observers){var e=this._observers.indexOf(t);-1!==e&&this._observers.splice(e,1)}}},_transform:{value:null,writable:!0},transform:{get:function(){if(this.target){var t=this.target.worldMatrix,e=this._transform.translation,n=vec3.create(),i=[0,1,0];Utilities.decomposeMat4(t,n,null,null);var a=mat4.lookAt(e,n,i);mat4.inverse(a);var r=Object.create(Transform).init();r.matrix=a,this._transform.rotation=r.rotation}return this._transform},set:function(t){if(this._observers)for(var e=0;this._observers.length>e;e++)this._observers[e].transformWillChange(this,this._transform,t);if(this._transform&&this._transform.removeObserver(this),this._transform=t,this._invalidateWorldMatrix(),this._transform&&this._transform.addObserver(this),this._observers)for(var e=0;this._observers.length>e;e++)this._observers[e].transformDidChange(this)}},meshes:{get:function(){return this.getPropertyArrayNamed("meshes")},set:function(t){this._properties.meshes=t,this.meshesDidChange(t)}},cameras:{get:function(){return this.getPropertyArrayNamed("cameras")},set:function(t){this._properties.cameras=t}},lights:{get:function(){return this.getPropertyArrayNamed("lights")},set:function(t){this._properties.lights=t}},_apply:{value:function(t,e,n,i){t&&(i=t(this,n,i),e&&this.children.forEach(function(n){n._apply(t,e,this,i)},this))}},apply:{value:function(t,e,n){this._apply(t,e,null,n)}},_nodeWithName:{value:function(t){if(this.name===t)return this;if(this.children)for(var e=0;this.children.length>e;e++){var n=this.children[e],i=n._nodeWithName(t);if(i)return i}return null}},nodeWithName:{value:function(t){return this._nodeWithName(t)}},_nodeWithID:{value:function(t){if(this.id===t)return this;if(this.children)for(var e=0;this.children.length>e;e++){var n=this.children[e],i=n._nodeWithID(t);if(i)return i}return null}},nodeWithJointID:{value:function(t){return this._nodeWithJointID(t)}},_nodeWithJointID:{value:function(t){if(this.jointId===t)return this;if(this.children)for(var e=0;this.children.length>e;e++){var n=this.children[e],i=n._nodeWithJointID(t);if(i)return i}return null}},nodeWithID:{value:function(t){return this._nodeWithID(t)}},copy:{value:function(t){var t=Object.create(glTFNode).init();t.name=this.name,this.meshes&&this.meshes.forEach(function(e){t.meshes.push(e)},this),this.lights&&this.lights.forEach(function(e){t.lights.push(e)},this),this.cameras&&this.cameras.forEach(function(e){t.cameras.push(e)},this);var e=this.bumpId();return t.id=this.id+"-"+e,t.baseId=this.baseId+"-"+e,t.transform=this.transform.copy(),t}},_worldMatrixIsDirty:{value:!0,writable:!0},_worldMatrix:{value:null,writable:!0},_offsetTransform:{value:null,writable:!0},_originVector:{value:null,writable:!0},worldMatrix:{get:function(){if(this.parent){if((this._worldMatrixIsDirty||null!=this.target)&&(mat4.multiply(this.parent.worldMatrix,this.transform.matrix,this._worldMatrix),this._worldMatrixIsDirty=!1),null!=this._offsetTransform){var t=this.getBoundingBox(!1);if(null!=t){mat4.create();var e=mat4.identity(),n=mat4.create(),i=vec3.createFrom(.5,.5,.5);null!=this._originVector&&(i[0]=this._originVector[0]/100,i[1]=this._originVector[1]/100,i[2]=this._originVector[2]/100);var a=[(t[0][0]+t[1][0])*i[0],(t[0][1]+t[1][1])*i[1],(t[0][2]+t[1][2])*i[2]],r=vec3.create(a);return mat4.translate(e,r),mat4.multiply(e,this._offsetTransform.matrix,n),mat4.multiply(this._worldMatrix,n,e),r[0]=-r[0],r[1]=-r[1],r[2]=-r[2],mat4.translate(e,r),e}}return this._worldMatrix}return this._worldMatrixIsDirty=!1,this.transform.matrix}},_ignoresTransformUpdates:{value:!1,writable:!0},_invalidateWorldMatrix:{value:function(){if(this._worldMatrixIsDirty=!0,this._ignoresTransformUpdates=!0,this._transform._fireTransformDidUpdate(),this._ignoresTransformUpdates=!1,this._children)for(var t=0;this._children.length>t;t++)this._children[t]._invalidateWorldMatrix()}},transformDidUpdate:{value:function(){this._ignoresTransformUpdates===!1&&this._invalidateWorldMatrix()}},nodeWithJointID:{value:function(t){return this._nodeWithJointID(t)}},nodeWithPropertyNamed:{value:function(t){if(null!=this[t])return this;if(this.children)for(var e=0;this.children.length>e;e++){var n=this.children[e],i=n.nodeWithPropertyNamed(t);if(i)return i}return null}},nodesWithPropertyNamed:{value:function(t,e){if(null!=this[t]&&e.push(this),this.children)for(var n=0;this.children.length>n;n++){var i=this.children[n];i.nodesWithPropertyNamed(t,e)}}},_target:{value:null,writable:!0},target:{get:function(){return this._target},set:function(t){this._target=t}}});