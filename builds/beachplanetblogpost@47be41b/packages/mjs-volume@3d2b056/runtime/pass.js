require("runtime/dependencies/gl-matrix");var Montage=require("montage").Montage,glTFNode=require("runtime/glTF-node").glTFNode,NodeWrapper=require("runtime/node-wrapper").NodeWrapper,Projection=require("runtime/projection").Projection,Camera=require("runtime/camera").Camera,Utilities=require("runtime/utilities").Utilities,WebGLRenderer=require("runtime/webgl-renderer").WebGLRenderer,Transform=require("runtime/transform").Transform,ResourceDescription=require("runtime/resource-description").ResourceDescription,LinkedListNode=Object.create(Object.prototype,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(t){this._content=t}},_previous:{value:null,writable:!0},previous:{get:function(){return this._previous},set:function(t){this._previous=t}},_next:{value:null,writable:!0},next:{get:function(){return this._next},set:function(t){this._next=t}},init:{value:function(t){this.content=t,this.previous=null,this.next=null}},removeFromList:{value:function(){this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous),this.next=null,this.previous=null}}}),LinkedList=Object.create(Object.prototype,{_tail:{value:null,writable:!0},tail:{get:function(){return this._tail},set:function(t){this._tail=t}},_head:{value:null,writable:!0},head:{get:function(){return this._head},set:function(t){this._head=t}},append:{value:function(t){this.head||(this.head=t),this.tail&&(t.previous=this.tail,this.tail.next=t),this.tail=t}},remove:{value:function(t){t.content.id;var e=!1,n=!1;this.tail===t&&(e=!0,this.tail=t.previous),this.head===t&&(n=!0,this.head=t.next)}}}),RenderTarget=exports.RenderTarget=Object.create(Object.prototype,{_extras:{value:null,writable:!0},_width:{value:0,writable:!0},_height:{value:0,writable:!0},_attachments:{value:null,writable:!0},attachments:{get:function(){return this._attachments},set:function(t){this._attachments=t}},init:{value:function(){return this.attachments=[],this.extras={},this}},width:{get:function(){return this._width},set:function(t){this._width=t}},height:{get:function(){return this._height},set:function(t){this._height=t}},extras:{get:function(){return this._extras},set:function(t){this._extras=t}}}),Pass=Object.create(Object.prototype,{_extras:{value:null,writable:!0},PROGRAM:{value:"program",writable:!1},SCENE:{value:"scene",writable:!1},_type:{value:null,writable:!0},type:{get:function(){return this._type}},extras:{get:function(){return this._extras},set:function(t){this._extras=t}}}),ProgramPass=exports.ProgramPass=Montage.create(Pass,{_attributes:{value:null,writable:!0},_uniforms:{value:null,writable:!0},_states:{value:null,writable:!0},_program:{value:null,writable:!0},states:{get:function(){return this._states},set:function(t){this._states=t}},program:{get:function(){return this._program},set:function(t){this._program=t}},init:{value:function(){return this.attributes={},this.uniforms={},this.states={},this._type=Pass.PROGRAM,this.extras={},this}}}),ScenePassRenderer=Object.create(Object.prototype,{_nodeWrappers:{value:null,writable:!0},_pathIDsForNodeID:{value:null,writable:!0},_primitivesPerPass:{value:null,writable:!0},_viewPoint:{value:null,writable:!0},_scene:{value:null,writable:!0},_observers:{value:null,writable:!0},_viewPointMatrix:{value:null,writable:!0},addObserver:{value:function(t){null==this._observers&&(this._observers=[]),-1===this._observers.indexOf(t)?this._observers.push(t):console.log("WARNING attempt to add 2 times the same observer in sceneRenderer")}},removeObserver:{value:function(t){if(this._observers){var e=this._observers.indexOf(t);-1!==e&&this._observers.splice(e,1)}}},viewPoint:{get:function(){return this._viewPoint},set:function(t){if(this._observers)for(var e=0;this._observers.length>e;e++)this._observers[e].viewPointWillChange(this,this._viewPoint,t);if(this._viewPoint!=t&&(this._viewPoint=t),this._observers)for(var e=0;this._observers.length>e;e++)this._observers[e].viewPointMatrixDidUpdate(this),this._observers[e].viewPointDidChange(this)}},setupNodeAtPath:{value:function(t){var e=this._nodeWrappers[t.id];null==e&&(e=Object.create(NodeWrapper).init(t),this._nodeWrappers[t.id]=e,e.scenePassRenderer=this),t.meshes&&t.meshes.forEach(function(n){n.primitives&&n.primitives.forEach(function(i){if(i.material){var r=i.material.technique;if(r&&r.rootPass){var a,s=r.rootPass.id,o=null;for(a=0;this._primitivesPerPass.length>a;a++)this._primitivesPerPass[a].pass===s&&(o=this._primitivesPerPass[a]);null==o&&(o=this._primitivesPerPass[s]={pass:r.rootPass,primitives:[]},this._primitivesPerPass.push(o));var l={};n.compression&&(l.compressed=!0),l.primitive=i,l.node=t,l.nodeWrapper=e,o.primitives.push(l)}}},this)},this)}},sceneWillChange:{value:function(){this._viewPointMatrix=mat4.identity()}},sceneDidChange:{value:function(){this._primitivesPerPass=[],this._nodeWrappers={};var t=this;this.scene&&this.scene.rootNode.apply(function(e){return t.setupNodeAtPath(e),null},!0,null)}},render:{value:function(t,e,n){if(this.scene&&this.viewPoint){if(null==this.__matrix&&(this.__matrix=mat4.create()),this.viewPoint&&(mat4.set(this.viewPoint.worldMatrix,this.__matrix),mat4.inverse(this.__matrix),mat4.equal(this._viewPointMatrix,this.__matrix)===!1&&(mat4.set(this.__matrix,this._viewPointMatrix),this._observers)))for(var i=0;this._observers.length>i;i++)this._observers[i].viewPointMatrixDidUpdate(this);var r,a=n?n.picking===!0&&null!=n.coords:!1;for(a&&(this.pickingRenderTarget.extras.coords=n.coords,t.bindRenderTarget(this.pickingRenderTarget)),t.projectionMatrix=this.viewPoint.cameras[0].projection.matrix,null==this.__nonOpaquePassesWithPrimitives&&(this.__nonOpaquePassesWithPrimitives=[]),this.__nonOpaquePassesWithPrimitives.length=0,r=0;this._primitivesPerPass.length>r;r++){var s=this._primitivesPerPass[r],o=a?this.pickingPass:s.pass,l=o.states;l.blendEnable&&!a?this.__nonOpaquePassesWithPrimitives.push(s):a&&this.pickingTechnique?t.renderPrimitivesWithPass(s.primitives,o,this.pickingTechnique.parameters,e):t.renderPrimitivesWithPass(s.primitives,o,null,e)}if(a){t.unbindRenderTarget(this.pickingRenderTarget);var c=this.pickingRenderTarget.extras.pickedPixel,h=null,u=Object.keys(this.pickingPass.extras.nodeIDToColor);u.forEach(function(t){var e=this.pickingPass.extras.nodeIDToColor[t];1>=Math.abs(Math.round(255*e[0])-c[0])&&1>=Math.abs(Math.round(255*e[1])-c[1])&&1>=Math.abs(Math.round(255*e[2])-c[2])&&(h=t)},this),n.delegate.handleSelectedNode(h)}else for(r=0;this.__nonOpaquePassesWithPrimitives.length>r;r++){var s=this.__nonOpaquePassesWithPrimitives[r];t.renderPrimitivesWithPass(s.primitives,s.pass,null,e)}}}},scene:{get:function(){return this._scene},set:function(t){this._scene!=t&&(this.sceneWillChange(this._scene,t),this._scene=t,this.sceneDidChange())}},_pickingPass:{value:null,writable:!0},pickingPass:{get:function(){return this._pickingPass},set:function(t){this._pickingPass=t,this._pickingPass.id="__PickingPass",this._pickingPass.extras.nodeIDToColor={}}},_pickingTechnique:{value:null,writable:!0},pickingTechnique:{get:function(){return this._pickingTechnique},set:function(t){this._pickingTechnique=t,this.pickingPass=this._pickingTechnique.rootPass}},_pickingRenderTarget:{value:null,writable:!0},pickingRenderTarget:{get:function(){return this._pickingRenderTarget},set:function(t){this._pickingRenderTarget=t}},createPickingRenderTargetIfNeeded:{value:function(){return this._pickingRenderTarget||(this._pickingRenderTarget=Object.create(RenderTarget).init(),this._pickingRenderTarget.attachments.push({semantic:"COLOR_ATTACHMENT0",parameter:"__pickingTexture"}),this._pickingRenderTarget.attachments.push({semantic:"DEPTH_ATTACHMENT",parameter:"__pickingRenderBuffer"}),this.pickingRenderTarget.extras.picking=!0),this._pickingRenderTarget}},init:{value:function(){return this.pickingRenderTarget=this.createPickingRenderTargetIfNeeded(),this.pickingRenderTarget.width=512,this.pickingRenderTarget.height=512,this._nodeWrappers={},this}}}),ScenePass=exports.ScenePass=Object.create(Pass,{_scenePassRenderer:{value:null,writable:!0},createScenePassRendererIfNeeded:{value:function(){this._scenePassRenderer||(this._scenePassRenderer=Object.create(ScenePassRenderer).init())}},scenePassRenderer:{get:function(){return this.createScenePassRendererIfNeeded(),this._scenePassRenderer},set:function(t){this.createScenePassRendererIfNeeded(),this._scenePassRenderer!=t&&(this._scenePassRenderer=t)}},viewPoint:{get:function(){return this.scenePassRenderer?this.scenePassRenderer.viewPoint:null},set:function(t){this.scenePassRenderer&&(this.scenePassRenderer.viewPoint=t)}},scene:{get:function(){return this.scenePassRenderer.scene},set:function(t){this.scenePassRenderer.scene=t}},execute:{value:function(t,e,n){this.scenePassRenderer.render(t,e,n)}},init:{value:function(){return this._type=Pass.SCENE,this.extras={},this}}});