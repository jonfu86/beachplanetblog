montageDefine("3d2b056","runtime/transform",{dependencies:["runtime/dependencies/gl-matrix","runtime/base","runtime/utilities"],factory:function(t,e){t("runtime/dependencies/gl-matrix");var n=t("runtime/base").Base,i=t("runtime/utilities").Utilities,r=e.Transform=Object.create(n,{_matrix:{value:null,writable:!0},_dirty:{value:!0,writable:!0},_dirtyTranslation:{value:!1,writable:!0},_dirtyRotation:{value:!1,writable:!0},_dirtyScale:{value:!1,writable:!0},_translation:{value:null,writable:!0},_orientation:{value:null,writable:!0},_rotation:{value:null,writable:!0},_scale:{value:null,writable:!0},_id:{value:0,writable:!0},_AXIS_ANGLE:{value:1,writable:!0},_QUATERNION:{value:2,writable:!0},_rotationMode:{value:1,writable:!0},_fireTransformDidUpdate:{value:function(){if(this._observers)for(var t=0;this._observers.length>t;t++)this._observers[t].transformDidUpdate(this)}},_updateDirtyFlag:{value:function(t){this._dirty=t,this._fireTransformDidUpdate()}},interpolateToTransform:{value:function(t,e,n){if(this._rebuildAffinesIfNeeded(),t._rebuildAffinesIfNeeded(),i.interpolateVec(this._translation,t._translation,e,n._translation),i.interpolateVec(this._scale,t._scale,e,n._scale),t._rotationMode===r._AXIS_ANGLE){var a=vec4.create();this._rotationMode==r._QUATERNION&&(this.rotation=vec4.createFrom(t._rotation[0],t._rotation[1],t._rotation[2],-this.rotation[3])),i.interpolateVec(this.rotation,t._rotation,e,a),n.rotation=a}else{var s=vec4.create();quat4.slerp(this.orientation,t.orientation,e,s),n.orientation=s}n._updateDirtyFlag(!0)}},matrix:{get:function(){return this._dirty&&(null==this._matrix&&(this._matrix=mat4.create()),null==this._intermediateMatrices&&(this._intermediateMatrices=[],this._intermediateMatrices.push(mat4.identity()),this._intermediateMatrices.push(mat4.identity()),this._intermediateMatrices.push(mat4.identity()),this._intermediateMatrices.push(mat4.identity())),mat4.identity(this._matrix),mat4.identity(this._intermediateMatrices[0]),mat4.set(this._intermediateMatrices[0],this._intermediateMatrices[1]),mat4.set(this._intermediateMatrices[0],this._intermediateMatrices[2]),mat4.set(this._intermediateMatrices[0],this._intermediateMatrices[3]),mat4.translate(this._intermediateMatrices[1],this._translation),mat4.scale(this._intermediateMatrices[2],this._scale),this._rotationMode===r._AXIS_ANGLE?(mat4.identity(this._intermediateMatrices[3]),mat4.rotate(this._intermediateMatrices[3],this._rotation[3],this._rotation)):quat4.toMat4(this._orientation,this._intermediateMatrices[3]),mat4.multiply(this._matrix,this._intermediateMatrices[1]),mat4.multiply(this._matrix,this._intermediateMatrices[2]),mat4.multiply(this._matrix,this._intermediateMatrices[3]),this._dirty=!1),this._matrix},set:function(t){null==this._matrix&&(this._matrix=mat4.create()),mat4.set(t,this._matrix),this._updateDirtyFlag(!1),this._dirtyTranslation=this._dirtyRotation=this._dirtyScale=!0,this._rotationMode=this._QUATERNION}},_rebuildAffinesIfNeeded:{value:function(){(this._dirtyTranslation||this._dirtyRotation||this._dirtyScale)&&(i.decomposeMat4(this.matrix,this._dirtyTranslation?this._translation:null,this._dirtyRotation?this._orientation:null,this._dirtyScale?this._scale:null),this._dirtyTranslation=this._dirtyRotation=this._dirtyScale=!1,this._rotationMode==r._AXIS_ANGLE?this.rotation=vec4.create(this.rotation):this.orientation=vec4.create(this.orientation))}},translation:{set:function(t){this._translation=t,this._dirtyTranslation=!1,this._updateDirtyFlag(!0)},get:function(){return this._dirtyTranslation&&this._rebuildAffinesIfNeeded(),this._translation}},orientation:{set:function(t){this._dirtyRotation=!1,this._rotationMode=r._QUATERNION,this._orientation=t,this._updateDirtyFlag(!0)},get:function(){return this._dirtyRotation&&this._rebuildAffinesIfNeeded(),this._rotationMode!==r._QUATERNION&&quat4.fromAngleAxis(this._rotation[3],this._rotation,this._orientation),this._orientation}},rotation:{set:function(t){this._dirtyRotation=!1,this._rotationMode=r._AXIS_ANGLE,this._rotation=t,this._updateDirtyFlag(!0)},get:function(){return this._dirtyRotation&&this._rebuildAffinesIfNeeded(),this._rotationMode!==r._AXIS_ANGLE&&quat4.toAngleAxis(this._orientation,this._rotation),this._rotation}},scale:{set:function(t){this._dirtyScale=!1,this._scale=t,this._updateDirtyFlag(!0)},get:function(){return this._dirtyScale&&this._rebuildAffinesIfNeeded(),this._scale}},_commonInit:{value:function(){this.translation=vec3.createFrom(0,0,0),this.rotation=vec4.createFrom(0,0,0,0),this.orientation=vec4.createFrom(0,0,0,0),this.scale=vec3.createFrom(1,1,1),this.matrix=mat4.identity(),this._id=r.bumpId()}},initWithDescription:{value:function(t){return this._commonInit(),t.matrix?this.matrix=mat4.create(t.matrix):t.translation||t.rotation||t.scale?(this.translation=t.translation?vec3.create(t.translation):vec3.createFrom(0,0,0),t.rotation?this.orientation=quat4.fromAngleAxis(t.rotation[3],vec3.createFrom(t.rotation[0],t.rotation[1],t.rotation[2])):t.orientation&&(this.orientation=quat4.create(t.orientation)),this.scale=t.scale?vec3.create(t.scale):vec3.createFrom(1,1,1)):this.matrix=mat4.identity(),this}},init:{value:function(){return this._commonInit(),this}},bumpId:{value:function(){return r._id++,r._id}},copy:{value:function(){var t=Object.create(r).init();return null!=this._translation&&(t.translation=vec3.create(this._translation)),null!=this._scale&&(t.scale=vec3.create(this._scale)),null!=this._orientation&&(t.orientation=quat4.create(this._orientation)),null!=this._rotation&&(t.rotation=vec4.create(this._rotation)),t.matrix=mat4.create(this.matrix),t}},_observers:{value:null,writable:!0},addObserver:{value:function(t){null==this._observers&&(this._observers=[]),-1===this._observers.indexOf(t)?this._observers.push(t):console.log("WARNING attempt to add 2 times the same observer in transform")}},removeObserver:{value:function(t){if(this._observers){var e=this._observers.indexOf(t);-1!==e&&this._observers.splice(e,1)}}}})}});