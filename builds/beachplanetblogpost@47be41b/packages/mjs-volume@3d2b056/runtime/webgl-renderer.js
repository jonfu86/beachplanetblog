require("runtime/dependencies/gl-matrix");var GLSLProgram=require("runtime/glsl-program").GLSLProgram,WebGLTFResourceManager=require("runtime/helpers/resource-manager").WebGLTFResourceManager;exports.WebGLRenderer=Object.create(Object.prototype,{MODEL:{value:"MODEL",writable:!1},VIEW:{value:"VIEW",writable:!1},PROJECTION:{value:"PROJECTION",writable:!1},MODELVIEW:{value:"MODELVIEW",writable:!1},VIEWPROJECTION:{value:"VIEWPROJECTION",writable:!1},MODELVIEWPROJECTION:{value:"MODELVIEWPROJECTION",writable:!1},MODELINVERSE:{value:"MODELINVERSE",writable:!1},VIEWINVERSE:{value:"VIEWINVERSE",writable:!1},PROJECTIONINVERSE:{value:"PROJECTIONINVERSE",writable:!1},MODELVIEWINVERSE:{value:"MODELVIEWINVERSE",writable:!1},VIEWPROJECTIONINVERSE:{value:"VIEWPROJECTIONINVERSE",writable:!1},MODELVIEWPROJECTIONINVERSE:{value:"MODELVIEWPROJECTIONINVERSE",writable:!1},MODELTRANSPOSE:{value:"MODELTRANSPOSE",writable:!1},VIEWTRANSPOSE:{value:"VIEWTRANSPOSE",writable:!1},PROJECTIONTRANSPOSE:{value:"PROJECTIONTRANSPOSE",writable:!1},MODELVIEWTRANSPOSE:{value:"MODELVIEWTRANSPOSE",writable:!1},VIEWPROJECTIONTRANSPOSE:{value:"VIEWPROJECTIONTRANSPOSE",writable:!1},MODELVIEWPROJECTIONTRANSPOSE:{value:"MODELVIEWPROJECTIONTRANSPOSE",writable:!1},MODELINVERSETRANSPOSE:{value:"MODELINVERSETRANSPOSE",writable:!1},VIEWINVERSETRANSPOSE:{value:"VIEWINVERSETRANSPOSE",writable:!1},PROJECTIONINVERSETRANSPOSE:{value:"PROJECTIONINVERSETRANSPOSE",writable:!1},MODELVIEWINVERSETRANSPOSE:{value:"MODELVIEWINVERSETRANSPOSE",writable:!1},VIEWPROJECTIONINVERSETRANSPOSE:{value:"VIEWPROJECTIONINVERSETRANSPOSE",writable:!1},MODELVIEWPROJECTIONINVERSETRANSPOSE:{value:"MODELVIEWPROJECTIONINVERSETRANSPOSE",writable:!1},_bindedProgram:{value:null,writable:!0},_debugProgram:{value:null,writable:!0},_resourceManager:{value:null,writable:!0},_webGLContext:{value:null,writable:!0},_projectionMatrix:{value:null,writable:!0},shininess:{value:200,writable:!0},light:{value:[0,0,-1],writable:!0},specularColor:{value:[1,1,1],writable:!0},GLContextDidChange:{value:function(){}},initWithWebGLContext:{value:function(t){return this.webGLContext=t,this._states={},this}},bindedProgram:{get:function(){return this._bindedProgram},set:function(t){this._bindedProgram!==t&&this._webGLContext&&(this._bindedProgram=t,this._bindedProgram&&this._bindedProgram.use(this._webGLContext,!1))}},projectionMatrix:{get:function(){return this._projectionMatrix},set:function(t){this._projectionMatrix=t}},debugProgram:{get:function(){if(!this._debugProgram){this._debugProgram=Object.create(GLSLProgram);var t="precision highp float;attribute vec3 vert;uniform mat4 u_mvMatrix; uniform mat4 u_projMatrix; void main(void) { gl_Position = u_projMatrix * u_mvMatrix * vec4(vert,1.0); }",e="precision highp float;void main(void) { gl_FragColor = vec4(1.,0.,0.,1.); }";this._debugProgram.initWithShaders({"x-shader/x-vertex":t,"x-shader/x-fragment":e}),this._debugProgram.build(this.webGLContext)||console.log(this._debugProgram.errorLogs)}return this._debugProgram}},webGLContext:{get:function(){return this._webGLContext},set:function(t){this._webGLContext=t,this.GLContextDidChange()}},resourceManager:{get:function(){return this._resourceManager||(this._resourceManager=Object.create(WebGLTFResourceManager),this._resourceManager.init()),this._resourceManager}},indicesDelegate:{value:{webGLContext:{value:null,writable:!0},handleError:function(t,e){console.log("ERROR:vertexAttributeBufferDelegate:"+t+" :"+e)},convert:function(t,e,n){var i=n,r=i.getParameter(i.ELEMENT_ARRAY_BUFFER_BINDING),a=i.createBuffer();return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r),a},resourceAvailable:function(){}}},setupCompressedMesh:{value:function(t,e,n){var i=t.primitives[0],r=this.webGLContext,a=r.getParameter(r.ELEMENT_ARRAY_BUFFER_BINDING),s=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a),s.count=n.length,this.resourceManager.setResource(i.indices.id,s),i.indices={id:i.indices.id,count:s.count};var o,l=e.length/8,c=new Float32Array(3*l),h=new Float32Array(3*l),u=new Float32Array(2*l);for(o=0;l>o;o++){var p=8*o;c[3*o+0]=e[p+0],c[3*o+1]=e[p+1],c[3*o+2]=e[p+2],h[3*o+0]=e[p+5],h[3*o+1]=e[p+6],h[3*o+2]=e[p+7],u[2*o+0]=e[p+3],u[2*o+1]=e[p+4]}a=r.getParameter(r.ARRAY_BUFFER_BINDING),s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,c,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=3,this.resourceManager.setResource(i.semantics.POSITION.id,s),i.semantics.POSITION={id:i.semantics.POSITION.id,count:l,byteStride:12},s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,h,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=3,this.resourceManager.setResource(i.semantics.NORMAL.id,s),i.semantics.NORMAL={id:i.semantics.NORMAL.id,count:l,byteStride:12},u.length>0&&(s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,u,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=2,this.resourceManager.setResource(i.semantics.TEXCOORD_0.id,s),i.semantics.TEXCOORD_0={id:i.semantics.TEXCOORD_0.id,count:l,byteStride:8}),r.bindBuffer(r.ARRAY_BUFFER,a)}},setupCompressedMesh2:{value:function(t,e,n,i,r,a,s){for(var o=this.webGLContext,l=0,c=0,h=t.primitives,u=0;h.length>u;u++){var p=t.primitives[u],d=p.indices.id;l=p.indices.count;var m=new Int16Array(s.subarray(c,c+l)),g=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,g),o.bufferData(o.ELEMENT_ARRAY_BUFFER,m,o.STATIC_DRAW),this.resourceManager.setResource(d,g),g.count=l,p.indices={id:d,count:g.count},c+=l}for(var f,v={},u=0;h.length>u;u++){var p=t.primitives[u];for(f in p.semantics){var _=p.semantics[f];v[_.baseId]=f}}for(var y in v){var C=a[y];if(null!=C){var L=r.GetFloatAttribute(C),f=v[y];if("JOINT"===f)for(var b=0;L.length>b;b++)L[b]=Math.floor(L[b]+.5);var x=r.GetFloatAttributeDim(C);g=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,g),o.bufferData(o.ARRAY_BUFFER,L,o.STATIC_DRAW),g.componentType=o.FLOAT,g.componentsPerAttribute=x,this.resourceManager.setResource(p.semantics[f].id,g),p.semantics[f]={id:p.semantics[f].id,count:l,byteStride:4*x}}}l=e,previousBuffer=o.getParameter(o.ARRAY_BUFFER_BINDING),g=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,g),o.bufferData(o.ARRAY_BUFFER,n,o.STATIC_DRAW),g.componentType=o.FLOAT,g.componentsPerAttribute=3,this.resourceManager.setResource(p.semantics.POSITION.id,g),p.semantics.POSITION={id:p.semantics.POSITION.id,count:l,byteStride:12},null!=i&&(g=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,g),o.bufferData(o.ARRAY_BUFFER,i,o.STATIC_DRAW),g.componentType=o.FLOAT,g.componentsPerAttribute=3,this.resourceManager.setResource(p.semantics.NORMAL.id,g),p.semantics.NORMAL={id:p.semantics.NORMAL.id,count:l,byteStride:12}),o.bindBuffer(o.ARRAY_BUFFER,previousBuffer)}},vertexAttributeBufferDelegate:{value:{_componentTypeForGLType:function(t,e){switch(e){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:return t.FLOAT;case t.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case t.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;default:return null}},_componentsPerElementForGLType:function(t,e){switch(e){case t.FLOAT:case t.UNSIGNED_BYTE:case t.UNSIGNED_SHORT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:return 4;default:return null}},webGLContext:{value:null,writable:!0},handleError:function(t,e){console.log("ERROR:vertexAttributeBufferDelegate:"+t+" :"+e)},convert:function(t,e,n){var i=t,r=n,a=r.getParameter(r.ARRAY_BUFFER_BINDING),s=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW),s.componentType=this._componentTypeForGLType(r,i.type),s.componentsPerAttribute=this._componentsPerElementForGLType(r,i.type),r.bindBuffer(r.ARRAY_BUFFER,a),s},resourceAvailable:function(){}}},textureDelegate:{value:{getGLFilter:function(t){return null==t?WebGLRenderingContext.prototype.LINEAR:t},getGLWrapMode:function(t){return null==t?WebGLRenderingContext.prototype.REPEAT:t},handleError:function(t,e){console.log("ERROR:textureDelegate:"+t+" :"+e)},nextHighestPowerOfTwo:function(t){--t;for(var e=1;32>e;e<<=1)t|=t>>e;return t+1},isPowerOfTwo:function(t){return 0==(t&t-1)},installCubemapSide:function(t,e,n,i){t.bindTexture(t.TEXTURE_CUBE_MAP,n),t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},createTextureFromImageAndSampler:function(t,e,n){var i=n.getParameter(n.ACTIVE_TEXTURE),r=n.getParameter(n.TEXTURE_BINDING_2D);n.activeTexture(n.TEXTURE0);var a=null,s=this.getGLFilter(e.minFilter),o=this.getGLFilter(e.magFilter),l=this.getGLWrapMode(e.wrapS),c=this.getGLWrapMode(e.wrapT),h=!1,u=s===n.NEAREST_MIPMAP_NEAREST||s===n.LINEAR_MIPMAP_NEAREST||s===n.NEAREST_MIPMAP_LINEAR||s===n.LINEAR_MIPMAP_LINEAR;if(u||l===n.REPEAT||c===n.REPEAT){var p=parseInt(t.width),d=parseInt(t.height);if(this.isPowerOfTwo(p)||(p=this.nextHighestPowerOfTwo(p),h=!0),this.isPowerOfTwo(d)||(d=this.nextHighestPowerOfTwo(d),h=!0),h){a=document.createElement("canvas"),a.width=p,a.height=d;var m=a.getContext("2d");m.drawImage(t,0,0,parseInt(a.width),parseInt(a.height)),a.id=t.id,t=a}}var g=n.createTexture();return g.contextID=n.contextID,n.bindTexture(n.TEXTURE_2D,g),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,l),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,c),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),u&&n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,r),n.activeTexture(i),g},convert:function(t,e,n){var i=n;if(t){if(6===t.length){var r=i.createTexture();return i.bindTexture(i.TEXTURE_CUBE_MAP,r),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_POSITIVE_X,r,t[0]),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_NEGATIVE_X,r,t[1]),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_POSITIVE_Y,r,t[2]),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,t[3]),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_POSITIVE_Z,r,t[4]),this.installCubemapSide(i,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,t[5]),r}}else if("video"==t.type){e.source.videoElement=t;var a=i.createTexture();return i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e.source.videoElement),i.bindTexture(i.TEXTURE_2D,null),a}return this.createTextureFromImageAndSampler(t,e.sampler,i)},resourceAvailable:function(){}}},_lastMaxEnabledArray:{value:0,writable:!0},_states:{value:null,writable:!0},setState:{value:function(t,e,n){var i=this.webGLContext;(null==this._states[t]||1==n||this._states[t]!==e)&&(this._states[t]=e,e?i.enable(t):i.disable(t))}},resetStates:{value:function(){var t=this.webGLContext;if(t&&-1!==this._lastMaxEnabledArray)for(var e=0;this._lastMaxEnabledArray>e;e++)t.disableVertexAttribArray(e);this._lastMaxEnabledArray=-1,this.bindedProgram=null,this.setState(t.BLEND,!1)}},renderPrimitive:{value:function(t,e,n,i){var r=!1,a=null,s=t.primitive;t.node&&t.node.instanceSkin&&t.node.instanceSkin.skin.process(t.node,this.resourceManager);var o,l=-1,c=this.webGLContext,h=this.bindedProgram,u=0;i||(i=s.material.parameters);var p=h.uniformSymbols;for(o=0;p.length>o;o++){var d=p[o],m=e.instanceProgram.uniforms[d];if(a=null,m=i[m],m&&null!=m.semantic){var g=t.nodeWrapper;m.source&&(g=t.nodeWrapper.scenePassRenderer._nodeWrappers[m.source.id]);var f=m.semantic;f===this.PROJECTION?a=this.projectionMatrix:f===this.MODELVIEW?a=g.worldViewMatrix:f===this.MODELVIEWINVERSETRANSPOSE?a=g.worldViewInverseTransposeMatrix:f===this.MODELVIEWINVERSE&&(a=g.worldViewInverseMatrix)}if(null==a&&null!=m)if(m.source&&null==f){var g=t.nodeWrapper.scenePassRenderer._nodeWrappers[m.source.id];a=g.worldViewMatrix}else a=m.value;var v=null;if(null!=a){var _=h.getTypeForSymbol(d),y=_===c.SAMPLER_CUBE,C=_===c.SAMPLER_2D;if(y){if(v=this.resourceManager.getResource(a,this.textureDelegate,this.webGLContext)){c.activeTexture(c.TEXTURE0+u),c.bindTexture(c.TEXTURE_CUBE_MAP,v);var L=h.getLocationForSymbol(d);L!==void 0&&(h.setValueForSymbol(d,u),u++)}}else if(C){if(v=this.resourceManager.getResource(a,this.textureDelegate,this.webGLContext),null!=v){c.activeTexture(c.TEXTURE0+u),c.bindTexture(c.TEXTURE_2D,v),m.value.source.videoElement&&m.value.source.timeStamp!=n&&(c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,m.value.source.videoElement),m.value.source.timeStamp=n);var L=h.getLocationForSymbol(d);L!==void 0&&(h.setValueForSymbol(d,u),u++)}}else h.setValueForSymbol(d,a)}}h.commit(c);var b=0,x=e.instanceProgram.attributes,w=h.attributeSymbols;for(o=0;w.length>o;o++){var d=w[o],m=x[d];m=i[m];var f=m.semantic,M=s.semantics[f],S=null;if(S=t.compressed?this.resourceManager._getResource(M.id):this.resourceManager.getResource(M,this.vertexAttributeBufferDelegate,this.webGLContext)){c.bindBuffer(c.ARRAY_BUFFER,S);var T=h.getLocationForSymbol(d);T!==void 0&&(T>l&&(l=T),c.enableVertexAttribArray(T),c.vertexAttribPointer(T,S.componentsPerAttribute,S.componentType,!1,M.byteStride,0),r&&"POSITION"==f&&c.drawArrays(c.POINTS,0,M.count)),b++}else this._lastMaxEnabledArray=-1}var z=b===w.length;if(!r){if(z)for(var o=l+1;this._lastMaxEnabledArray>o;o++)c.disableVertexAttribArray(o);var E=null;E=t.compressed?this.resourceManager._getResource(s.indices.id):this.resourceManager.getResource(s.indices,this.indicesDelegate,this.webGLContext),E&&z&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,E),c.drawElements(c.TRIANGLES,s.indices.count,c.UNSIGNED_SHORT,0))}return this._lastMaxEnabledArray=l,z}},programDelegate:{value:{handleError:function(t,e){console.log("ERROR:programDelegate:"+t+" :"+e)},convert:function(t,e,n){var i=n,r=Object.create(GLSLProgram);return r.initWithShaders(e),r.build(i)||(console.log(e),console.log(r.errorLogs)),r},resourceAvailable:function(){}}},bindRenderTarget:{value:function(t){var e=this.webGLContext,n=t.FBO?!1:!0;t.previousFBO=e.getParameter(e.FRAMEBUFFER_BINDING),t.FBO||(t.FBO=e.createFramebuffer(),n=!0),e.bindFramebuffer(e.FRAMEBUFFER,t.FBO);var i=t.extras,r=e.drawingBufferWidth!=t.width||e.drawingBufferHeight!=t.height,a=e.drawingBufferWidth,s=e.drawingBufferHeight;(n||r)&&t.attachments.forEach(function(t){if("COLOR_ATTACHMENT0"==t.semantic&&i.picking){var o=e.getParameter(e.TEXTURE_BINDING_2D);n&&(i.pickingTexture=e.createTexture()),r&&(e.bindTexture(e.TEXTURE_2D,i.pickingTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,s,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)),n&&e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i.pickingTexture,0),e.bindTexture(e.TEXTURE_2D,o)}if("DEPTH_ATTACHMENT"==t.semantic&&i.picking){var l=e.getParameter(e.RENDERBUFFER_BINDING);n&&(i.pickingRenderBuffer=e.createRenderbuffer()),r&&(e.bindRenderbuffer(e.RENDERBUFFER,i.pickingRenderBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a,s)),n&&e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,i.pickingRenderBuffer),e.bindRenderbuffer(e.RENDERBUFFER,l)}},this),e.clearColor(0,0,0,1),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT)}},unbindRenderTarget:{value:function(t){var e=this.webGLContext;t.extras.picking&&(t.extras.pickedPixel||(t.extras.pickedPixel=new Uint8Array(4)),e.finish(),e.readPixels(t.extras.coords[0],t.extras.coords[1],1,1,e.RGBA,e.UNSIGNED_BYTE,t.extras.pickedPixel)),e.bindFramebuffer(e.FRAMEBUFFER,t.previousFBO);var n=!1;n&&t.attachments.forEach(function(e){"COLOR_ATTACHMENT0"===e.semantic&&t.extras.picking&&this.drawTexture(t.extras.pickingTexture)},this)}},renderPrimitivesWithPass:{value:function(t,e,n,i){var r=t.length,a=this.webGLContext;if(e.instanceProgram){var s=a,o=this.resourceManager.getResource(e.instanceProgram.program,this.programDelegate,s);if(o){var l=0,c=1,h=1,u=1,p=e.states,d=a.FUNC_ADD,m=a.SRC_ALPHA,g=a.ONE_MINUS_SRC_ALPHA,f="__PickingPass"===e.id;if(p&&(null!=p.blendEnable&&(l=p.blendEnable),null!=p.depthTestEnable&&(c=p.depthTestEnable),null!=p.depthMask&&(h=p.depthMask),null!=p.cullFaceEnable&&(u=p.cullFaceEnable),null!=p.blendEquation)){var v=p.blendFunc;null!=v&&(null!=v.sfactor&&(m=v.sfactor),null!=v.dfactor&&(g=v.dfactor))}if(this.setState(a.DEPTH_TEST,c),this.setState(a.CULL_FACE,u),a.enable(a.SAMPLE_ALPHA_TO_COVERAGE),a.depthMask(h),this.setState(a.BLEND,l),1===l&&(a.blendEquation(d),a.blendFunc(m,g)),this.bindedProgram=o,f)for(var _=0;r>_;_++){var y=t[_];if(!y.node.hidden){if(!y.pickingColor){var C=y.node.baseId;if(C){var L=e.extras.nodeIDToColor[C];L||(L=vec4.createFrom(Math.random(),Math.random(),Math.random(),1),e.extras.nodeIDToColor[C]=L),y.pickingColor=L}}this.bindedProgram.setValueForSymbol("u_pickingColor",y.pickingColor),this.renderPrimitive(y,e,i,n)}}else for(var _=0;r>_;_++){var y=t[_];if(!y.node.hidden){var b=1;n=y.primitive.material.parameters;var x=n.transparency;x&&null!=x.value&&(b*=x.value);var w=n.filterColor;w&&null!=w.value&&(b*=w.value[3]),1e-5>b||(1>b&&!l?(this.setState(a.BLEND,!0),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.renderPrimitive(y,e,i),this.setState(a.BLEND,!1)):this.renderPrimitive(y,e,i))}}}}}},_BBOXProgram:{value:null,writable:!0},drawBBOX:{value:function(t,e,n,i){if(null!=t){var r=this.webGLContext;if(this.bindedProgram=null,this.setState(r.CULL_FACE,!1),!this._BBOXProgram){this._BBOXProgram=Object.create(GLSLProgram);var a="precision highp float;attribute vec3 vert;uniform mat4 u_projMatrix; uniform mat4 u_vMatrix; uniform mat4 u_mMatrix; void main(void) { gl_Position = u_projMatrix * u_vMatrix * u_mMatrix * vec4(vert,1.0); }",s="precision highp float;uniform float u_transparency;  void main(void) {  gl_FragColor = vec4(vec3(1.,1.,1.) , u_transparency);}";this._BBOXProgram.initWithShaders({"x-shader/x-vertex":a,"x-shader/x-fragment":s}),this._BBOXProgram.build(r)||console.log(this._BBOXProgram.errorLogs)}var o=[t[0][0],t[0][1],t[0][2]],l=[t[1][0],t[1][1],t[1][2]],c=0,h=1,u=2;if(!this._BBOXIndices){var p=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,3,7,2,6,0,4,1,5];this._BBOXIndices=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(p),r.STATIC_DRAW)}r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),this._BBOXVertexBuffer||(this._BBOXVertexBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this._BBOXVertexBuffer)),r.bindBuffer(r.ARRAY_BUFFER,this._BBOXVertexBuffer);var d=[l[c],o[h],o[u],l[c],l[h],o[u],o[c],l[h],o[u],o[c],o[h],o[u],l[c],o[h],l[u],l[c],l[h],l[u],o[c],l[h],l[u],o[c],o[h],l[u]];r.bufferData(r.ARRAY_BUFFER,new Float32Array(d),r.STATIC_DRAW);var m=this._BBOXProgram.getLocationForSymbol("vert");null!=m&&(r.enableVertexAttribArray(m),r.vertexAttribPointer(m,3,r.FLOAT,!1,12,0)),this.bindedProgram=this._BBOXProgram;var g=this._BBOXProgram.getLocationForSymbol("u_projMatrix");g&&this._BBOXProgram.setValueForSymbol("u_projMatrix",i);var f=this._BBOXProgram.getLocationForSymbol("u_mMatrix");f&&this._BBOXProgram.setValueForSymbol("u_mMatrix",n);var v=this._BBOXProgram.getLocationForSymbol("u_vMatrix");v&&this._BBOXProgram.setValueForSymbol("u_vMatrix",e);var _=this._BBOXProgram.getLocationForSymbol("u_transparency");_&&this._BBOXProgram.setValueForSymbol("u_transparency",1),this._BBOXProgram.commit(r),r.drawElements(r.LINES,24,r.UNSIGNED_SHORT,0),r.disableVertexAttribArray(m),this.setState(r.BLEND,!1),this.setState(r.CULL_FACE,!0)}}},drawTexture:{value:function(t){var e=this.webGLContext,n=e.isEnabled(e.DEPTH_TEST),i=e.isEnabled(e.CULL_FACE),r=e.isEnabled(e.BLEND);if(this.setState(e.DEPTH_TEST,0),this.setState(e.CULL_FACE,0),this.setState(e.BLEND,0),!this.displayTexture){this.displayTexture={},this.displayTexture.program=Object.create(GLSLProgram);var a="precision highp float;attribute vec3 vert;attribute vec2 uv;uniform mat4 u_projMatrix; varying vec2 v_uv;void main(void) { v_uv = uv;gl_Position = u_projMatrix * vec4(vert,1.0); }",s="precision highp float;uniform sampler2D u_texture;varying vec2 v_uv; void main(void) {  vec4 color = texture2D(u_texture, v_uv);  gl_FragColor = color; }";this.displayTexture.program.initWithShaders({"x-shader/x-vertex":a,"x-shader/x-fragment":s}),this.displayTexture.program.build(e)||console.log(this.displayTexture.program.errorLogs);var o=[-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,-1,1,0,0,1,1,-1,0,1,0,1,1,0,1,1];this.displayTexture.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.displayTexture.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW)}var l=this.displayTexture.program,c=this.displayTexture.vertexBuffer;e.bindBuffer(e.ARRAY_BUFFER,c);var h=mat4.ortho(-1,1,-1,1,0,1e3),u=l.getLocationForSymbol("vert"),p=u!==void 0;p&&(e.enableVertexAttribArray(u),e.vertexAttribPointer(u,3,e.FLOAT,!1,20,0));var d=l.getLocationForSymbol("uv"),m=d!==void 0;m&&(e.enableVertexAttribArray(d),e.vertexAttribPointer(d,2,e.FLOAT,!1,20,12));var g=e.getParameter(e.TEXTURE_BINDING_2D);e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),this.bindedProgram=l;var f=l.getLocationForSymbol("u_projMatrix");f&&l.setValueForSymbol("u_projMatrix",h);var v=l.getLocationForSymbol("u_texture");v&&l.setValueForSymbol("u_texture",0),l.commit(e),e.drawArrays(e.TRIANGLES,0,6),e.bindTexture(e.TEXTURE_2D,g),p&&e.disableVertexAttribArray(u),m&&e.disableVertexAttribArray(d),this.setState(e.DEPTH_TEST,n),this.setState(e.CULL_FACE,i),this.setState(e.BLEND,r)}}});