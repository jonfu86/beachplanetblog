montageDefine("3d2b056","runtime/scene",{dependencies:["montage","runtime/node","montage/core/uuid","runtime/runtime-tf-loader","url","runtime/scene-resource-loader","q","montage/core/target","cssom"],factory:function(t,e){var n=t("montage").Montage,i=t("runtime/node").Node,r=t("montage/core/uuid"),a=t("runtime/runtime-tf-loader").RuntimeTFLoader,s=t("url"),o=t("runtime/scene-resource-loader").SceneResourceLoader,l=t("q"),c=t("montage/core/target").Target,h=t("cssom");e.Scene=c.specialize({constructor:{value:function(){this.super()}},_resourcesLoaded:{value:!1,writable:!0},_glTFElement:{value:null,writable:!0},shouldBeHitTested:{value:!1,writable:!0},glTFElement:{get:function(){return this._glTFElement},set:function(t){this._glTFElement=t}},_rootNode:{value:null,writable:!0},rootNode:{get:function(){return"loaded"===this.status&&null==this._rootNode&&(this._rootNode=n.create(i),this._rootNode.scene=this,this._rootNode.id=this.glTFElement.rootNode.id),this._rootNode}},sceneResourcesDidPrepare:{value:function(){this._resourcesLoaded||(this._prepareToRenderDefer&&this._prepareToRenderDefer.resolve(),this._resourcesLoaded=!0,this.dispatchEventNamed("resourcesDidLoad",!0,!1,this),this.status="loaded")}},isLoaded:{value:function(){return"loaded"==this.status}},status:{value:0,writable:!0},styleSheetsLoaded:{value:!1,writable:!0},styleSheets:{value:null,writable:!0},loadCSSStyles:{value:function(){if(null!=document.styleSheets){var e,n,i=Object.keys(t.packages),r=0,a=document.styleSheets.length,s=[];for(this.styleSheets={},e=0;a>e;e++)n=document.styleSheets[e],null!=n.href?-1!=n.href.indexOf(i[0])&&-1==n.href.indexOf(i[0]+"node_modules")&&s.push(n):n.ownerNode&&n.ownerNode.innerText&&this._addStyleSheets(n.ownerNode.innerText);return a=s.length,0===a?(this.styleSheetsLoaded=!0,void 0):(s.forEach(function(t){var e=this,n=t.href,i=new XMLHttpRequest;i.open("GET",n,!0),i.onreadystatechange=function(){4==i.readyState&&200==i.status&&(e._addStyleSheets(i.responseText,t.href),r++,r===a&&e.dispatchEventNamed("styleSheetsDidLoad",!0,!1,e))},i.send(null)},this),!1)}}},_addStyleSheets:{value:function(t,e){e||(e=r.generate()),this.styleSheets[e]=h.parse(t)}},deserializedFromTemplate:{value:function(t,e,n){this._ownerDocumentPart=n}},_pendingLoading:{value:!1},_loadScene:{value:function(){var e={};if(e.loadCompleted=function(t){this.totalBufferSize=o.totalBufferSize,this.glTFElement=t,this.status="loaded",console.log("scene loaded:"+this._path)}.bind(this),null!=this._path){var n=this._path,i=s.parse(n);if("/"===n[0])n=n.substr(1),n=s.resolve(t.packages[0],n);else if(!i.scheme){if(null==this._ownerDocumentPart)return;var r=this._ownerDocumentPart.template.getBaseUrl();n=s.resolve(r,n)}var o=Object.create(a);this.status="loading",o.initWithPath(n),o.delegate=e,o.load(null,null)}1==this._pendingLoading&&(this.removePathChangeListener("_ownerDocumentPart",this),this._pendingLoading=!1)}},path:{set:function(t){if((!t||-1!==t.indexOf(".json"))&&t!==this._path)if(this._path=t,null==t)this.scene=null;else{var e=t.length>0&&"/"===t[0];0==e&&null==this._ownerDocumentPart?0==this._pendingLoading&&(this.addPathChangeListener("_ownerDocumentPart",this,"_loadScene"),this._pendingLoading=!0):this._loadScene()}},get:function(){return this._path}},_prepareToRenderDefer:{value:null,writable:!0},prepareToRender:{value:function(t){if(null==this._prepareToRenderDefer){this._prepareToRenderDefer=l.defer();var e=Object.create(o).init(this.glTFElement,t,this);e.loadScene()}return this._prepareToRenderDefer.promise}},init:{value:function(t){return t&&(this.glTFElement=t,this.status="loaded"),this}},blueprintModuleId:t("montage")._blueprintModuleIdDescriptor,blueprint:t("montage")._blueprintDescriptor})}});