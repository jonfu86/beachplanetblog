montageDefine("3d2b056","runtime/skin",{dependencies:["runtime/dependencies/gl-matrix","runtime/base","runtime/transform","runtime/utilities"],factory:function(t,e){t("runtime/dependencies/gl-matrix"),t("runtime/base").Base,t("runtime/transform").Transform,t("runtime/utilities").Utilities,e.Skin=Object.create(Object.prototype,{jointsIds:{value:null,writable:!0},nodesForSkeleton:{value:null,writable:!0},bindShapeMatrix:{value:null,writable:!0},inverseBindMatricesDescription:{value:null,writable:!0},matricesForSkeleton:{value:null,writable:!0},sources:{value:null,writable:!0},init:{value:function(){return this.jointsIds=[],this.nodesForSkeleton={},this.matricesForSkeleton={},this.sources=[],this}},inverseBindMatricesDelegate:{value:{handleError:function(t,e){console.log("ERROR:vertexAttributeBufferDelegate:"+t+" :"+e)},convert:function(t,e){return new Float32Array(e)},resourceAvailable:function(){}}},process:{value:function(t,e){var n=t.instanceSkin.skeletons,i=mat4.create();mat4.inverse(t.worldMatrix,i),n.forEach(function(t){var n=this.nodesForSkeleton[t],r=this.matricesForSkeleton[t];if(!r){var a=16*this.jointsIds.length;r=new Float32Array(a),this.matricesForSkeleton[t]=r;for(var s=mat4.identity(),o=0;a>o;o++)r[o]=s[o%16]}var l=e.getResource(this.inverseBindMatricesDescription,this.inverseBindMatricesDelegate);l&&this.sources.forEach(function(t){for(var e=t,a=this.bindShapeMatrix,s=this.jointsIds.length,o=mat4.create(),c=0;s>c;c++){for(var h=0;16>h;h++)o[h]=l[16*c+h];var u=n[c].worldMatrix,p=mat4.identity();mat4.multiply(p,i),mat4.multiply(p,u),mat4.multiply(p,o),mat4.multiply(p,a);for(var h=0;16>h;h++)r[16*c+h]=p[h]}e.primitives.forEach(function(t){t.material.parameters&&(t.material.parameters.jointMat.value=r)},this)},this)},this)}}})}});