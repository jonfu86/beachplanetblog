montageDefine("3d2b056","runtime/animation",{dependencies:["runtime/dependencies/gl-matrix","runtime/base","runtime/transform","runtime/utilities","runtime/dependencies/o3dgc"],factory:function(t,e){function n(t){function e(t,e){return 1-3*e+3*t}function n(t,e){return 3*e-6*t}function i(t){return 3*t}function a(t,a,s){return((e(a,s)*t+n(a,s))*t+i(a))*t}function s(t,a,s){return 3*e(a,s)*t*t+2*n(a,s)*t+i(a)}function r(t){for(var e=t,n=0;4>n;++n){var i=s(e,o,c);if(0==i)return e;var r=a(e,o,c)-t;e-=r/i}return e}var o=t[0],l=t[1],c=t[2],h=t[3];this.get=function(t){return o==l&&c==h?t:a(r(t),l,h)}}function i(t,e,n){var i=Object.create(r).init();return t.interpolateToTransform(e,n,i),i}function a(t,e,n){return t+(e-t)*n}t("runtime/dependencies/gl-matrix");var s=t("runtime/base").Base,r=t("runtime/transform").Transform;t("runtime/utilities").Utilities;var o=t("runtime/dependencies/o3dgc").o3dgc,l={ease:[.25,.1,.25,1],linear:[0,0,1,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1]},c=e.Channel=Object.create(s,{startTime:{value:0,writable:!0},endTime:{value:-1,writable:!0},_sampler:{value:null,writable:!0},sampler:{get:function(){return this._sampler},set:function(t){this._sampler=t}},_target:{value:null,writable:!0},target:{get:function(){return this._target},set:function(t){this._target=t}},_path:{value:null,writable:!0},path:{get:function(){return this._path},set:function(t){this._path=t}},parameterDelegate:{value:{handleError:function(t,e){console.log("ERROR:parameterDelegate:"+t+" :"+e)},decode:function(t,e){function n(t){for(var e=new ArrayBuffer(t.length),n=new Uint8Array(e),i=0,a=t.length;a>i;i++)n[i]=t.charCodeAt(i);return e}if(e){var i="ascii"==e.extensions["Open3DGC-compression"].compressedData.mode?"text":"arraybuffer";if("text"===i)var a=new o.BinaryStream(n(t)),s=t.length;else var a=new o.BinaryStream(t),s=t.byteLength;var r=new o.DynamicVectorDecoder,l=new o.DynamicVector,c=new o.Timer;return c.Tic(),r.DecodeHeader(l,a),c.Toc(),console.log("DecodeHeader time (ms) "+c.GetElapsedTime()),l.GetNVector()>0&&l.GetDimVector()&&(l.SetVectors(new Float32Array(l.GetNVector()*l.GetDimVector())),l.SetMinArray(new Float32Array(l.GetDimVector())),l.SetMaxArray(new Float32Array(l.GetDimVector())),l.SetStride(l.GetDimVector())),console.log("Dynamic vector info:"+e.id),console.log("	# vectors   "+l.GetNVector()),console.log("	dim         "+l.GetDimVector()),c.Tic(),r.DecodePlayload(l,a),c.Toc(),console.log("DecodePlayload time "+c.GetElapsedTime()+" ms, "+s+" bytes ("+8*s/l.GetNVector()+" bpv)"),l.GetVectors()}},convert:function(t,e,n){var i=n;if(i.extensions){var a=i.extensions,s=a["Open3DGC-compression"];if(s){var r=s.compressedData;if(r)return this.decode(e,n)}}return new Float32Array(e)},resourceAvailable:function(){}}},getParameterArray:{value:function(t,e){if(t.extensions){var n=t.extensions,i=n["Open3DGC-compression"];if(i){var a=i.compressedData;if(a)return e.getResource(a,this.parameterDelegate,t)}}return e.getResource(t,this.parameterDelegate,t)}},updateTargetsAtTime:{value:function(t,e){var n=this.sampler.input,i=this.sampler.output,a=this.getParameterArray(n,e),s=this.getParameterArray(i,e);if(a&&s){t/=1e3;var r=n.count;this.endTime=a[r-1],this.startTime=a[0];var o,l=0,c=0,h=0;if(r>0){if(this.startTime>t)c=0,l=0;else if(t>=this.endTime)c=1,l=r-2;else for(o=l;r-1>o;o++)if(t>=a[o]&&a[o+1]>t){l=o,h=a[o+1]-a[o],c=(t-a[o])/h;break}null==this.__vec4&&(this.__vec4=vec4.create()),null==this.__vec3&&(this.__vec3=vec3.create()),null==this.__vec2&&(this.__vec2=vec2.create());var p=null;switch(i.componentsPerAttribute){case 4:p=this.__vec4;break;case 3:p=this.__vec3;break;case 2:p=this.__vec2;break;case 1:console.log("float interpolation not handled yet");break;default:}this.index=l;var u=l*i.componentsPerAttribute,d=u+i.componentsPerAttribute,g=this.path;if("rotation"===g){g="orientation";var m=0,f=1,v=2,L=v;if(L==m){var y=vec4.createFrom(s[u+0],s[u+1],s[u+2],s[u+3]),C=vec4.createFrom(s[d+0],s[d+1],s[d+2],s[d+3]);vec3.normalize(y),vec3.normalize(C);var x=vec3.create();vec3.cross(y,C,x),Math.sqrt(vec3.dot(y,y)),Math.sqrt(vec3.dot(C,C));var w=Math.acos(vec3.dot(y,C)),_=mat4.identity();mat4.rotate(_,w*c,x),mat4.multiplyVec3(_,y,x),vec3.normalize(x);var b=y[3]+(C[3]-y[3])*c;quat4.fromAngleAxis(b,x,p)}else if(L==f){var y=vec4.createFrom(s[u+0],s[u+1],s[u+2],s[u+3]),C=vec4.createFrom(s[d+0],s[d+1],s[d+2],s[d+3]);for(o=0;p.length>o;o++){var M=y[o],z=C[o];C[o]=M+(z-M)*c}quat4.fromAngleAxis(C[3],C,p)}else if(L==v){null==this._quats&&(this._quats=[],this._quats.push(quat4.create()),this._quats.push(quat4.create())),null==this._vecs&&(this._vecs=[],this._vecs.push(vec3.create()),this._vecs.push(vec3.create())),this._vecs[0][0]=s[u+0],this._vecs[0][1]=s[u+1],this._vecs[0][2]=s[u+2],this._vecs[1][0]=s[d+0],this._vecs[1][1]=s[d+1],this._vecs[1][2]=s[d+2];var S=this._quats[0],B=this._quats[1];quat4.fromAngleAxis(s[u+3],this._vecs[0],S),quat4.fromAngleAxis(s[d+3],this._vecs[1],B),quat4.slerp(S,B,c,p)}}else for(o=0;p.length>o;o++){var M=s[u+o],z=s[d+o];p[o]=M+(z-M)*c}this.target.transform[g]=p}}}},initWithDescription:{value:function(t){return this.init(),this.index=0,this.target=t.target,this}},init:{value:function(){return this.__Base_init(),this}}}),h=Object.create(s,{_input:{value:null,writable:!0},input:{get:function(){return this._input},set:function(t){this._input=t}},_output:{value:null,writable:!0},output:{get:function(){return this._output},set:function(t){this._output=t}},initWithDescription:{value:function(){return this.init(),this}},init:{value:function(){return this.__Base_init(),this}}}),p=e.Animation=Object.create(Object.prototype,{KEYFRAME:{value:"KEYFRAME",writable:!0},BASIC:{value:"BASIC",writable:!0},_type:{value:null,writable:!0},type:{set:function(t){this._type=t},get:function(){return this._type}},_delegate:{value:null,writable:!0},delegate:{set:function(t){this._delegate=t},get:function(){return this._delegate}}});e.BasicAnimation=Object.create(p,{_startTime:{value:0,writable:!0},_from:{value:null,writable:!0},_to:{value:null,writable:!0},_duration:{value:0,writable:!0},path:{value:null,writable:!0},target:{value:null,writable:!0},_interpolator:{value:null,writable:!0},extras:{value:null,writable:!0},_timingFunction:{value:null,writable:!0},_bezier:{value:null,writable:!0},timingFunction:{set:function(t){this._timingFunction=t},get:function(){return this._timingFunction||"ease"}},_inferInterpolatorFromValue:{value:function(t){return isNaN(t-0)||null==t?t instanceof Object?i:nil:a}},to:{set:function(t){this._interpolator=this._inferInterpolatorFromValue(t),this._to=t},get:function(){return this._to}},from:{set:function(t){this._from=t},get:function(){return this._from}},duration:{set:function(t){this._duration=t},get:function(){return this._duration}},_evaluateAtTime:{value:function(t){var e=(t-this._startTime)/this.duration;if(e>1&&(e=1),0>e&&(e=0),null==this._bezier){var i=l[this.timingFunction]||"ease";this._bezier=new n(i)}e=this._bezier.get(e);var a=this._interpolator(this._from,this._to,e);this.target&&this.path&&(this.target[this.path]=a,this.delegate.animationDidUpdate(this))}},animationWasAddedToTarget:{value:function(){this._startTime=Date.now()}},animationWasRemovedFromTarget:{value:function(){this._startTime=0}},init:{value:function(){return this.type=p.BASIC,this.extras={},this}}}),e.KeyframeAnimation=Object.create(p,{_count:{value:0,writable:!0},_parameters:{value:null,writable:!0},_channels:{value:null,writable:!0},_samplers:{value:null,writable:!0},_startTime:{value:0,writable:!0},_endTime:{value:-1,writable:!0},channels:{get:function(){return this._channels},set:function(t){this._channels=t}},samplers:{get:function(){return this._samplers},set:function(t){this._samplers=t}},parameters:{get:function(){return this._parameters},set:function(t){this._parameters=t}},count:{get:function(){return this._count},set:function(t){this._count=t}},startTime:{get:function(){if(this.channels){if(this.channels.length>0){for(var t=this.channels[0].startTime,e=1;this.channels.length>e;e++)t>this.channels[e].startTime&&(t=this.channels[e].startTime);return t}return 0}}},endTime:{get:function(){if(this.channels){if(this.channels.length>0){for(var t=this.channels[0].endTime,e=1;this.channels.length>e;e++)this.channels[e].endTime>t&&(t=this.channels[e].endTime);return t}return-1}}},updateTargetsAtTime:{value:function(t,e){this.channels.forEach(function(n){n.updateTargetsAtTime(t,e)},this)}},initWithDescription:{value:function(t){return this.init(),this.count=t.count,Object.keys(t.samplers).forEach(function(e){var n=t.samplers[e],i=Object.create(h).initWithDescription(n);this.samplers[e]=i},this),t.channels.forEach(function(t){var e=Object.create(c).initWithDescription(t);e.sampler=this.samplers[t.sampler],e.target=t.target,this.channels.push(e)},this),this}},init:{value:function(){return this.channels=[],this.samplers={},this.type=p.KEYFRAME,this}}})}});