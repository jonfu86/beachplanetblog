montageDefine("3d2b056","runtime/helpers/resource-manager",{dependencies:[],factory:function(t,e){var n=Object.create(Object,{kind:{value:"multi-parts",writable:!0},range:{value:null,writable:!0},_requests:{value:null,writable:!0},requests:{get:function(){return this._requests},set:function(t){this._requests=t}},canMergeRequest:{value:function(t,e){var n=t.range[1]-t.range[0],i=this.range[1]-this.range[0];return n+i>e?!1:(t.range[0]===this.range[1]||t.range[1]===this.range[0])&&t.type===this.type}},mergeRequest:{value:function(t){0===this.requests.length?(this.requests.push(t),this.range=[t.range[0],t.range[1]]):t.range[0]===this.range[1]?(this.requests.push(t),this.range[1]=t.range[1]):t.range[1]===this.range[0]?(this.requests.unshift(t),this.range[0]=t.range[0]):console.log("ERROR: should not reach")}},mergeRequests:{value:function(t){if(this.range)if(t[0].range[1]<this.range[0])for(var e=t.length-1;e>=0;e--)this.mergeRequest(t[e]);else for(var e=0;t.length>e;e++)this.mergeRequest(t[e]);else t.forEach(function(t){this.mergeRequest(t)},this)}},id:{value:null,writable:!0},initWithRequests:{value:function(t){return this.requests=[],this.mergeRequests(t),this.id=t[0].id,this}}}),i=Object.create(Object,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(t){this._content=t}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent},set:function(t){this._parent=t}},_left:{value:null,writable:!0},left:{get:function(){return this._left},set:function(t){this._left=t}},_right:{value:null,writable:!0},right:{get:function(){return this._right},set:function(t){this._right=t}},_checkConsistency:{value:function(t){t.length>=50||(this.left&&this.left._checkConsistency(t),t.push(this.content.range),this.right&&this.right._checkConsistency(t))}},checkConsistency:{value:function(){var t=[];if(this._checkConsistency(t),t.length>1)for(var e=0;t.length-1>e;e++){var n=t[0],i=t[1];n[1]<=i[0]||console("ERROR: INCONSISTENCY CHECK Failed, ranges are not ordered in btree")}}},_collect:{value:function(t,e){this.left&&this.left._collect(t,e),t.length>=e||(t.push(this),this.right&&this.right._collect(t,e))}},collect:{value:function(t){var e=[];return this._collect(e,t),e}},insert:{value:function(t,e){if(t.range[1]<=this.content.range[0]){if(t.range[1]===this.content.range[0])return"multi-parts"===t.kind?this.content.mergeRequests(t.requests):this.content.mergeRequests(t),this.left&&this.content.canMergeRequest(this.left.content,e)&&(this.content.mergeRequests(this.left.content._requests),this.left.remove(this.left.content)),this.parent&&this.parent.content.canMergeRequest(this.content,e)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.left)return this.left.insert(t,e);var n=Object.create(i);return n.parent=this,n.content=t,this.left=n,n}if(t.range[0]>=this.content.range[1]){if(t.range[0]===this.content.range[1])return"multi-parts"===t.kind?this.content.mergeRequests(t.requests):this.content.mergeRequests(t),this.right&&this.content.canMergeRequest(this.right.content,e)&&(this.content.mergeRequests(this.right.content._requests),this.right.remove(this.right.content)),this.parent&&this.parent.content.canMergeRequest(this.content,e)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.right)return this.right.insert(t,e);var n=Object.create(i);return n.parent=this,n.content=t,this.right=n,n}console.log("ERROR: should not reach")}},contains:{value:function(t){return this.node===t?!0:this.left&&this.left.contains(t)?!0:this.right&&this.right.contains(t)?!0:!1}},min:{value:function(){for(var t=this;t.left;)t=t.left;return t}},_updateParentWithNode:{value:function(t){this.parent&&(this===this.parent.left?this.parent.left=t:this.parent.right=t),t&&(t.parent=this.parent)}},removeMin:{value:function(){this.parent;for(var t=this;t.left||t.right;)t.left&&(t=t.min()),t.right&&(t=t.right.min());return t._updateParentWithNode(null),t}},remove:{value:function(t){if(t.range[1]<=this.content.range[0])this.left.remove(t);else if(t.range[0]>=this.content.range[1])this.right.remove(t);else if(t===this.content)if(this.left&&this.right){var e=this.right.min();this.content=e.content,e._updateParentWithNode(e.right)}else this.left||this.right?this.left?this._updateParentWithNode(this.left):this._updateParentWithNode(this.right):this._updateParentWithNode(null)}}});e.WebGLTFResourceManager=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},_resources:{value:null,writable:!0},_requestTrees:{value:null,writable:!0},requestTrees:{get:function(){return this._requestTrees}},_resourcesStatus:{value:null,writable:!0},_resourcesBeingProcessedCount:{value:0,writable:!0},_observers:{value:null,writable:!0},_maxConcurrentRequests:{value:1,writable:!0},observers:{get:function(){return this._observers},set:function(t){this._observers=t}},maxConcurrentRequests:{get:function(){return this._maxConcurrentRequests},set:function(t){this._maxConcurrentRequests=t}},reset:{value:function(){if(this._resourcesStatus){var t=Object.keys(this._resourcesStatus);t.forEach(function(t){var e=this._resourcesStatus[t];e&&e.xhr&&e.xhr.abort()},this)}var e=Object.keys(this._resources);e.forEach(function(t){var e=this._resources[t];e&&"VIDEO"===e.nodeName&&e.pause()},this),this._resources={},this._requestTrees={},this._resourcesStatus={},this._resourcesBeingProcessedCount=0,this._wholeBuffers={}}},_bytesLimit:{value:5e5,writable:!0},bytesLimit:{get:function(){return this._bytesLimit},set:function(t){this._bytesLimit!==t&&(this._bytesLimit=t)}},_containsResource:{enumerable:!1,value:function(t){return this._resources[t]?!0:!1}},init:{value:function(){this._requestTrees={},this._resources={},this._resourcesStatus={},this._observers=[],this._resourcesBeingProcessedCount=0}},_storeResource:{enumerable:!1,value:function(t,e){return t?(this._containsResource[t]&&console.log("WARNING: resource:"+t+" is already stored, overriding"),this._resources[t]=e,void 0):(console.log("ERROR: entry does not contain id, cannot store"),void 0)}},_getResource:{enumerable:!1,value:function(t){return this._resources[t]}},_loadResource:{value:function(t,e){var n,i=this,a=t.path;if("multi-parts"===t.kind?(n=t.requests[0].type,a=t.requests[0].path):(n=t.type,a=t.path),!n)return e.handleError(WebGLTFResourceManager.INVALID_TYPE,null),void 0;if(!a)return e.handleError(WebGLTFResourceManager.INVALID_PATH),void 0;var r=new XMLHttpRequest;if(r.open("GET",a,!0),r.responseType=n,t.range){var s="bytes="+t.range[0]+"-"+(t.range[1]-1);r.setRequestHeader("Range",s)}r.onload=function(){200==this.status||206==this.status?(i._resourcesBeingProcessedCount--,"multi-parts"===t.kind?t.requests.forEach(function(n){var a=this.response.slice(n.range[0]-t.range[0],n.range[1]-t.range[0]);e.resourceAvailable(i,n,a)},this):e.resourceAvailable(i,t,this.response)):e.handleError(WebGLTFResourceManager.XMLHTTPREQUEST_STATUS_ERROR,this.status)},r.send(null);var o=this._resourcesStatus[t.id];o&&(o.xhr=r)}},_processNextResource:{value:function(t){if(t){var e=!t.left&&!t.right;if(e)return this._handleRequest(t.content),!1;var n=t.removeMin();this._handleRequest(n.content)}return!0}},_observingEnabled:{value:!1,writable:!0},isObserving:{value:function(){return this._observingEnabled}},startObserving:{value:function(){this._observingEnabled=!0}},stopObserving:{value:function(){this._observingEnabled=!1}},fireResourceAvailable:{value:function(t){this._observingEnabled&&this.observers&&this.observers.forEach(function(e){e.resourceAvailable&&e.resourceAvailable(t)},this)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(t){var e=this._resourcesStatus[t.id],a=null,r=null,s=this.requestTrees?this.requestTrees[t.path]:null;if(e){if("loading"===e.status)return;a=e.node,r=e.status}if("arraybuffer"!==t.type){var o=this,l={};"multi-parts"===t.kind?t.requests.forEach(function(t){this._resourcesStatus[t.id]={status:"loading"}},this):this._resourcesStatus[t.id]={status:"loading"},l.resourceAvailable=function(t,e,n){var i=e.delegate.convert(e,n,e.ctx);if(o._storeResource(e.id,i),e.delegate.resourceAvailable(i,e.ctx),delete o._resourcesStatus[e.id],o.fireResourceAvailable.call(o,e.id),o._resourcesBeingProcessedCount<o.maxConcurrentRequests){var a=t.requestTrees?t.requestTrees[e.path]:null;o._processNextResource(a)||a&&delete t.requestTrees[e.path]}},l.handleError=function(e,n){t.delegate.handleError(e,n)},o._resourcesBeingProcessedCount++,this._loadResource(t,l)}else if(!r){var c,h=null;if(c="multi-parts"===t.kind?Object.create(n).initWithRequests(t.requests):Object.create(n).initWithRequests([t]),s)h=s.insert(c,this.bytesLimit);else{var u=Object.create(i);u.content=c,this._requestTrees[t.path]=u,s=u,h=u}"multi-parts"===t.kind?t.requests.forEach(function(t){this._resourcesStatus[t.id]={status:"queued",node:h}},this):this._resourcesStatus[t.id]={status:"queued",node:h}}}},_elementSizeForGLType:{value:function(t){var e=WebGLRenderingContext.prototype;switch(t){case e.FLOAT:return Float32Array.BYTES_PER_ELEMENT;case e.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case e.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case e.FLOAT_VEC2:return 2*Float32Array.BYTES_PER_ELEMENT;case e.FLOAT_VEC3:return 3*Float32Array.BYTES_PER_ELEMENT;case e.FLOAT_VEC4:return 4*Float32Array.BYTES_PER_ELEMENT;case e.FLOAT_MAT4:return 16*Float32Array.BYTES_PER_ELEMENT;case e.FLOAT_MAT3:return 9*Float32Array.BYTES_PER_ELEMENT;default:return null}}},_allowRangedRequests:{value:!1,writable:!1},_wholeBuffers:{value:null,writable:!0},_handleWrappedBufferViewResourceLoading:{value:function(t,e,n){var i="arraybuffer",a=t.bufferView;if(a){var r=a.buffer,s=t.byteOffset+a.description.byteOffset,o=[s,this._elementSizeForGLType(t.type)*t.count+s];r.description&&r.description.type&&(i=r.description.type);var l={source:t,id:t.id,range:o,type:i,path:r.description.path,delegate:e,ctx:n,kind:"single-part"}}if(this._allowRangedRequests)this._handleRequest(l,null);else{this._wholeBuffers||(this._wholeBuffers={});var a=t.bufferView;if(a){var c=this,r=a.buffer,h=this._wholeBuffers[r.id];if(null==h){var u={};u.resourceAvailable=function(t,e,n){var i=c._wholeBuffers[e.id];t._storeResource(e.id,n),i.pendingRequests&&(i.pendingRequests.forEach(function(e){delete c._resourcesStatus[e.id];var i=n.slice(e.range[0],e.range[1]),a=e.delegate;if(null==this._resources[e.id]){var r=a.convert(e.source,i,e.ctx);t._storeResource(e.id,r),a.resourceAvailable(r,e.ctx)}c.fireResourceAvailable.call(c,e.id)},c),i.pendingRequests=[])},u.handleError=function(){};var p={id:r.id,type:i,path:r.description.path,delegate:e,ctx:n,kind:"single-part"};c._resourcesBeingProcessedCount++,this._loadResource(p,u),h={activeRequest:"bufferRequest",pendingRequests:[]},this._wholeBuffers[r.id]=h}else{var d=this._getResource(r.id);if(d){var m=d.slice(l.range[0],l.range[1]),e=l.delegate,g=e.convert(t,m,l.ctx);return c._storeResource(l.id,g),e.resourceAvailable(g,l.ctx),c.fireResourceAvailable.call(c,l.id),void 0}}var f=this._resourcesStatus[l.id];if(f&&"loading"===f.status)return;h.pendingRequests.push(l),this._resourcesStatus[l.id]={status:"loading"}}}}},shaderDelegate:{value:{handleError:function(t,e){console.log("ERROR:shaderDelegate:"+t+" :"+e)},convert:function(t,e){return e},resourceAvailable:function(t,e){if(e.sources[e.stage]=t,e.sources["x-shader/x-fragment"]&&e.sources["x-shader/x-vertex"]){var n=e.programCtx.delegate,i=n.convert(null,e.sources,e.programCtx.ctx);e.programCtx.resourceManager._storeResource(e.programCtx.id,i),n.resourceAvailable(i,e.programCtx.ctx),e.programCtx.resourceManager.fireResourceAvailable.call(e.programCtx.resourceManager,e.programCtx.id)}}}},_handleProgramLoading:{value:function(t,e,n){var i={delegate:e,ctx:n,resourceManager:this,id:t.id},a={},r={stage:"x-shader/x-fragment",sources:a,programCtx:i},s={stage:"x-shader/x-vertex",sources:a,programCtx:i};this.getResource(t["x-shader/x-fragment"],this.shaderDelegate,r),this.getResource(t["x-shader/x-vertex"],this.shaderDelegate,s)}},_handleShaderLoading:{value:function(t,e,n){this._handleRequest({id:t.id,type:"text",path:t.description.path,delegate:e,ctx:n,kind:"single-part"},null)}},_handleVideoLoading:{value:function(t,e,n){var i=this._resourcesStatus[t.id];if(!i||"loading"!==i.status){this._resourcesStatus[t.id]={status:"loading"};var a=this;if(t.description.path){this._resourcesBeingProcessedCount++;var r=document.createElement("video");r.preload="auto",r.loop="loop",r.addEventListener("canplaythrough",function(){a._resourcesBeingProcessedCount--,r.play(),delete a._resourcesStatus[t.id],a._storeResource(t.id,r),e(r,t.id,n)}),r.src=t.description.path}}}},_handleImageLoading:{value:function(t,e,n,i){var a=this._resourcesStatus[t.id];if(!a||"loading"!==a.status){this._resourcesStatus[t.id]={status:"loading"};var r=this;if(t.description.path){this._resourcesBeingProcessedCount++;var s=new Image;s.onload=function(){r._resourcesBeingProcessedCount--,delete r._resourcesStatus[t.id],r._storeResource(t.id,s),e(s,t.id,n,i)},s.src=t.description.path}else t.description.image&&e(t.description.image,t.id,n,i)}}},_handleTextureLoading:{value:function(t,e,n){var i=this._resourcesStatus[t.id];if(!i||"loading"!==i.status){this._resourcesStatus[t.id]={status:"loading"};var a=this;if(t.source)"image"===t.source.type&&this._handleImageLoading(t.source,function(n,i,r){var s=e.convert(n,t,r);delete a._resourcesStatus[t.id],a._storeResource(t.id,s),e.resourceAvailable(s,r),a.fireResourceAvailable.call(a,t.id)},n),"video"===t.source.type&&this._handleVideoLoading(t.source,function(n,i,r){var s=e.convert(n,t,r);delete a._resourcesStatus[t.id],a._storeResource(t.id,s),e.resourceAvailable(s,r),a.fireResourceAvailable.call(a,t.id)},n);else if(t.sources){var r=0,s=[null,null,null,null,null,null],o=0;t.sources.forEach(function(i){"image"===i.type&&this._handleImageLoading(i,function(n,i,o,l){if(r++,s[l]=n,r==t.sources.length){var c=e.convert(s,t,o);delete a._resourcesStatus[t.id],a._storeResource(t.id,c),e.resourceAvailable(c,o),a.fireResourceAvailable.call(a,t.id)}},n,o++),"video"===i.type&&this._handleVideoLoading(i,function(n,i,l){if(r++,s[o]=n,r==t.sources.length){var c=e.convert(s,t,l);delete a._resourcesStatus[t.id],a._storeResource(t.id,c),e.resourceAvailable(c,l),a.fireResourceAvailable.call(a,t.id)}},n,o++)},this)}}}},setResource:{value:function(t,e){this._resources[t],this._resources[t]=e}},getResource:{value:function(t,e,n){var i=this._getResource(t.id);return i?i:("program"===t.type?this._handleProgramLoading(t,e,n):"shader"===t.type?this._handleShaderLoading(t,e,n):"image"===t.type?this._handleImageLoading(t,e,n):"texture"===t.type?this._handleTextureLoading(t,e,n):this._handleWrappedBufferViewResourceLoading(t,e,n),null)}},hasPendingRequests:{value:function(){return this._resourcesBeingProcessedCount>0}},removeAllResources:{value:function(){this._resources={}}}})}});