var Component=require("montage/ui/component").Component,Dict=require("collections/dict"),SceneTreeFactory=require("./core/scene-tree-factory").SceneTreeFactory,Application=require("montage/core/application").Application,Node=require("runtime/node").Node,DEFAULT_VALUES={indentValue:10,indentUnit:"px",meshesEnabled:!1,displayNodeType:!0};exports.SceneTree=Component.specialize({constructor:{value:function(){this.super(),this.configuration=Dict(),this._treeFactory=new SceneTreeFactory(this.configuration),this._populateConfiguration()}},_treeFactory:{value:null},configuration:{value:null},_scene:{value:null},scene:{set:function(t){t&&"object"==typeof t&&(this._scene=t)},get:function(){return this._scene}},selectedNode:{value:null},_sceneGraphTree:{value:null},sceneGraphTree:{set:function(t){t&&(this._sceneGraphTree=this._treeFactory.buildWithGlTFTree(t))},get:function(){return this._sceneGraphTree}},isCellDraggable:{value:null},treeController:{value:null},rangeController:{value:null},enterDocument:{value:function(t){t&&(this.addOwnPropertyChangeListener("selectedNode",this),this.addPathChangeListener("scene.status",this,"handleStatusChange"),Application.addEventListener("sceneNodeSelected",this))}},exitDocument:{value:function(){this.removeOwnPropertyChangeListener("selectedNode",this),this.removePathChangeListener("scene.status",this),Application.removeEventListener("sceneNodeSelected",this)}},handleSceneNodeSelected:{value:function(t){var e=t.detail,n=this.selectedNode,i=n&&n.content.glTFElement.baseId===e.id;e&&!i&&(this.selectTreeControllerNodeById(e.id),this.needsDraw=!0)}},_populateConfiguration:{value:function(){var t=this;Object.keys(DEFAULT_VALUES).forEach(function(e){t.configuration.set(e,DEFAULT_VALUES[e])})}},_createNodeFromGlTFElement:{value:function(t){var e=new Node;return this.scene.glTFElement.ids[t.baseId]=t,e.scene=this._scene,e.id=t.baseId,t.component3D=e,e}},_getComponent3DFromGlTFElement:{value:function(t){return t.component3D?t.component3D:this._createNodeFromGlTFElement(t)}},handleStatusChange:{value:function(t){"loaded"===t&&this._scene&&(this.sceneGraphTree=this._scene.rootNode.glTFElement)}},handleSelectedNodeChange:{value:function(t){if(t&&t.content&&t.content.glTFElement){var e=this._getComponent3DFromGlTFElement(t.content.glTFElement);Application.dispatchEventNamed("sceneNodeSelected",!0,!0,e)}}},_findSceneTreeNodeById:{value:function(t,e){var n=null,i=this,a=null;if(e){var s=e.rawChildren;a=Object.keys(s).map(function(t){return s[t]})}else a=this.treeController.root.content.children;return a.some(function(e){return e.glTFElement&&e.glTFElement.baseId===t?(n=e,!0):(n=i._findSceneTreeNodeById(t,e),!!n)}),n}},_fulfillSceneTreeNodePath:{value:function(t){Array.isArray(t)&&t.forEach(function(t){t.fulfilled||t.fulfill()})}},_expandTreeControllerNode:{value:function(t){t&&(t.expanded||(t.expanded=!0),this._expandTreeControllerNode(t.parent))}},_findTreeControllerNodeById:{value:function(t){var e=this.treeController.root.nodes,n=null;return e.some(function(e){var i=e.content;return i.glTFElement&&i.glTFElement.baseId===t&&(n=e),!!n}),n}},selectTreeControllerNodeById:{value:function(t){if(this.treeController&&this.treeController.root){var e=this._findSceneTreeNodeById(t);if(e){var n=e.toParentPath();if(n){this._fulfillSceneTreeNodePath(n);var i=this._findTreeControllerNodeById(t);this._expandTreeControllerNode(i.parent),this.rangeController.select(i)}}}}}});