var Montage=require("./core").Montage,GenericCollection=require("collections/generic-collection"),observableArrayProperties=require("collections/listen/array-changes").observableArrayProperties,EMPTY_ARRAY=Object.freeze([]),_RangeSelection=function(e,t){var n=e;return n.__proto__=_RangeSelection.prototype,n.rangeController=t,n.contentEquals=e&&e.contentEquals||Object.is,n};_RangeSelection.prototype=Object.create(Array.prototype,observableArrayProperties),Object.defineProperty(_RangeSelection.prototype,"clone",{value:function(){return this.slice()}});var oldSwap=self.swap;Object.defineProperty(_RangeSelection.prototype,"oldSwap",{configurable:!1,value:observableArrayProperties.swap.value}),Object.defineProperty(_RangeSelection.prototype,"swap",{configurable:!1,value:function(e,t,n){return this.swap_or_push(e,t,n)}}),_RangeSelection.prototype.oldPush=observableArrayProperties.push.value,Object.defineProperty(_RangeSelection.prototype,"push",{configurable:!1,value:function(){for(var e=-1,t=arguments.length,n=Array(t);t>++e;)n[e]=arguments[e];this.swap_or_push(this.length,0,n)}}),Object.defineProperty(_RangeSelection.prototype,"swap_or_push",{configurable:!1,value:function(e,t,n){var i=this.rangeController.content;this.contentEquals=i&&i.contentEquals||Object.is,e=e>=0?e:this.length+e;var r=this.length,a=Math.min(t,r-e);if(n){n.contentEquals=this.contentEquals;var s=n.filter(function(t,r){if(i&&!i.has(t))return!1;if(n.findLast(t)>r)return!1;var s=this.find(t);return 0>s||s>=e&&e+a>s},this)}else s=EMPTY_ARRAY;var o;o=0===a?EMPTY_ARRAY:Array.prototype.slice.call(this,e,e+a);var l=s.length-o.length,c=Math.max(this.length+l,e+s.length);if(!this.rangeController.multiSelect&&c>1){var u=s.length?s[s.length-1]:this.one();return 0===r?(this.oldPush(u),EMPTY_ARRAY):this.oldSwap(0,r,[u])}return this.rangeController.avoidsEmptySelection&&0===c?i.has(this[0])?0===this.length-1?EMPTY_ARRAY:this.oldSwap(1,this.length-1):0===this.length?(this.oldPush(i.one()),EMPTY_ARRAY):this.oldSwap(0,this.length,[i.one()]):this.oldSwap(e,t,s)}});var RangeController=exports.RangeController=Montage.specialize({constructor:{value:function(e){this.content=null,this._selection=new _RangeSelection([],this),this.sortPath=null,this.filterPath=null,this.reversed=!1,this.selectAddedContent=!1,this.deselectInvisibleContent=!1,this.clearSelectionOnOrderChange=!1,this.avoidsEmptySelection=!1,this.multiSelect=!1,this.organizedContent=[],this.organizedContent.addRangeChangeListener(this,"organizedContent"),this.defineBinding("_filteredContent",{"<-":"$filterPath.defined() ? content.filter{path($filterPath)} : content"}),this.defineBinding("_sortedContent",{"<-":"$sortPath.defined() ? _filteredContent.sorted{path($sortPath)} : _filteredContent"}),this.defineBinding("organizedContent.rangeContent()",{"<-":"$reversed ?? 0 ? _sortedContent.reversed() : _sortedContent"}),this.addRangeAtPathChangeListener("content",this,"handleContentRangeChange"),this.addPathChangeListener("sortPath",this,"handleOrderChange"),this.addPathChangeListener("reversed",this,"handleOrderChange"),this.addOwnPropertyChangeListener("multiSelect",this),this.iterations=[],e&&this.initWithContent(e)}},initWithContent:{value:function(e){return this.content=e,this}},sortPath:{value:null},reversed:{value:null},filterPath:{value:null},selectAddedContent:{value:!1},deselectInvisibleContent:{value:!1},clearSelectionOnOrderChange:{value:!1},avoidsEmptySelection:{value:!1},multiSelect:{value:!1},organizedContent:{value:null},iterations:{value:null},_selection:{value:null},selection:{get:function(){return this._selection},set:function(e){var t=[0,this._selection.length];e&&e.toArray&&(t=t.concat(e.toArray())),this._selection.splice.apply(this._selection,t)}},select:{value:function(e){!this.multiSelect&&this.selection.length>=1&&this.selection.clear(),this.selection.add(e)}},deselect:{value:function(e){(!this.avoidsEmptySelection||this.selection.length>1)&&this.selection["delete"](e)}},clearSelection:{value:function(){(!this.avoidsEmptySelection||this.selection.length>1)&&this.selection.clear()}},add:{value:function(e){var t;return this.content||(this.content=[]),t=this.content.add(e),t&&this.handleAdd(e),t}},push:{value:function(){for(var e=this.content.push.apply(this.content,arguments),t=0;arguments.length>t;t++)this.handleAdd(arguments[t]);return e}},pop:{value:function(){return this.content.pop()}},shift:{value:function(){return this.content.shift()}},unshift:{value:function(){for(var e=this.content.unshift.apply(this.content,arguments),t=0;arguments.length>t;t++)this.handleAdd(arguments[t]);return e}},splice:{value:function(){for(var e=this.content.splice.apply(this.content,arguments),t=2;arguments.length>t;t++)this.handleAdd(arguments[t]);return e}},swap:{value:function(e,t,n){var i=this.content.swap.apply(this.content,arguments);if(n)for(var e=2;n.length>e;e++)this.handleAdd(n[e]);return i}},"delete":{value:function(e){return this.content["delete"](e)}},has:{value:function(e){return this.content?this.content.has(e):!1}},addEach:{value:GenericCollection.prototype.addEach},deleteEach:{value:GenericCollection.prototype.deleteEach},clear:{value:function(){this.content.clear()}},addContent:{value:function(){var e=new this.contentConstructor;return this.add(e),e}},_contentConstructor:{value:null},contentConstructor:{get:function(){return this._contentConstructor?this._contentConstructor:this.content&&this.content.contentConstructor?this.content.contentConstructor:Object},set:function(e){this._contentConstructor=e}},handleContentRangeChange:{value:function(e,t){if(this.selection.length>0){var n=this.content&&this.content.contentEquals||Object.is;t.deleteEach(e,n),this.selection&&this.selection.deleteEach(t)}}},handleSelectionRangeChange:{value:function(e,t){if(this.selection)if(this.content){for(var n=[],i=0;e.length>i;i++)this.content.has(e[i])||n.push(e[i]);if(this._selection.deleteEach(n),!this.multiSelect&&this._selection.length>1){var r=this._selection.pop();this._selection.clear(),this._selection.add(r)}this.avoidsEmptySelection&&0==this._selection.length&&this._selection.add(t[0])}else this._selection.clear()}},handleOrganizedContentRangeChange:{value:function(e,t){if(this.deselectInvisibleContent&&this.selection){var n=t.clone(1);n.deleteEach(e),this.selection.deleteEach(t)}}},handleOrderChange:{value:function(){this.clearSelectionOnOrderChange&&this.selection&&this.selection.clear()}},handleAdd:{value:function(e){this.selectAddedContent&&this.selection&&(!this.multiSelect&&this.selection.length>=1&&this.selection.clear(),this.selection.add(e))}},handleMultiSelectChange:{value:function(){if(this.selection){var e=this.selection.length;if(!this.multiSelect&&e>1){var t=this._selection.pop();this._selection.clear(),this._selection.add(t)}}}}},{blueprintModuleId:require("./core")._blueprintModuleIdDescriptor,blueprint:require("./core")._blueprintDescriptor});