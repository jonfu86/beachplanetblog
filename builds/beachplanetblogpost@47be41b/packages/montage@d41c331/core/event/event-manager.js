var Montage=require("../core").Montage,UUID=require("../uuid"),MutableEvent=require("./mutable-event").MutableEvent,Serializer=require("core/serialization/serializer/montage-serializer").MontageSerializer,Deserializer=require("core/serialization/deserializer/montage-deserializer").MontageDeserializer,defaultEventManager;if("undefined"!=typeof window){window.Touch===void 0&&"ontouchstart"in window&&(window.Touch=function(){},function(){var t;document.addEventListener("touchstart",t=function(e){window.Touch=e.touches[0].constructor,document.nativeRemoveEventListener?document.nativeRemoveEventListener("touchstart",t,!0):document.removeEventListener("touchstart",t,!0),defaultEventManager&&defaultEventManager.isStoringPointerEvents&&(defaultEventManager.isStoringPointerEvents=!1,defaultEventManager.isStoringPointerEvents=!0)},!0)}());var _PointerStorageMemoryEntry=Montage.specialize({constructor:{value:function(t){return this.data=Array(32),this.velocity={velocity:(new _PointerVelocity).initWithIdentifier(t)},this}},data:{enumerable:!1,writable:!0,value:null},size:{enumerable:!1,writable:!0,value:0},pos:{enumerable:!1,writable:!0,value:0},velocity:{enumerable:!1,writable:!0,value:0}}),_StoredEvent=Montage.specialize({constructor:{value:function(t,e,n){return this.clientX=t,this.clientY=e,this.timeStamp=n,this}},clientX:{enumerable:!1,writable:!0,value:null},clientY:{enumerable:!1,writable:!0,value:0},timeStamp:{enumerable:!1,writable:!0,value:0}}),_PointerStorage=Montage.specialize({memory:{value:{}},add:{value:function(t,e,n,i){var r;(r=this.memory[t])||(r=this.memory[t]=new _PointerStorageMemoryEntry(t)),(data=r.data[r.pos])?(data.clientX=e,data.clientY=n,data.timeStamp=i):data=r.data[r.pos]=new _StoredEvent(e,n,i),r.size<r.data.length&&r.size++,r.pos=(r.pos+1)%r.data.length}},remove:{value:function(t){delete this.memory[t]}},clear:{value:function(t){this.memory[t]&&(this.memory[t].size=0,this.memory[t].velocity.velocity.clearCache())}},getMemory:{value:function(t){return this.memory[t]}},isStored:{value:function(t){return this.memory[t]&&this.memory[t].size>0}},pointerVelocity:{value:function(t){return this.memory[t]?this.memory[t].velocity:void 0}},storeEvent:{value:function(t){var e;switch(t.type){case"mousedown":defaultEventManager._isMouseDragging=!0;case"mousemove":defaultEventManager._isStoringMouseEventsWhileDraggingOnly?defaultEventManager._isMouseDragging&&(this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}})):(this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}}));break;case"mouseup":this.add("mouse",t.clientX,t.clientY,t.timeStamp),Object.defineProperty(t,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}});break;case"touchstart":case"touchmove":for(e=0;t.touches.length>e;e++)this.add(t.touches[e].identifier,t.touches[e].clientX,t.touches[e].clientY,t.timeStamp);break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.add(t.changedTouches[e].identifier,t.changedTouches[e].clientX,t.changedTouches[e].clientY,t.timeStamp)}}},removeEvent:{value:function(t){var e;switch(t.type){case"mouseup":defaultEventManager._isMouseDragging=!1,defaultEventManager._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse");break;case"touchend":for(e=0;t.changedTouches.length>e;e++)this.remove(t.changedTouches[e].identifier)}}}}),_PointerVelocity=Montage.specialize({_identifier:{enumerable:!1,writable:!0,value:null},initWithIdentifier:{value:function(t){return this._identifier=t,this}},clearCache:{value:function(){return this._data=this._x=this._y=this._speed=this._angle=null,this}},_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(this._identifier)),this._x=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(this._identifier)),this._y=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}),_TargetRegistration=function(){return this.listeners={},this};_TargetRegistration._pool=[],_TargetRegistration.checkoutRegistration=function(){return 0===this._pool.length?new this:this._pool.pop()},_TargetRegistration.checkinRegistration=function(t){t.target=null,this._pool.push(t)},Object.defineProperties(_TargetRegistration.prototype,{target:{enumerable:!1,writable:!0,value:null},listeners:{enumerable:!1,writable:!0,value:null}});var _TargetListenerRegistration=function(){return this};_TargetListenerRegistration._pool=[],_TargetListenerRegistration.checkoutRegistration=function(){return 0===this._pool.length?new this:this._pool.pop()},_TargetListenerRegistration.checkinRegistration=function(t){t.listener=null,this._pool.push(t)},Object.defineProperties(_TargetListenerRegistration.prototype,{initWithListener:{value:function(t,e,n){return this.listener=t,this.capture=e,this.bubble=n,this}},listener:{enumerable:!1,writable:!0,value:null},capture:{enumerable:!1,writable:!0,value:!0},bubble:{enumerable:!1,writable:!0,value:!1}}),Serializer.defineSerializationUnit("listeners",function(t,e){var n,i,r,a=defaultEventManager,s=e.uuid,o=[];for(var l in a.registeredEventListeners)if(n=a.registeredEventListeners[l],i=n&&n[s])for(var c in i.listeners)r=i.listeners[c],o.push({type:l,listener:t.addObjectReference(r.listener),capture:r.capture});return o.length>0?o:void 0}),Deserializer.defineDeserializationUnit("listeners",function(t,e,n){for(var i,r=0;i=n[r];r++)e.addEventListener(i.type,i.listener,i.capture)});var NONE=Event.NONE,CAPTURING_PHASE=Event.CAPTURING_PHASE,AT_TARGET=Event.AT_TARGET,BUBBLING_PHASE=Event.BUBBLING_PHASE,FUNCTION_TYPE="function",EventManager=exports.EventManager=Montage.specialize({constructor:{value:function(){this.super(),this._trackingTouchList={touchesStart:Object.create(null),touchesEnd:Object.create(null)}}},eventDefinitions:{value:{abort:{bubbles:!1,cancelable:!1},beforeunload:{bubbles:!1},blur:{bubbles:!1,cancelable:!1},change:{bubbles:!0,cancelable:!1},click:{bubbles:!0,cancelable:!0},close:{bubbles:!1,cancelable:!1},compositionend:{bubbles:!0,cancelable:!1},compositionstart:{bubbles:!0,cancelable:!0},compositionupdate:{bubbles:!0,cancelable:!1},contextmenu:{bubbles:!0,cancelable:!0},copy:{bubbles:!0,cancelable:!0},cut:{bubbles:!0,cancelable:!0},dblclick:{bubbles:!0,cancelable:!1},DOMActivate:{bubbles:!0,cancelable:!0,deprecated:!0},DOMMouseScroll:{bubbles:!0},drag:{bubbles:!0,cancelable:!0},dragend:{bubbles:!0,cancelable:!1},dragenter:{bubbles:!0,cancelable:!0},dragleave:{bubbles:!0,cancelable:!1},dragover:{bubbles:!0,cancelable:!0},dragstart:{bubbles:!0,cancelable:!0},drop:{bubbles:!0,cancelable:!0},error:{bubbles:function(t){return!(XMLHttpRequest.prototype.isPrototypeOf(t)||t.tagName&&"VIDEO"===t.tagName.toUpperCase()||t.tagName&&"AUDIO"===t.tagName.toUpperCase())},cancelable:!1},focus:{bubbles:!1,cancelable:!1},focusin:{bubbles:!0,cancelable:!1},focusout:{bubbles:!0,cancelable:!1},input:{bubbles:!0,cancelable:!1},keydown:{bubbles:!0,cancelable:!1},keypress:{bubbles:!0,cancelable:!1},keyup:{bubbles:!0,cancelable:!1},load:{bubbles:!1,cancelable:!1},loadend:{bubbles:!1,cancelable:!1},loadstart:{bubbles:!1,cancelable:!1},message:{bubbles:!1,cancelable:!1},mousedown:{bubbles:!0,cancelable:!0},mouseenter:{bubbles:!1,cancelable:!1},mouseleave:{bubbles:!1,cancelable:!1},mousemove:{bubbles:!0,cancelable:!0},mouseout:{bubbles:!0,cancelable:!0},mouseover:{bubbles:!0,cancelable:!0},mouseup:{bubbles:!0,cancelable:!0},mousewheel:{bubbles:!0},orientationchange:{bubbles:!1},paste:{bubbles:!0,cancelable:!0},progress:{bubbles:!1,cancelable:!1},reset:{bubbles:!0,cancelable:!1},resize:{bubbles:!1,cancelable:!1},scroll:{bubbles:function(t){return!!t.defaultView},cancelable:!1},select:{bubbles:!0,cancelable:!1},submit:{bubbles:!0,cancelable:!0},touchcancel:{bubbles:!0,cancelable:!1},touchend:{bubbles:!0,cancelable:!0},touchmove:{bubbles:!0,cancelable:!0},touchstart:{bubbles:!0,cancelable:!0},unload:{bubbles:!1,cancelable:!1},wheel:{bubbles:!0,cancelable:!0},pointerdown:{bubbles:!0,cancelable:!0},pointerup:{bubbles:!0,cancelable:!0},pointerenter:{bubbles:!1,cancelable:!0},pointercancel:{bubbles:!0,cancelable:!0},pointerout:{bubbles:!0,cancelable:!0},pointerover:{bubbles:!0,cancelable:!0},pointerleave:{bubbles:!1,cancelable:!0},pointermove:{bubbles:!0,cancelable:!0},MSPointerDown:{bubbles:!0,cancelable:!0},MSPointerMove:{bubbles:!0,cancelable:!0},MSPointerUp:{bubbles:!0,cancelable:!0},MSPointerOver:{bubbles:!0,cancelable:!0},MSPointerOut:{bubbles:!0,cancelable:!0},MSPointerHover:{bubbles:!0,cancelable:!0}}},_DOMPasteboardElement:{value:null,enumerable:!1},_delegate:{value:null,enumerable:!1},delegate:{enumerable:!1,get:function(){return this._delegate},set:function(t){this._delegate=t}},_application:{value:null,enumerable:!1},application:{enumerable:!1,get:function(){return this._application},set:function(t){this._application=t}},_registeredWindows:{value:null,enumerable:!1},_windowsAwaitingFinalRegistration:{value:{},enumerable:!1},initWithWindow:{enumerable:!1,value:function(t){if(this._registeredWindows)throw"EventManager has already been initialized";return this.registerWindow(t),this}},registerWindow:{enumerable:!1,value:function(t){if(t.defaultEventManager&&t.defaultEventManager!==this)throw"EventManager cannot register a window already registered to another EventManager";if(this._registeredWindows&&this._registeredWindows.indexOf(t)>=0)throw"EventManager cannot register a window more than once";if(this._registeredWindows||(this._registeredWindows=[]),t.uuid&&0!==t.uuid.length||(t.uuid=UUID.generate()),this._windowsAwaitingFinalRegistration[t.uuid]!==t){if(t.Element.prototype.nativeAddEventListener=t.Element.prototype.addEventListener,Object.defineProperty(t,"nativeAddEventListener",{configurable:!0,value:t.addEventListener}),Object.getPrototypeOf(t.document).nativeAddEventListener=t.document.addEventListener,t.XMLHttpRequest.prototype.nativeAddEventListener=t.XMLHttpRequest.prototype.addEventListener,t.Worker&&(t.Worker.prototype.nativeAddEventListener=t.Worker.prototype.addEventListener),t.MediaController&&(t.MediaController.prototype.nativeAddEventListener=t.MediaController.prototype.addEventListener),t.Element.prototype.nativeRemoveEventListener=t.Element.prototype.removeEventListener,Object.defineProperty(t,"nativeRemoveEventListener",{configurable:!0,value:t.removeEventListener}),Object.getPrototypeOf(t.document).nativeRemoveEventListener=t.document.removeEventListener,t.XMLHttpRequest.prototype.nativeRemoveEventListener=t.XMLHttpRequest.prototype.removeEventListener,t.Worker&&(t.Worker.prototype.nativeRemoveEventListener=t.Worker.prototype.removeEventListener),t.MediaController&&(t.MediaController.prototype.nativeRemoveEventListener=t.MediaController.prototype.removeEventListener),Object.defineProperty(t,"addEventListener",{configurable:!0,value:t.XMLHttpRequest.prototype.addEventListener=t.Element.prototype.addEventListener=Object.getPrototypeOf(t.document).addEventListener=function(e,n,i){return t.defaultEventManager.registerEventListener(this,e,n,!!i)}}),t.Worker&&(t.Worker.prototype.addEventListener=t.addEventListener),t.MediaController&&(t.MediaController.prototype.addEventListener=t.addEventListener),Object.defineProperty(t,"removeEventListener",{configurable:!0,value:t.XMLHttpRequest.prototype.removeEventListener=t.Element.prototype.removeEventListener=Object.getPrototypeOf(t.document).removeEventListener=function(e,n,i){return t.defaultEventManager.unregisterEventListener(this,e,n,!!i)}}),t.Worker&&(t.Worker.prototype.removeEventListener=t.removeEventListener),t.MediaController&&(t.MediaController.prototype.removeEventListener=t.removeEventListener),t.HTMLDivElement.prototype.addEventListener!==t.Element.prototype.nativeAddEventListener&&t.HTMLElement&&"addEventListener"in t.HTMLElement.prototype){var e,n,i=Object.getOwnPropertyNames(t),r=0,a=i.length;for(r;a>r;r++)e=i[r],e.match(/^HTML\w*Element$/)&&"function"==typeof e&&(n=e.prototype,n.nativeAddEventListener=n.addEventListener,n.addEventListener=t.Element.prototype.addEventListener,n.nativeRemoveEventListener=n.removeEventListener,n.removeEventListener=t.Element.prototype.removeEventListener)}Montage.defineProperty(t.Element.prototype,"eventHandlerUUID",{value:void 0,enumerable:!1}),Montage.defineProperty(t.Element.prototype,"component",{get:function(){return defaultEventManager._elementEventHandlerByUUID[this.eventHandlerUUID]},enumerable:!1}),defaultEventManager=t.defaultEventManager=exports.defaultEventManager=this,this._registeredWindows.push(t),this._windowsAwaitingFinalRegistration[t.uuid]=t,/loaded|complete|interactive/.test(t.document.readyState)?this._finalizeWindowRegistration(t):t.document.addEventListener("DOMContentLoaded",this,!0)}}},_finalizeWindowRegistration:{enumerable:!1,value:function(t){if(this._windowsAwaitingFinalRegistration[t.uuid]!==t)throw"EventManager wasn't expecting to register this window";delete this._windowsAwaitingFinalRegistration[t.uuid],this._listenToWindow(t)}},unregisterWindow:{enumerable:!1,value:function(t){if(0>this._registeredWindows.indexOf(t))throw"EventManager cannot unregister an unregistered window";if(this._registeredWindows=this._registeredWindows.filter(function(e){return t!==e}),delete t.defaultEventManager,t.Element.prototype.addEventListener=t.Element.prototype.nativeAddEventListener,Object.defineProperty(t,"addEventListener",{configurable:!0,value:t.nativeAddEventListener}),Object.getPrototypeOf(t.document).addEventListener=t.document.nativeAddEventListener,t.XMLHttpRequest.prototype.addEventListener=t.XMLHttpRequest.prototype.nativeAddEventListener,t.Worker&&(t.Worker.prototype.addEventListener=t.Worker.prototype.nativeAddEventListener),t.Element.prototype.removeEventListener=t.Element.prototype.nativeRemoveEventListener,Object.defineProperty(t,"removeEventListener",{configurable:!0,value:t.nativeRemoveEventListener}),Object.getPrototypeOf(t.document).removeEventListener=t.document.nativeRemoveEventListener,t.XMLHttpRequest.prototype.removeEventListener=t.XMLHttpRequest.prototype.nativeRemoveEventListener,t.Worker&&(t.Worker.prototype.removeEventListener=t.Worker.prototype.nativeRemoveEventListener),t.HTMLDivElement.prototype.nativeAddEventListener!==t.Element.prototype.addEventListener&&t.HTMLElement&&"addEventListener"in t.HTMLElement.prototype&&t.Components&&t.Components.interfaces){var e,n;for(e in Components.interfaces)e.match(/^nsIDOMHTML\w*Element$/)&&(e=e.replace(/^nsIDOM/,""),(e=window[e])&&(n=e.prototype,n.addEventListener=n.nativeAddEventListener,delete n.nativeAddEventListener,n.removeEventListener=n.nativeRemoveEventListener,delete n.nativeRemoveEventListener))}delete t.Element.prototype.nativeAddEventListener,delete t.nativeAddEventListener,delete Object.getPrototypeOf(t.document).nativeAddEventListener,delete t.XMLHttpRequest.prototype.nativeAddEventListener,t.Worker&&delete t.Worker.prototype.nativeAddEventListener,delete t.Element.prototype.nativeRemoveEventListener,delete t.nativeRemoveEventListener,delete Object.getPrototypeOf(t.document).nativeRemoveEventListener,delete t.XMLHttpRequest.prototype.nativeRemoveEventListener,t.Worker&&delete t.Worker.prototype.nativeRemoveEventListener,delete t.Element.prototype.eventHandlerUUID,delete t.Element.prototype.component,this._stopListeningToWindow(t)}},unregisterWindows:{enumerable:!1,value:function(){this._registeredWindows.forEach(this.unregisterWindow)}},registeredEventListeners:{enumerable:!1,value:{}},registeredEventListenersForEventType_:{value:function(t){var e,n,i,r,a=this.registeredEventListeners[t];if(!a)return null;r={};for(e in a){n=a[e].listeners;for(i in n)r[i]=n[i]}return r}},registeredEventListenersForEventType_onTarget_:{enumerable:!1,value:function(t,e,n){var i,r;return i=e===n?n.eventManager.registeredEventListeners[t]:this.registeredEventListeners[t],i&&e?(r=i[e.uuid],r?r.listeners:null):null}},registeredEventListenersOnTarget_:{value:function(t){var e,n,i=[];for(e in this.registeredEventListeners)n=this.registeredEventListeners[e],t.uuid in n&&i.push(n);return i}},registerEventListener:{enumerable:!1,value:function(t,e,n,i){var r,a,s,o=this.registeredEventListeners[e],l=!1,c=!1;if(t.uuid===void 0)throw Error("EventManager cannot observe a target without a uuid: "+(t.outerHTML||t));return o?((r=o[t.uuid])||((r=o[t.uuid]=_TargetRegistration.checkoutRegistration()).target=t,l=!0),a=r.listeners[n.uuid],s=i?"capture":"bubble",a?(a[s]=!0,c=!0):(r.listeners[n.uuid]=_TargetListenerRegistration.checkoutRegistration().initWithListener(n,i,!i),c=!0)):(o=this.registeredEventListeners[e]={},(o[t.uuid]=_TargetRegistration.checkoutRegistration()).target=t,o[t.uuid].listeners[n.uuid]=_TargetListenerRegistration.checkoutRegistration().initWithListener(n,i,!i),l=!0,c=!0),l&&"function"==typeof t.nativeAddEventListener&&this._observeTarget_forEventType_(t,e),c}},unregisterEventListener:{enumerable:!1,value:function(t,e,n,i){var r,a,s,o,l,c=this.registeredEventListeners[e];if(c&&(r=c[t.uuid])){if(a=r.listeners[n.uuid],!a){for(o in r.listeners)if(l=r.listeners[o].listener,l.originalListener&&l.originalListener.uuid===n.uuid){a=r.listeners[o],n=l;break}if(!a)return}s=i?"capture":"bubble",a[s]=!1,a.bubble||a.capture||(_TargetListenerRegistration.checkinRegistration(r.listeners[n.uuid]),delete r.listeners[n.uuid],0===Object.keys(r.listeners).length&&(delete c[t.uuid],_TargetRegistration.checkinRegistration(r),0===Object.keys(c).length&&(delete this.registeredEventListeners[e],this._stopObservingTarget_forEventType_(t,e))))}}},actualDOMTargetForEventTypeOnTarget:{value:function(t,e){if(e.nativeAddEventListener){if(e.defaultView)return e;var n,i=this.eventDefinitions[t];return i?(n=typeof i.bubbles===FUNCTION_TYPE?i.bubbles(e):i.bubbles,n?e.screen?e.document:e.ownerDocument:e):e}return null}},_observedTarget_byEventType_:{value:{}},_observeTarget_forEventType_:{enumerable:!1,value:function(t,e){var n;!(n=this.actualDOMTargetForEventTypeOnTarget(e,t))||this._observedTarget_byEventType_[e]&&this._observedTarget_byEventType_[e][n.uuid]||(this._observedTarget_byEventType_[e]||(this._observedTarget_byEventType_[e]={}),this._observedTarget_byEventType_[e][n.uuid]=this,n.nativeAddEventListener(e,this,!0))}},_stopObservingTarget_forEventType_:{enumerable:!1,value:function(t,e){var n;n=this.actualDOMTargetForEventTypeOnTarget(e,t),n&&(delete this._observedTarget_byEventType_[e][n.uuid],n.nativeRemoveEventListener(e,this,!0))}},_activationHandler:{enumerable:!0,value:null},_listenToWindow:{enumerable:!1,value:function(t){if(!this._activationHandler){var e=this;this._activationHandler=function(t){var n;if(t.changedTouches){n=t.changedTouches.length;for(var i=0;n>i;i++)e._prepareComponentsForActivation(t.changedTouches[i].target)}else e._prepareComponentsForActivation(t.target)}}if(window.PointerEvent?(t.nativeAddEventListener("pointerdown",this._activationHandler,!0),t.nativeAddEventListener("pointerenter",this._activationHandler,!0)):window.MSPointerEvent&&window.navigator.msPointerEnabled?(t.nativeAddEventListener("MSPointerDown",this._activationHandler,!0),t.document.nativeAddEventListener("mouseenter",this._activationHandler,!0)):(t.nativeAddEventListener("touchstart",this._activationHandler,!0),t.nativeAddEventListener("mousedown",this._activationHandler,!0),t.document.nativeAddEventListener("mouseenter",this._activationHandler,!0)),t.nativeAddEventListener("focus",this._activationHandler,!0),this.application){var n,i=this.registeredEventListenersOnTarget_(this.application);for(n in i)this._observeTarget_forEventType_(t,n)}}},_stopListeningToWindow:{enumerable:!1,value:function(t){var e,n,i=this.registeredEventListenersOnTarget_(this.application),r=this.registeredEventListenersOnTarget_(t);for(e in i)this._stopObservingTarget_forEventType_(t,e);for(e in r)this._stopObservingTarget_forEventType_(t,e);(n=this._listeningWindowOnTouchCancel.indexOf(t))>-1&&this._listeningWindowOnTouchCancel.splice(n,1)}},reset:{enumerable:!1,value:function(){var t,e,n,i;for(t in this.registeredEventListeners){e=this.registeredEventListeners[t];for(n in e.targets)i=e.targets[n],this._stopObservingTarget_forEventType_(i.target,t)}this.registeredEventListeners={},this._claimedPointers={}}},unload:{enumerable:!1,value:function(){this._stopListening()}},methodNameForBubblePhaseOfEventType:{enumerable:!1,value:function(t,e){return function(n,i){var r;return i?(r=e[n]||(e[n]=Object.create(null)),r[i]||(r[i]="handle"+i.toCapitalized()+n.toCapitalized())):t[n]||(t[n]="handle"+n.toCapitalized())}}(Object.create(null),Object.create(null))},_methodNameForCapturePhaseByEventType_:{value:{}},methodNameForCapturePhaseOfEventType:{enumerable:!1,value:function(t,e){return function(n,i){var r;return i?(r=e[n]||(e[n]=Object.create(null)),r[i]||(r[i]="capture"+i.toCapitalized()+n.toCapitalized())):t[n]||(t[n]="capture"+n.toCapitalized())}}(Object.create(null),Object.create(null))},_claimedPointers:{enumerable:!1,distinct:!0,value:{}},componentClaimingPointer:{value:function(t){return this._claimedPointers[t]}},isPointerClaimedByComponent:{value:function(t,e){if(!e)throw"Must specify a valid component to see if it claims the specified pointer, '"+e+"' is not valid.";return this._claimedPointers[t]===e}},claimPointer:{value:function(t,e){if(!t&&0!==t)throw"Must specify a valid pointer to claim, '"+t+"' is not valid.";if(!e)throw"Must specify a valid component to claim a pointer, '"+e+"' is not valid.";var n=this._claimedPointers[t];return n===e?!0:n?n.surrenderPointer(t,e)?(this._claimedPointers[t]=e,!0):!1:(this._claimedPointers[t]=e,!0)}},forfeitPointer:{value:function(t,e){if(e!==this._claimedPointers[t])throw"Not allowed to forfeit pointer '"+t+"' claimed by another component";delete this._claimedPointers[t]}},forfeitAllPointers:{value:function(t){var e,n;for(e in this._claimedPointers)n=this._claimedPointers[e],t===n&&delete this._claimedPointers[e]}},_isStoringPointerEvents:{enumerable:!1,value:!1},isStoringPointerEvents:{enumerable:!0,get:function(){return this._isStoringPointerEvents},set:function(t){t===!0?this._isStoringPointerEvents||(this._isStoringPointerEvents=!0,window.PointerEvent||window.MSPointerEvent&&window.navigator.msPointerEnabled?Object.defineProperty(MutableEvent.prototype,"velocity",{get:function(){return defaultEventManager.pointerMotion(this.pointerId).velocity}}):window.Touch&&Object.defineProperty(Touch.prototype,"velocity",{get:function(){return defaultEventManager.pointerMotion(this.identifier).velocity}})):(this._isStoringPointerEvents=!1,this._pointerStorage.memory={},this._isMouseDragging=!1)}},_isStoringMouseEventsWhileDraggingOnly:{enumerable:!1,value:!0},isStoringMouseEventsWhileDraggingOnly:{enumerable:!0,get:function(){return this._isStoringMouseEventsWhileDraggingOnly},set:function(t){this._isStoringMouseEventsWhileDraggingOnly=t===!0?!0:!1}},_isMouseDragging:{enumerable:!1,value:!1},_pointerStorage:{enumerable:!1,value:{memory:{},add:function(t,e){this.memory[t]||(this.memory[t]={data:Array(32),size:0,pos:0}),this.memory[t].data[this.memory[t].pos]=e,this.memory[t].size<this.memory[t].data.length&&this.memory[t].size++,this.memory[t].pos=(this.memory[t].pos+1)%this.memory[t].data.length},remove:function(t){delete this.memory[t]},clear:function(t){this.memory[t]&&(this.memory[t].size=0)},getMemory:function(t){return this.memory[t]},isStored:function(t){return this.memory[t]&&this.memory[t].size>0},storeEvent:function(t){var e=!!(window.PointerEvent||window.MSPointerEvent&&window.navigator.msPointerEnabled),n=t instanceof MutableEvent?t._event:t;if(e&&("mouse"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)||!e&&n instanceof MouseEvent)switch(t.type){case"pointerdown":case"MSPointerDown":case"mousedown":defaultEventManager._isMouseDragging=!0;case"pointermove":case"MSPointerMove":case"mousemove":defaultEventManager._isStoringMouseEventsWhileDraggingOnly?defaultEventManager._isMouseDragging&&this._storeMouse(t):this._storeMouse(t);break;case"pointerup":case"MSPointerUp":case"mouseup":this._storeMouse(t)}else if(e&&("touch"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)||void 0!==window.TouchEvent&&!e&&n instanceof TouchEvent)switch(t.type){case"pointerdown":case"MSPointerDown":case"pointermove":case"MSPointerMove":case"pointerup":case"MSPointerUp":this._storeTouch(t.pointerId,t.clientX,t.clientY,t.timeStamp);break;case"touchstart":case"touchmove":this._storeTouches(t.touches,t.timeStamp);break;case"touchend":this._storeTouches(t.changedTouches,t.timeStamp)}},removeEvent:function(t){var e=!!(window.PointerEvent||window.MSPointerEvent&&window.navigator.msPointerEnabled),n=t instanceof MutableEvent?t._event:t;if(e&&("mouse"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)||!e&&n instanceof MouseEvent)("mouseup"===t.type||"pointerup"===t.type||"MSPointerUp"===t.type)&&(defaultEventManager._isMouseDragging=!1,defaultEventManager._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse"));else if((e&&("touch"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)||void 0!==window.TouchEvent&&!e&&n instanceof TouchEvent)&&("touchend"===t.type||"pointerup"===t.type||"MSPointerUp"===t.type))if(t.changedTouches)for(var i=0;t.changedTouches.length>i;i++)this.remove(t.changedTouches[i].identifier);else this.remove(t.pointerId)},_storeMouse:function(t){this.add("mouse",{clientX:t.clientX,clientY:t.clientY,timeStamp:t.timeStamp}),Object.defineProperty(t,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity}})},_storeTouches:function(t,e){for(var n,i=0;t.length>i;i++)n=t[i],this._storeTouch(n.identifier,n.clientX,n.clientY,e)},_storeTouch:function(t,e,n,i){this.add(t,{clientX:e,clientY:n,timeStamp:i})}}},_getPointerVelocityData:{enumerable:!1,value:function(t){var e,n,i,r,a,s,o,l,c,h=0,u=!0,d={x:[],y:[],time:[]};for(e=defaultEventManager._pointerStorage.getMemory(t),n=e.data.length,i=e.data[(e.pos-1+n)%n],r=a=s=i.timeStamp,o=i.clientX,l=i.clientY;u&&a>r-350&&e.size>h;)i=e.data[(e.pos-h-1+n)%n],a=i.timeStamp,c=o*o+l*l,c>2&&50>=s-a?(d.x.push(i.clientX),d.y.push(i.clientY),d.time.push(a),s=a,o=i.clientX,l=i.clientY,h++):u=!1;return d}},_fitPointerCurve:{enumerable:!1,value:function(t,e){var n,i,r,a,s,o,l,c,h,u,d,p,m,g,f,v,_,y,C,b,L,w,x,M,T,E,S,A,O,P,z,D,R,I,B,N,F,k,V=1e-4,G=e.length;do{for(d=0,p=0,m=0,g=0,f=0,v=0,y=0,C=0,b=0,L=0,w=0,x=0,T=0,E=0,S=0,A=0,O=0,P=0,D=0,R=0,I=0,B=0,N=0,F=0,u=0;G>u;u++)s=e[u],o=s.t,c=o*o,h=c*o,l=s.v,_=V*(6*(c-o)-h+2),M=6*V*(h-2*c+o),z=6*V*(c-h),k=2*V*h,v+=_*_,x+=M*M,P+=z*z,F+=k*k,d+=l*_,y+=l*M,T+=l*z,D+=l*k,m-=_,b-=M,S-=z,I-=k,p-=_*o,C-=M*o,E-=z*o,R-=k*o,g-=_*c,L-=M*c,A-=z*c,B-=k*c,f-=_*h,w-=M*h,O-=z*h,N-=k*h;V*=2}while(0===v||0===x||0===P||0===F);for(o=V/v,d*=o,p*=3*o,m*=o,g*=3*o,f*=o,o=V/x,y*=o,C*=3*o,b*=o,L*=3*o,w*=o,o=V/P,T*=o,E*=3*o,S*=o,A*=3*o,O*=o,o=V/F,D*=o,R*=3*o,I*=o,B*=3*o,N*=o,v=t[0],x=t[1],P=t[2],F=t[3],n=3*(x-P)+F-v,i=v+P-2*x,r=x-v,a=v,u=0;20>u;u++)o=d+a*m+r*p+i*g+n*f,v+=o,a+=o,n-=o,i+=o,r-=o,o=y+a*b+r*C+i*L+n*w,x+=o,n+=3*o,i-=o+o,r+=o,o=T+a*S+r*E+i*A+n*O,P+=o,n-=3*o,i+=o,o=D+a*I+r*R+i*B+n*N,F+=o,n+=o;t[0]=v,t[1]=x,t[2]=P,t[3]=F}},_pointerBezierValue:{enumerable:!1,value:function(t,e){var n=1-t;return n*n*n*e[0]+3*n*n*t*e[1]+3*n*t*t*e[2]+t*t*t*e[3]}},_calculatePointerVelocity:{enumerable:!1,value:function(t,e){var n,i,r=t.length,a=t[0],s=t[0],o=0;for(i=1;r>i;i++)a>t[i]&&(a=t[i],o=i);if(n=s-a){if(r>5){var l,c,h,u=[];for(i=0;r>i;i++)u[i]={v:e[i],t:(t[i]-a)/n};return l=u[o].v,c=u[0].v,h=[l,(2*l+c)/3,(l+2*c)/3,c],this._fitPointerCurve(h,u),5e3*(this._pointerBezierValue(.8,h)-this._pointerBezierValue(.6,h))/n}return r>1?1e3*(e[0]-e[o])/n:0}return 0}},pointerMotion:{value:function(t){if(defaultEventManager._pointerStorage.isStored(t)){var e={};return Object.defineProperties(e,{_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(t)),this._x=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(t)),this._y=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}),{velocity:e}}return void 0}},monitorDOMModificationInEventHandling:{value:!1},domModificationEventHandler:{value:Montage.specialize({handleEvent:{value:function(){throw"DOM Modified"}},captureDOMSubtreeModified:{value:function(){throw"DOMSubtreeModified"}},captureDOMAttrModified:{value:function(){throw"DOMAttrModified"}},captureDOMCharacterDataModified:{value:function(){throw"DOMCharacterDataModified"}}})},_touchNeedTracking:{value:["touchstart","touchend"]},_mouseEventTypeEmulatedList:{value:["mousedown","mouseup","click"]},_trackingTouchList:{value:null},_trackingTouchTimeoutIDs:{value:Object.create(null)},__isIOSPlatform:{value:null},_isIOSPlatform:{get:function(){return this.__isIOSPlatform=this.__isIOSPlatform||/iphone|ipod|ipad/gi.test(navigator.platform)}},_wouldTouchTriggerSimulatedEvent:{value:function(t){return this._touchNeedTracking.indexOf(t.type)>-1}},_couldEventBeSimulated:{value:function(t){return this._mouseEventTypeEmulatedList.indexOf(t.type)>-1}},_listeningWindowOnTouchCancel:{value:[]},_findWindowFromEvent:{value:function(t){var e,n=t.target;return n&&(e=n instanceof Window?n:n.defaultView instanceof Window?n.defaultView:n.ownerDocument&&n.ownerDocument.defaultView?n.ownerDocument.defaultView:null),e}},_isWindowListeningOnTouchCancel:{value:function(t){return this._registeredWindows.indexOf(t)>-1&&this._listeningWindowOnTouchCancel.indexOf(t)>-1}},_listenToTouchCancelIfNeeded:{value:function(t){var e=this._findWindowFromEvent(t);if(e&&!this._isWindowListeningOnTouchCancel(e)){var n=this;e.addEventListener("touchcancel",function(t){for(var e,i=t.changedTouches,r=n._trackingTouchList.touchesStart,a=0,s=i.length;s>a;a++)e=i[a].identifier,r[e]&&delete r[e]},!0),this._listeningWindowOnTouchCancel.push(e)}}},blocksEmulatedEvents:{value:!0},_shouldDispatchEvent:{value:function(t){if(!(!this.blocksEmulatedEvents||window.PointerEvent||window.MSPointerEvent&&window.navigator.msPointerEnabled)){if(this._isIOSPlatform)return!(0===t.timeStamp);if(this._wouldTouchTriggerSimulatedEvent(t)){var e=t.changedTouches;this._listenToTouchCancelIfNeeded(t);for(var n=0,i=e.length;i>n;n++)this._trackTouch(t,e[n].identifier)}else if(this._couldEventBeSimulated(t))return!this._isEmulatedEvent(t)}return!0}},_trackTouch:{value:function(t,e){var n=this._trackingTouchList,i=this._trackingTouchTimeoutIDs;
if("touchstart"===t.type){var r=i[e];r&&(clearTimeout(r),delete i[e]),n.touchesStart[e]=t.target}else i[e]=setTimeout(function(){delete n.touchesEnd[e],delete i[e]},300),delete n.touchesStart[e],n.touchesEnd[e]=t.target}},_isEmulatedEvent:{value:function(t){var e,n=this._trackingTouchList.touchesStart,i=t.target,r=!1;for(e in n)if(r=n[e]===i)break;if(!r){n=this._trackingTouchList.touchesEnd;for(e in n)if(r=n[e]===i)break;if(r&&"click"===t.type){var a=this._trackingTouchTimeoutIDs,s=a[e];s&&(clearTimeout(s),delete n[e],delete a[e])}}return r}},handleEvent:{enumerable:!1,value:function(t){if(!this._shouldDispatchEvent(t))return void 0;this.monitorDOMModificationInEventHandling&&(document.body.addEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0));var e,n,i,r,a,s,o,l,c,h,u,d,p,m,g=t.type,f=t.bubbles;for("DOMContentLoaded"===g&&(e=t.target.defaultView,e&&this._windowsAwaitingFinalRegistration[e.uuid]&&(this._finalizeWindowRegistration(e),t.target.removeEventListener("DOMContentLoaded",this,!0))),m="boolean"!=typeof t.propagationStopped?MutableEvent.fromEvent(t):t,c=Element.isElement(m.target)||m.target instanceof Document||m.target===window?this._eventPathForDomTarget(m.target):this._eventPathForTarget(m.target),d=m.target.identifier?this.methodNameForCapturePhaseOfEventType(g,m.target.identifier):null,p=m.target.identifier?this.methodNameForBubblePhaseOfEventType(g,m.target.identifier):null,h=this.methodNameForCapturePhaseOfEventType(g),u=this.methodNameForBubblePhaseOfEventType(g),this.delegate&&typeof this.delegate.willDistributeEvent===FUNCTION_TYPE&&this.delegate.willDistributeEvent(m),this._isStoringPointerEvents&&this._pointerStorage.storeEvent(m),m.eventPhase=CAPTURING_PHASE,n=c.length-1;!m.propagationStopped&&(i=c[n]);n--)if(m.currentTarget=i,r=this.registeredEventListenersForEventType_onTarget_(g,i))for(o=Object.keys(r),a=0;r&&!m.immediatePropagationStopped&&(s=r[o[a]]);a++)s.capture&&(l=s.listener,this._invokeTargetListenerForEvent(i,l,m,d,h));if(!m.propagationStopped&&(m.eventPhase=AT_TARGET,m.currentTarget=i=m.target,r=this.registeredEventListenersForEventType_onTarget_(g,i)))for(o=Object.keys(r),a=0;r&&!m.immediatePropagationStopped&&(s=r[o[a]]);a++)l=s.listener,s.capture&&this._invokeTargetListenerForEvent(i,l,m,d,h),s.bubble&&this._invokeTargetListenerForEvent(i,l,m,p,u);for(m.eventPhase=BUBBLING_PHASE,n=0;f&&!m.propagationStopped&&(i=c[n]);n++)if(m.currentTarget=i,r=this.registeredEventListenersForEventType_onTarget_(g,i))for(o=Object.keys(r),a=0;r&&!m.immediatePropagationStopped&&(s=r[o[a]]);a++)s.bubble&&(l=s.listener,this._invokeTargetListenerForEvent(i,l,m,p,u));m.eventPhase=NONE,m.currentTarget=null,this._isStoringPointerEvents&&this._pointerStorage.removeEvent(t),this.monitorDOMModificationInEventHandling&&(document.body.removeEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0))}},_invokeTargetListenerForEvent:{value:function(t,e,n,i,r){var a;i&&typeof(a=e[i])===FUNCTION_TYPE||typeof(a=e[r])===FUNCTION_TYPE||typeof(a=e.handleEvent)===FUNCTION_TYPE?a.call(e,n):typeof e===FUNCTION_TYPE&&e.call(t,n)}},_prepareComponentsForActivation:{value:function(t){var e,n,i=t,r=i&&i.defaultView?i.defaultView:window,a=r.document?r.document:document,s=!1,o=null;do switch(i&&(n=this.eventHandlerForElement(i),n&&(s||(s=!0,o=this._findActiveTarget(n)),n.preparedForActivationEvents||n._prepareForActivationEvents())),e=i,i){case r:i=null;break;case a:i=r;break;case a.documentElement:i=a;break;default:i=i.parentNode}while(i&&e!==i);this.activeTarget=o}},_findActiveTarget:{value:function(t){for(var e=null,n={};!e&&t&&!(t.uuid in n);)n[t.uuid]=t,t.acceptsActiveTarget?e=t:t=t.nextTarget;return e}},_eventPathForTarget:{enumerable:!1,value:function(t){if(!t)return[];var e=t,n=this.application,i=[],r={};r[t.uuid]=t;do e.uuid in r||(i.push(e),r[e.uuid]=e),e=e.nextTarget,(!e||e.uuid in r)&&(e=n),e&&e.uuid in r&&(e=null);while(e);return i}},_eventPathForDomTarget:{enumerable:!1,value:function(t){if(!t)return[];var e,n=t,i=n&&n.defaultView?n.defaultView:window,r=i.document?i.document:document,a=this.application,s=[];do switch(n!==t&&s.push(n),e=n,n){case a:n=n.parentApplication,n&&(a=n);break;case i:n=a;break;case r:n=i;break;case r.documentElement:n=r;break;default:n=n.parentNode,n||(n=a)}while(n&&e!==n);return s}},_elementEventHandlerByUUID:{enumerable:!1,value:{}},registerEventHandlerForElement:{enumerable:!1,value:function(t,e){var n=this.eventHandlerForElement(e);n&&this.unregisterEventHandlerForElement(e),this._elementEventHandlerByUUID[e.eventHandlerUUID=t.uuid]=t}},unregisterEventHandlerForElement:{enumerable:!1,value:function(t){delete this._elementEventHandlerByUUID[t.eventHandlerUUID],delete t.eventHandlerUUID}},eventHandlerForElement:{enumerable:!1,value:function(t){return this._elementEventHandlerByUUID[t.eventHandlerUUID]}},_activeTarget:{value:null},activeTarget:{get:function(){return this._activeTarget||this.application},set:function(t){t||(t=this.application),t===this._activeTarget||this.activeTarget&&!this.activeTarget.surrendersActiveTarget(t)||(t.willBecomeActiveTarget(this.activeTarget),this._activeTarget=t,t.didBecomeActiveTarget())}}})}