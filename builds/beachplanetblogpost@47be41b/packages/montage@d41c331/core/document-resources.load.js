montageDefine("d41c331","core/document-resources",{dependencies:["./core","./promise","./mini-url"],factory:function(t,e){var n=t("./core").Montage,i=t("./promise").Promise,r=t("./mini-url"),a=n.specialize({_SCRIPT_TIMEOUT:{value:5e3},_document:{value:null},_resources:{value:null},_preloaded:{value:null},_expectedStyles:{value:null},constructor:{value:function a(){this.super(),this._expectedStyles=[],this._isPollingDocumentStyleSheets=!this._isLinkLoadEventAvailable()}},_webkitVersion:{value:function(){var t=/AppleWebKit\/([\d.]+)/.exec(navigator.userAgent);return t?parseInt(t[1]):null}},_isLinkLoadEventAvailable:{value:function(){var t=document.createElement("link"),e=this._webkitVersion();return"onload"in t?null!==e&&535>e?!1:!0:!1}},initWithDocument:{value:function(t){return this.clear(),this._document=t,this._populateWithDocument(t),this}},_populateWithDocument:{value:function(t){var e=t.querySelectorAll("script"),n=Array.prototype.forEach;n.call(e,function(t){t.src&&this._addResource(this.normalizeUrl(t.src))},this);var i=t.querySelectorAll("link");n.call(i,function(t){"stylesheet"===t.rel&&this._addResource(this.normalizeUrl(t.href))},this)}},clear:{value:function(){this._resources=Object.create(null),this._preloaded=Object.create(null)}},_addResource:{value:function(t){this._resources[t]=!0}},hasResource:{value:function(t){return t in this._resources}},isResourcePreloaded:{value:function(t){return this._preloaded[t]===!0}},isResourcePreloading:{value:function(t){return i.isPromise(this._preloaded[t])}},setResourcePreloadedPromise:{value:function(t,e){this._preloaded[t]=e}},setResourcePreloaded:{value:function(t){this._preloaded[t]=!0}},getResourcePreloadedPromise:{value:function(t){return this._preloaded[t]}},addScript:{value:function(t){var e=this.normalizeUrl(t.src);return e?this.isResourcePreloaded(e)?i.resolve():this.isResourcePreloading(e)?this.getResourcePreloadedPromise(e):this._importScript(t):this._importScript(t)}},_importScript:{value:function(t){var e,n,r=this,a=this._document,s=a.head,o=i.defer(),l=t.src;return l?(r._addResource(l),e=function(){r.setResourcePreloaded(l),t.removeEventListener("load",e,!1),t.removeEventListener("error",e,!1),clearTimeout(n),o.resolve()},t.addEventListener("load",e,!1),t.addEventListener("error",e,!1),n=setTimeout(function(){r.setResourcePreloaded(l),o.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(l,o.promise)):o.resolve(),s.appendChild(a.createComment("Inserted from FIXME")),s.appendChild(t),o.promise}},handleEvent:{value:function(t){var e,n=t.target;"LINK"===n.tagName&&(e=this._expectedStyles.indexOf(n.href),e>=0&&this._expectedStyles.splice(e,1),n.removeEventListener("load",this,!1),n.removeEventListener("error",this,!1))}},addStyle:{value:function(t){var e,n=t.getAttribute("href");if(n){if(n=this.normalizeUrl(n),this.hasResource(n))return;this._addResource(n),this._expectedStyles.push(n),this._isPollingDocumentStyleSheets||(t.setAttribute("href",n),t.addEventListener("load",this,!1),t.addEventListener("error",this,!1))}e=this._document.head,e.insertBefore(t,e.firstChild)}},normalizeUrl:{value:function(t,e){return e||(e=this._document.location.href),r.resolve(e,t)}},domain:{value:window.location.protocol+"//"+window.location.host},isCrossDomain:{value:function(t){return 0!==t.indexOf(this.domain+"/")||0===t.indexOf("file://")}},preloadResource:{value:function(t,e){var n;return t=this.normalizeUrl(t),!e&&this.isCrossDomain(t)&&(n=!0),n||this.isResourcePreloaded(t)?i.resolve():this.isResourcePreloading(t)?this.getResourcePreloadedPromise(t):this._preloadResource(t)}},_preloadResource:{value:function(t){var e,n,r=this,a=new XMLHttpRequest,s=i.defer();return a.open("GET",t),e=function(){r.setResourcePreloaded(t),a.removeEventListener("load",e),a.removeEventListener("error",e),clearTimeout(n),s.resolve()},a.addEventListener("load",e,!1),a.addEventListener("error",e,!1),a.send(),n=setTimeout(function(){r.setResourcePreloaded(t),s.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(t,s.promise),s.promise}},areStylesLoaded:{get:function(){var t,e;if(this._isPollingDocumentStyleSheets&&this._expectedStyles.length>0){t=this._document.styleSheets;for(var n,i=0;n=t[i];i++)e=this._expectedStyles.indexOf(n.href),e>=0&&this._expectedStyles.splice(e,1)}return 0===this._expectedStyles.length}}},{getInstanceForDocument:{value:function(t){var e=t.__montage_resources__;return e||(e=t.__montage_resources__=(new a).initWithDocument(t)),e}}});e.DocumentResources=a}});