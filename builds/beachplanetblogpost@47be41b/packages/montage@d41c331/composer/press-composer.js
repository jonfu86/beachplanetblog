var Montage=require("../core/core").Montage,Composer=require("./composer").Composer,MutableEvent=require("../core/event/mutable-event").MutableEvent,PressComposer=exports.PressComposer=Composer.specialize({load:{value:function(){window.PointerEvent?this._element.addEventListener("pointerdown",this,!0):window.MSPointerEvent&&window.navigator.msPointerEnabled?this._element.addEventListener("MSPointerDown",this,!0):(this._element.addEventListener("touchstart",this,!0),this._element.addEventListener("mousedown",this,!0))}},unload:{value:function(){window.PointerEvent?this._element.removeEventListener("pointerdown",this,!0):window.MSPointerEvent&&window.navigator.msPointerEnabled?this._element.removeEventListener("MSPointerDown",this,!0):(this._element.removeEventListener("touchstart",this,!0),this._element.removeEventListener("mousedown",this,!0))}},delegate:{value:null},cancelPress:{value:function(){return this._state===PressComposer.PRESSED?(this._cancelPress(),!0):!1}},_cancelPress:{value:function(t){this._dispatchPressCancel(t),this._endInteraction()}},addEventListener:{value:function(t,e,n){Composer.addEventListener.call(this,t,e,n),"longPress"===t&&(this._shouldDispatchLongPress=!0)}},UNPRESSED:{value:0},PRESSED:{value:1},CANCELLED:{value:2},_state:{value:0},state:{get:function(){return this._state}},_shouldDispatchLongPress:{value:!1},_longPressThreshold:{value:1e3},longPressThreshold:{get:function(){return this._longPressThreshold},set:function(t){this._longPressThreshold!==t&&(this._longPressThreshold=t)}},_longPressTimeout:{value:null},_observedPointer:{value:null},_initialCenterPositionX:{value:0},_initialCenterPositionY:{value:0},_shouldSaveInitialCenterPosition:{value:!1},_endInteraction:{value:function(){this._element&&(this._removeEventListeners(),this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)&&this.component.eventManager.forfeitPointer(this._observedPointer,this),this._observedPointer=null,this._state=PressComposer.UNPRESSED,this._initialCenterPositionX=0,this._initialCenterPositionY=0,this._shouldSaveInitialCenterPosition=!1)}},_changedTouchisObserved:{value:function(t){if(null===this._observedPointer)return!1;for(var e=0,n=t.length;n>e;e++)if(t[e].identifier===this._observedPointer)return e;return!1}},surrenderPointer:{value:function(t,e){var n=this.callDelegateMethod("surrenderPointer",t,e);return n!==void 0&&n===!1?!1:(this._cancelPress(),!0)}},_shouldPerformPress:{value:function(){return!("enabled"in this.component&&!this.component.enabled||null!==this._observedPointer)}},capturePointerdown:{value:function(t){"touch"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH?this.captureTouchstart(t):("mouse"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)&&this.captureMousedown(t)}},handlePointerup:{value:function(t){"touch"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH?this.handleTouchend(t):("mouse"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)&&this.handleMouseup(t)}},handlePointercancel:{value:function(t){("touch"===t.pointerType||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)&&this.handleTouchcancel(t)}},captureTouchstart:{value:function(t){this._shouldPerformPress()&&(void 0!==t.pointerId?this._observedPointer=t.pointerId:t.changedTouches&&1===t.changedTouches.length&&(this._observedPointer=t.changedTouches[0].identifier),null!==this._observedPointer&&this.component.eventManager.claimPointer(this._observedPointer,this)?(this._shouldSaveInitialCenterPosition=!0,this._addEventListeners(),this._dispatchPressStart(t)):this._observedPointer=null)}},handleTouchend:{value:function(t){if(null===this._observedPointer)return this._endInteraction(t),void 0;var e;if(t.pointerId===this._observedPointer)e=t.target;else if(this._changedTouchisObserved(t.changedTouches)!==!1){var n=t.changedTouches[0];e=document.elementFromPoint(n.clientX,n.clientY)}e&&this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)&&(this.element===e||this.element.contains(e)?this._dispatchPress(t):this._dispatchPressCancel(t),this._endInteraction(t))}},_saveInitialCenterPositionIfNeeded:{value:function(){this._shouldSaveInitialCenterPosition&&(this._saveInitialCenterPosition(),this._shouldSaveInitialCenterPosition=!1)}},_handleMove:{value:function(t){return null===this._observedPointer?(this._endInteraction(t),void 0):(("mouse"===this._observedPointer||t.pointerId===this._observedPointer||t.changedTouches&&this._changedTouchisObserved(t.changedTouches)!==!1)&&this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)&&(this._saveInitialCenterPositionIfNeeded(),this._positionChanged&&this._cancelPress(t)),void 0)}},captureWheel:{value:function(t){return null===this._observedPointer?(this._endInteraction(t),void 0):((t.target===this.element||t.target===window||"function"==typeof t.target.contains&&t.target.contains(this.element)||this.element.contains(t.target))&&(this._saveInitialCenterPositionIfNeeded(),this._positionChanged&&this._cancelPress(t)),void 0)}},handleTouchcancel:{value:function(t){(null===this._observedPointer||t.pointerId===this._observedPointer||this._changedTouchisObserved(t.changedTouches)!==!1)&&(this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)&&this._dispatchPressCancel(t),this._endInteraction(t))}},captureMousedown:{value:function(t){0===t.button&&this._shouldPerformPress()&&(this._observedPointer="mouse",this.component.eventManager.claimPointer(this._observedPointer,this),this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)?(this._shouldSaveInitialCenterPosition=!0,this._addEventListeners(),this._dispatchPressStart(t)):this._observedPointer=null)}},captureScroll:{value:function(t){(t.target===this.element||t.target===window||"function"==typeof t.target.contains&&t.target.contains(this.element)||this.element.contains(t.target))&&this._cancelPress(t)}},handleMouseup:{value:function(t){if(null===this._observedPointer)return this._endInteraction(t),void 0;if(this.component.eventManager.isPointerClaimedByComponent(this._observedPointer,this)){for(var e=t.target;e!==this._element&&e&&e.parentNode;)e=e.parentNode;if(e===this._element)return this._dispatchPress(t),this._endInteraction(t),void 0}this._cancelPress(t)}},handleDragstart:{value:function(t){this._cancelPress(t)}},_saveInitialCenterPosition:{value:function(){var t=this.element.getBoundingClientRect();this._initialCenterPositionX=t.left+t.width/2,this._initialCenterPositionY=t.top+t.height/2}},_positionChanged:{get:function(){var t=this.element.getBoundingClientRect(),e=t.left+t.width/2,n=t.top+t.height/2;return this._initialCenterPositionX!==e||this._initialCenterPositionY!==n}},_addEventListeners:{value:function(){window.PointerEvent?(document.addEventListener("pointerup",this,!1),document.addEventListener("pointermove",this,!1),document.addEventListener("pointercancel",this,!1)):window.MSPointerEvent&&window.navigator.msPointerEnabled?(document.addEventListener("MSPointerUp",this,!1),document.addEventListener("MSPointerMove",this,!1),document.addEventListener("MSPointerCancel",this,!1)):"mouse"===this._observedPointer?(document.addEventListener("mouseup",this,!1),document.addEventListener("mousemove",this,!1),this._element.addEventListener("dragstart",this,!1)):(document.addEventListener("touchend",this,!1),document.addEventListener("touchcancel",this,!1),document.addEventListener("touchmove",this,!1));var t=window.onwheel!==void 0||window.WheelEvent!==void 0?"wheel":"mousewheel";document.addEventListener(t,this,!0),document.addEventListener("scroll",this,!0)}},_removeEventListeners:{value:function(){window.PointerEvent?(document.removeEventListener("pointerup",this,!1),document.removeEventListener("pointermove",this,!1),document.removeEventListener("pointercancel",this,!1)):window.MSPointerEvent&&window.navigator.msPointerEnabled?(document.removeEventListener("MSPointerUp",this,!1),document.removeEventListener("MSPointerMove",this,!1),document.removeEventListener("MSPointerCancel",this,!1)):"mouse"===this._observedPointer?(document.removeEventListener("mouseup",this,!1),document.removeEventListener("mousemove",this,!1),this._element.removeEventListener("dragstart",this,!1)):(document.removeEventListener("touchend",this,!1),document.removeEventListener("touchcancel",this,!1),document.removeEventListener("touchmove",this,!1));var t=window.onwheel!==void 0||window.WheelEvent!==void 0?"wheel":"mousewheel";document.removeEventListener(t,this,!0),document.removeEventListener("scroll",this,!0)}},_createPressEvent:{enumerable:!1,value:function(t,e){var n,i,r=e;return e||(e=document.createEvent("CustomEvent"),e.initCustomEvent(t,!0,!0,null)),n=new PressEvent,n.event=e,n.type=t,n.pointer=this._observedPointer,n.targetElement=e.target,e.changedTouches&&(i=this._changedTouchisObserved(e.changedTouches))!==!1&&(r=n.touch=e.changedTouches[i]),r&&(n.clientX=r.clientX,n.clientY=r.clientY,n.pageX=r.pageX,n.pageY=r.pageY),n}},_dispatchPressStart:{enumerable:!1,value:function(t){if(this._state=PressComposer.PRESSED,this.dispatchEvent(this._createPressEvent("pressStart",t)),this._shouldDispatchLongPress){var e=this;this._longPressTimeout=setTimeout(function(){e._dispatchLongPress()},this._longPressThreshold)}}},_dispatchPress:{enumerable:!1,value:function(t){this._shouldDispatchLongPress&&(clearTimeout(this._longPressTimeout),this._longPressTimeout=null),this.dispatchEvent(this._createPressEvent("press",t)),this._state=PressComposer.UNPRESSED}},_dispatchLongPress:{enumerable:!1,value:function(t){this._shouldDispatchLongPress&&(this.dispatchEvent(this._createPressEvent("longPress",t)),this._longPressTimeout=null)}},_dispatchPressCancel:{enumerable:!1,value:function(t){this._shouldDispatchLongPress&&(clearTimeout(this._longPressTimeout),this._longPressTimeout=null),this._state=PressComposer.CANCELLED,this.dispatchEvent(this._createPressEvent("pressCancel",t))}}});PressComposer.prototype.captureMSPointerDown=PressComposer.prototype.capturePointerdown,PressComposer.prototype.handleMSPointerUp=PressComposer.prototype.handlePointerup,PressComposer.prototype.handleMSPointerCancel=PressComposer.prototype.handlePointercancel,PressComposer.prototype.handleMSPointerMove=PressComposer.prototype._handleMove,PressComposer.prototype.handlePointermove=PressComposer.prototype._handleMove,PressComposer.prototype.handleTouchmove=PressComposer.prototype._handleMove,PressComposer.prototype.handleMousemove=PressComposer.prototype._handleMove,PressComposer.prototype.handleMousewheel=PressComposer.prototype.handleWheel;var PressEvent=function(){var t,e,n,i,r,a;for(t=MutableEvent.specialize({type:{value:"press"},_event:{enumerable:!1,value:null},event:{get:function(){return this._event},set:function(t){this._event=t}},_touch:{enumerable:!1,value:null},touch:{get:function(){return this._touch},set:function(t){this._touch=t}}}),e=["altKey","ctrlKey","metaKey","shiftKey","cancelBubble","currentTarget","defaultPrevented","eventPhase","timeStamp","preventDefault","stopImmediatePropagation","stopPropagation"],n=["clientX","clientY","pageX","pageY","screenX","screenY","target"],i=function(t){return{get:function(){return this._event[t]}}},r=function(t){return{get:function(){return this._touch?this._touch[t]:this._event[t]}}},a=e.length-1;a>=0;a--)Montage.defineProperty(t,e[a],i(e[a]));for(a=n.length-1;a>=0;a--)Montage.defineProperty(t,n[a],r(n[a]));return t}();